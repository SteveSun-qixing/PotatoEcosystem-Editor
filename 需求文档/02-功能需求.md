# 卡片编辑引擎 - 功能需求

**版本**: 2.0.0  
**更新时间**: 2026-01-31  
**状态**: 正式版

---

## 1. 核心架构需求

### 1.1 微内核路由集成

**FR-001: 中心路由通信** ⭐ 最高优先级

**需求描述**:  
编辑引擎必须通过薯片微内核路由调用所有模块，不允许直接调用任何模块。

**功能要点**:
- 所有对公共基础层的调用通过微内核路由
- 所有对插件系统的调用通过微内核路由
- 所有模块间通信通过微内核事件总线
- 使用标准的薯片协议消息格式

**技术要求**:
- 集成薯片SDK（@chips/sdk）
- 实现标准的请求/响应处理
- 实现事件订阅和发布机制
- 所有调用必须是异步的

**验收标准**:
- ✅ 代码中无直接的模块导入和调用
- ✅ 所有通信通过 `Core.request()` 进行
- ✅ 所有事件通过 `Core.event.publish/subscribe` 处理
- ✅ 静态代码分析工具检查通过

---

### 1.2 公共基础层调用

**FR-002: 媒体组件集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的媒体组件。

**调用服务**:
```typescript
// 视频播放
Core.request({
  service: "foundation.video-player.create",
  payload: {
    container: elementId,
    videoPath: "path/to/video.mp4",
    options: { controls: true, autoplay: false }
  }
});

// 音频播放
Core.request({
  service: "foundation.audio-player.create",
  payload: {
    container: elementId,
    audioPath: "path/to/audio.mp3"
  }
});

// 图片显示
Core.request({
  service: "foundation.image-viewer.display",
  payload: {
    container: elementId,
    imagePath: "path/to/image.jpg",
    fitMode: "contain"
  }
});

// 3D模型渲染
Core.request({
  service: "foundation.model-3d.render",
  payload: {
    container: elementId,
    modelPath: "path/to/model.obj"
  }
});
```

**验收标准**:
- ✅ 支持所有媒体类型的播放和显示
- ✅ 通过路由调用，无直接依赖
- ✅ 错误处理完善

---

**FR-003: 文本组件集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的文本处理组件。

**调用服务**:
```typescript
// 富文本渲染
Core.request({
  service: "foundation.rich-text.render",
  payload: {
    container: elementId,
    content: rtfContent
  }
});

// Markdown解析
Core.request({
  service: "foundation.markdown.parse",
  payload: {
    markdown: mdContent,
    options: { syntaxHighlight: true, showToc: true }
  }
});

// 代码高亮
Core.request({
  service: "foundation.code-highlighter.highlight",
  payload: {
    code: codeContent,
    language: "javascript",
    theme: "github"
  }
});

// 文本编辑器创建
Core.request({
  service: "foundation.text-editor.create",
  payload: {
    container: elementId,
    initialValue: "",
    options: { lineNumbers: true, mode: "markdown" }
  }
});
```

**验收标准**:
- ✅ 支持富文本、Markdown、代码高亮等文本处理
- ✅ 通过路由调用基础层组件
- ✅ 组件参数可配置

---

**FR-004: 文件处理集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的文件处理功能。

**调用服务**:
```typescript
// 创建ZIP（保存卡片）
Core.request({
  service: "foundation.zip-processor.create",
  payload: {
    files: fileList,
    outputPath: "card.card",
    compressionLevel: 0  // 零压缩
  }
});

// 解析ZIP（读取卡片）
Core.request({
  service: "foundation.zip-processor.extract",
  payload: {
    zipPath: "card.card",
    extractPath: tempDir
  }
});

// 识别文件类型
Core.request({
  service: "foundation.file-identifier.recognize",
  payload: {
    filePath: "path/to/file"
  }
});

// 格式转换
Core.request({
  service: "foundation.format-converter.convert",
  payload: {
    inputPath: "input.png",
    outputPath: "output.jpg",
    format: "jpeg"
  }
});
```

**验收标准**:
- ✅ 完整的卡片文件创建和解析
- ✅ 支持常见文件类型识别
- ✅ 格式转换功能可用

---

**FR-004.5: 卡片渲染模块集成** ⭐ 重要

**需求描述**:  
编辑引擎在预览模式和查看模式下，通过微内核路由调用公共基础层的卡片渲染模块。

**核心原则**:
- **卡片渲染逻辑在公共基础层**（CardRenderer、BaseCardRenderers、BoxRenderer、ThemeEngine）
- **编辑引擎通过路由调用 CardRenderer**，不自己实现渲染逻辑
- **查看模式**和**预览功能**都使用 CardRenderer
- 编辑引擎负责编辑功能，渲染交给基础层

**调用服务**:
```typescript
// 预览当前正在编辑的卡片
Core.request({
  service: "foundation.card.render",
  payload: {
    card_id: currentCardId,  // 或传递卡片数据对象
    container_id: "preview-panel",
    options: {
      theme_id: "chipshub:light",
      interactive: true,
      readonly: true  // 预览模式只读
    }
  }
});

// 查看模式（锁定编辑）
Core.request({
  service: "foundation.card.render",
  payload: {
    card_id: currentCardId,
    container_id: "main-content",
    options: {
      theme_id: currentTheme,
      interactive: true,
      readonly: true
    }
  }
});

// 渲染箱子预览
Core.request({
  service: "foundation.box.render",
  payload: {
    box_id: currentBoxId,
    container_id: "box-preview",
    options: {
      theme_id: currentTheme,
      interactive: true
    }
  }
});
```

**CardRenderer 的渲染流程**（由公共基础层处理）:
1. 解析卡片文件结构（metadata.yaml、structure.yaml、content/）
2. 遍历基础卡片列表，按顺序渲染
3. 对于每个基础卡片：
   - 根据类型调用对应的 BaseCardRenderer
   - BaseCardRenderer 调用基础卡片插件的前端代码
   - 将配置数据填充到前端模板
   - 生成 iframe 窗口
4. 垂直排列所有基础卡片的 iframe
5. 添加菜单栏和卡片级主题背景
6. 返回完整的大 iframe 窗口
7. 编辑引擎将 iframe 显示在预览面板或主内容区

**编辑引擎的职责**:
- ✅ 通过路由调用 CardRenderer
- ✅ 接收渲染结果（iframe 窗口）
- ✅ 将 iframe 嵌入到界面中
- ✅ 提供编辑功能和交互控制
- ✅ 在编辑和预览模式之间切换
- ❌ 不实现卡片渲染逻辑
- ❌ 不实现基础卡片的渲染器
- ❌ 不解析卡片文件结构

**验收标准**:
- ✅ 预览模式使用 CardRenderer 渲染
- ✅ 查看模式（锁定）使用 CardRenderer 渲染
- ✅ 通过路由调用，无直接依赖
- ✅ 编辑和预览/查看模式无缝切换
- ✅ 预览效果与 Viewer 完全一致

---

**FR-005: 网络模块集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的网络功能。

**调用服务**:
```typescript
// HTTP请求
Core.request({
  service: "foundation.http-client.request",
  payload: {
    url: "https://api.example.com/data",
    method: "GET",
    headers: {},
    timeout: 10000
  }
});

// 文件下载
Core.request({
  service: "foundation.download-manager.download",
  payload: {
    url: "https://example.com/video.mp4",
    savePath: "downloads/video.mp4",
    onProgress: progressCallback
  }
});

// 缓存管理
Core.request({
  service: "foundation.cache-manager.get",
  payload: {
    key: "resource-123",
    ttl: 3600
  }
});
```

**验收标准**:
- ✅ 支持网络资源下载
- ✅ 缓存机制正常工作
- ✅ 进度反馈可用

---

**FR-006: 界面组件集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的界面功能。

**调用服务**:
```typescript
// 窗口管理
Core.request({
  service: "foundation.window-manager.create",
  payload: {
    title: "窗口标题",
    width: 800,
    height: 600,
    resizable: true
  }
});

// 拖拽处理
Core.request({
  service: "foundation.drag-drop.register-source",
  payload: {
    sourceId: "card-window-1",
    type: "card-window",
    data: cardData
  }
});

Core.request({
  service: "foundation.drag-drop.register-target",
  payload: {
    targetId: "drop-zone-1",
    accepts: ["card-window", "file-system"],
    onDrop: dropHandler
  }
});

// 网页框架创建
Core.request({
  service: "foundation.iframe-wrapper.create",
  payload: {
    container: elementId,
    url: "about:blank",
    sandbox: "allow-scripts"
  }
});
```

**验收标准**:
- ✅ 窗口创建和管理功能正常
- ✅ 拖拽系统集成完整
- ✅ 网页框架安全可用

---

**FR-007: 系统服务集成**

**需求描述**:  
编辑引擎通过微内核路由调用公共基础层的系统服务。

**调用服务**:
```typescript
// 配置管理
Core.request({
  service: "foundation.config.get",
  payload: { key: "editor.default_layout" }
});

Core.request({
  service: "foundation.config.set",
  payload: { 
    key: "editor.default_layout",
    value: "infinite-canvas",
    scope: "user"
  }
});

// 日志记录
Core.request({
  service: "foundation.log.write",
  payload: {
    level: "info",
    message: "Card opened",
    context: { cardId: "a1B2c3D4e5" }
  }
});

// 多语言翻译
Core.request({
  service: "foundation.i18n.translate",
  payload: {
    code: "i18n.editor.200001",
    vars: { count: 10 }
  }
});

// 数据序列化
Core.request({
  service: "foundation.data-serializer.parse",
  payload: {
    content: yamlString,
    format: "yaml"
  }
});
```

**验收标准**:
- ✅ 配置读写功能正常
- ✅ 日志系统集成完整
- ✅ 多语言系统可用
- ✅ 数据解析功能正常

---

### 1.3 薯片组件库使用

**FR-008: 组件库集成**

**需求描述**:  
编辑引擎使用薯片组件库（@chips/components）构建所有用户界面。

**使用的组件**:

**基础交互组件**:
- Button - 按钮组件
- Input - 输入框组件
- Select - 选择器组件
- Slider - 滑块组件
- Checkbox - 复选框组件
- Radio - 单选按钮组件
- Switch - 开关组件
- Tooltip - 工具提示组件

**布局组件**:
- Grid - 网格布局
- Flex - 弹性布局
- Container - 容器组件
- Divider - 分隔线

**数据展示组件**:
- List - 列表组件
- Tree - 树形组件
- Table - 表格组件
- Card - 卡片容器组件

**反馈组件**:
- Message - 消息提示
- Notification - 通知提醒
- Modal - 模态框
- Drawer - 抽屉
- Loading - 加载指示器

**导航组件**:
- Menu - 菜单
- Tabs - 标签页
- Breadcrumb - 面包屑

**特殊组件**:
- ThemeProvider - 主题提供者
- ChipsProvider - 内核连接提供者
- ErrorBoundary - 错误边界

**卡片渲染组件**:
- MarkdownCard - Markdown卡片渲染器
- ImageCard - 图片卡片渲染器
- VideoCard - 视频卡片渲染器
- AudioCard - 音乐卡片渲染器
- ...（共26种基础卡片渲染组件）

**验收标准**:
- ✅ 界面完全使用薯片组件库构建
- ✅ 无自定义重复的UI组件
- ✅ 遵循组件库的使用规范
- ✅ 主题系统正确集成

---

**FR-009: 主题系统支持**

**需求描述**:  
编辑引擎支持薯片主题系统，界面样式完全由主题包提供。

**功能要点**:
- 使用 ThemeProvider 提供主题上下文
- 支持全局主题设置
- 支持单个卡片的主题覆盖
- 支持主题热切换
- 主题嵌套和层级覆盖

**实现方式**:
```vue
<template>
  <ThemeProvider :theme="globalTheme">
    <div class="editor-layout">
      <!-- 全局使用主题 -->
      <Button type="primary">保存</Button>
      
      <!-- 单个卡片主题覆盖 -->
      <ThemeProvider :theme="cardTheme">
        <CardRenderer :card="card" />
      </ThemeProvider>
    </div>
  </ThemeProvider>
</template>
```

**验收标准**:
- ✅ 主题系统正确集成
- ✅ 主题切换无闪烁
- ✅ 主题嵌套正常工作
- ✅ 所有界面元素响应主题

---

## 2. 布局系统需求

### 2.1 布局切换

**FR-010: 多布局模式支持**

**需求描述**:  
用户可以在不同布局模式间切换，切换时数据保持一致。

**功能要点**:
- 支持多种布局插件并存
- 用户在设置中选择默认布局
- 提供布局切换菜单或快捷键（Ctrl/Cmd + L）
- 切换时保持所有打开的文件状态
- 数据自动保存，界面自动适配新布局
- 切换过程流畅，无闪烁

**切换流程**:
1. 用户触发布局切换（菜单/快捷键）
2. 引擎保存当前布局状态
3. 通过微内核请求卸载当前布局插件
4. 通过微内核请求加载新布局插件
5. 新布局初始化并恢复窗口状态
6. 界面过渡动画
7. 切换完成，新布局可用

**验收标准**:
- ✅ 切换时间 < 500ms
- ✅ 切换过程流畅无闪烁
- ✅ 打开的文件保持打开状态
- ✅ 窗口状态正确恢复

---

**FR-011: 布局插件加载**

**需求描述**:  
编辑引擎能够动态加载和卸载布局插件。

**功能要点**:
- 启动时通过微内核扫描已安装的布局插件
- 通过微内核加载用户设置的默认布局
- 支持热切换，无需重启应用
- 插件接口标准化
- 错误处理和回退机制

**加载流程**:
1. 引擎通过微内核请求获取已安装布局插件列表
2. 读取用户配置的默认布局ID
3. 通过微内核请求加载布局插件
4. 布局插件初始化
5. 布局插件挂载到容器
6. 布局就绪，可以使用

**错误处理**:
- 插件加载失败时回退到默认布局
- 显示错误提示
- 记录错误日志

**验收标准**:
- ✅ 布局插件动态加载成功
- ✅ 错误处理机制完善
- ✅ 回退机制正常工作

---

**FR-012: 布局通用功能**

**需求描述**:  
所有布局都必须提供的核心功能。

**必须提供的功能**:
- **卡片管理**: 创建、打开、保存、关闭、删除复合卡片
- **基础卡片编辑**: 添加、删除、调整基础卡片顺序
- **文件管理**: 浏览、导入、导出、重命名文件
- **系统功能**: 撤销、重做、搜索、设置

**实现方式**:
- 引擎提供统一的功能API（通过微内核路由）
- 布局插件调用引擎API实现功能
- 保证不同布局下功能一致性

**验收标准**:
- ✅ 所有布局提供相同的核心功能
- ✅ 功能行为一致
- ✅ 快捷键统一

---

### 2.2 无限画布布局需求

**FR-013: 两层架构实现**

**需求描述**:  
无限画布布局必须实现桌面层和窗口层的清晰分离。

**桌面层需求**:
- 无限大的二维画布空间
- 显示网格背景图案
- 支持缩放变换（0.1x - 5x）
- 支持平移变换（无限制）
- 卡片和箱子窗口放置在桌面层
- 窗口随桌面一起缩放和平移

**窗口层需求**:
- 固定在屏幕位置的透明层
- 工具窗口放置在窗口层
- 不受桌面缩放和平移影响
- 程序坞显示在窗口层
- 缩放控制器显示在窗口层

**技术要求**:
- 使用 CSS Transform 实现变换
- 正确的坐标系转换
- GPU加速渲染

**验收标准**:
- ✅ 两层清晰分离
- ✅ 窗口层固定不动
- ✅ 桌面层正确缩放和平移
- ✅ 性能达标（60fps）

---

**FR-014: 桌面缩放功能**

**需求描述**:  
用户可以通过多种方式缩放桌面。

**缩放方式**:
1. **鼠标滚轮**: 在空白区域滚动，或 Ctrl + 滚轮
2. **触摸板手势**: 双指捏合
3. **触摸屏手势**: 双指捏合
4. **缩放滑块**: 拖动右下角滑块
5. **快捷键**: Ctrl/Cmd + `+` / `-` / `0`

**缩放行为**:
- 以鼠标位置为缩放中心
- 滑块和快捷键以屏幕中心为缩放中心
- 缩放中心在屏幕上的位置保持不变
- 实时平滑缩放

**缩放范围**:
- 最小: 10% (0.1x)
- 最大: 500% (5x)
- 默认: 100% (1x)

**验收标准**:
- ✅ 所有缩放方式正常工作
- ✅ 缩放中心保持正确
- ✅ 缩放流畅无卡顿
- ✅ 缩放范围限制正确

---

**FR-015: 桌面平移功能**

**需求描述**:  
用户可以通过多种方式平移桌面。

**平移方式**:
1. **鼠标拖动**: 在空白区域按住拖动
2. **触摸板手势**: 双指滑动
3. **触摸屏手势**: 双指拖动
4. **键盘**: 方向键（可选）

**平移行为**:
- 整个桌面随手势移动
- 所有桌面层窗口保持相对位置
- 窗口层固定不动
- 无边界限制

**验收标准**:
- ✅ 所有平移方式正常工作
- ✅ 平移流畅无卡顿
- ✅ 无边界限制

---

**FR-016: 工具窗口管理**

**需求描述**:  
无限画布布局支持多个工具窗口。

**工具窗口类型**:
- 文件管理器窗口
- 编辑面板窗口
- 卡箱库窗口
- 设置窗口
- 其他辅助工具窗口

**窗口特性**:
- 悬浮在窗口层
- 可拖动改变位置
- 可调整大小
- 可收起到只显示标题栏
- 可最小化到程序坞

**窗口操作**:
- 拖动标题栏移动
- 拖动边缘调整大小
- 点击收起按钮收起窗口
- 点击最小化按钮最小化到程序坞
- 点击关闭按钮关闭窗口

**验收标准**:
- ✅ 所有工具窗口功能正常
- ✅ 窗口位置和大小可调整
- ✅ 窗口状态可保存和恢复
- ✅ 最小化和恢复正常

---

**FR-017: 程序坞功能**

**需求描述**:  
程序坞始终显示所有工具窗口图标，方便用户快速访问和管理工具窗口。

**功能要点**:
- **始终显示所有工具窗口图标**（不只是最小化的）
- 点击图标聚焦对应窗口
- 点击已最小化窗口的图标可恢复窗口
- 图标顺序可拖拽调整
- 右键显示窗口菜单

**程序坞位置**:
- 窗口层底部居中（默认）
- 或窗口层左侧/右侧
- 用户可在设置中选择位置

**外观设计**:
- 半透明白色背景，圆角设计
- 图标采用 44x44 像素触摸友好尺寸
 
 
- 悬停显示工具提示（窗口名称）

**交互行为**:
- 单击图标：聚焦/恢复窗口
- 右键图标：显示窗口菜单（关闭、最小化等）
- 拖动图标：调整图标顺序
- 悬停显示：工具提示延迟 0.5 秒显示

**验收标准**:
- ✅ 程序坞始终显示所有工具窗口
- ✅ 活动/最小化状态区分明显
- ✅ 点击图标正确聚焦/恢复窗口
- ✅ 悬停效果和提示正常显示
- ✅ 触摸友好的图标尺寸

---

**FR-018: 缩放控制器**

**需求描述**:  
提供简洁的可视化缩放控制器，支持悬停展开更多选项。

**组件结构**:

**基础控件（始终显示）**:
- 缩小按钮（-）
- 缩放滑块（范围 10%-500%）
- 放大按钮（+）

**展开控件（鼠标悬停时显示）**:
- 缩放百分比选择框（预设值：25%、50%、75%、100%、125%、150%、200%、300%）
- 重置按钮（恢复 100%）
- 适应按钮（自动适应内容）

**位置**:
- 窗口层右下角（固定）
- 不随桌面缩放/平移移动

**交互设计**:
- 平时只显示基础控件（精简模式）
- 鼠标进入控制器区域时展开更多选项
- 鼠标离开整个控制器后才隐藏展开内容
- 展开/隐藏有平滑过渡动画

**快捷键支持**:
- `Ctrl/Cmd + +`：放大
- `Ctrl/Cmd + -`：缩小
- `Ctrl/Cmd + 0`：重置视图

**验收标准**:
- ✅ 基础控件始终可用
- ✅ 悬停时正确展开更多选项
- ✅ 离开后正确隐藏展开内容
- ✅ 实时更新缩放比例
- ✅ 操作流畅无延迟
- ✅ 快捷键正常工作

---

**FR-019: 视口裁剪优化**

**需求描述**:  
无限画布布局必须实现视口裁剪，只渲染可见区域的窗口。

**功能要点**:
- 计算当前屏幕视口范围（考虑缩放和平移）
- 判断每个窗口是否在可见区域
- 只渲染可见窗口及周边缓冲区的窗口
- 超出视口的窗口不渲染或简化渲染
- 视口变化时动态更新渲染列表

**性能要求**:
- 支持 ≥100 个窗口流畅运行
- 视口裁剪计算 < 10ms
- 渲染帧率 ≥ 60fps

**验收标准**:
- ✅ 视口裁剪正确工作
- ✅ 性能指标达标
- ✅ 无可见窗口渲染延迟

---

### 2.3 工作台布局需求

**FR-020: 分区窗口布局**

**需求描述**:  
工作台布局提供传统的分区窗口界面。

**布局结构**:
- **左侧栏**: 文件管理器（树状视图）
- **中央区域**: 预览区，显示选中的卡片或箱子
- **右侧栏**: 编辑面板窗口
- **底部栏**（可选）: 工具栏或输出面板
- **顶部**: 菜单栏和工具栏

**窗格特性**:
- 所有窗格可调整大小
- 拖动分隔条调整
- 双击分隔条恢复默认大小
- 窗格可折叠
- 窗格可以创建标签页
- 窗格布局可保存和恢复

**验收标准**:
- ✅ 布局结构清晰
- ✅ 窗格调整功能正常
- ✅ 窗格折叠展开正常
- ✅ 布局保存和恢复正常

---

**FR-021: 树状文件管理器**

**需求描述**:  
工作台布局的文件管理器使用树状视图。

**功能要点**:
- 显示文件和文件夹的层级结构
- 展开/折叠文件夹
- 文件和文件夹图标
- 选中高亮
- 拖拽移动文件
- 右键上下文菜单

**操作**:
- 点击文件: 在预览区显示
- 双击文件: 打开编辑
- 点击文件夹图标: 展开/折叠
- 拖拽文件: 移动到其他文件夹
- 右键: 操作菜单

**验收标准**:
- ✅ 树状视图正确显示
- ✅ 展开折叠功能正常
- ✅ 文件操作正常
- ✅ 拖拽移动正常

---

**FR-022: 预览区功能**

**需求描述**:  
工作台布局的中央预览区显示卡片内容。

**功能要点**:
- 显示选中文件的内容
- 只读预览或可查看状态
- 点击基础卡片进入编辑（右侧编辑面板激活）
- 支持标签页，同时打开多个文件
- 标签切换和关闭

**预览模式**:
- 查看模式：只读，可以与内容交互（如播放视频）
- 编辑模式：点击基础卡片打开编辑面板

**多文档支持**:
- 标签页显示打开的文件
- 标签切换
- 标签关闭
- 标签拖拽排序

**验收标准**:
- ✅ 预览区正确显示内容
- ✅ 查看和编辑模式切换正常
- ✅ 标签页功能完整
- ✅ 性能良好

---

**FR-023: 窗格停靠功能**

**需求描述**:  
工作台布局支持窗格的拖拽停靠。

**功能要点**:
- 拖动窗格标题栏
- 显示停靠指示器（上下左右中）
- 停靠到指定位置
- 窗格可脱离成浮动窗口
- 浮动窗口可重新停靠

**停靠区域**:
- 上方：停靠到顶部
- 下方：停靠到底部
- 左侧：停靠到左侧
- 右侧：停靠到右侧
- 中央：创建标签页

**验收标准**:
- ✅ 窗格拖拽停靠正常
- ✅ 停靠指示器清晰
- ✅ 浮动窗口功能正常
- ✅ 布局调整流畅

---

## 3. 窗口管理需求

### 3.1 复合卡片窗口

**FR-024: 卡片窗口创建**

**需求描述**:  
创建和显示复合卡片窗口。

**创建触发**:
- 从卡箱库拖动到桌面空白区域
- 从文件管理器打开文件
- 从封面窗口展开
- 导入外部卡片文件
- 快捷键新建（Ctrl/Cmd + N）

**创建流程**:
1. 确定窗口类型和文件ID
2. 通过微内核读取卡片数据（card.read）
3. 通过微内核加载对应的渲染器插件
4. 创建窗口DOM结构
5. 渲染基础卡片列表
6. 在指定位置显示窗口
7. 触发 window:created 事件

**窗口结构**:
```html
<div class="chips-card-window">
  <div class="card-menubar">
    <span class="card-name">卡片名称</span>
    <div class="card-actions">
      <button class="minimize-btn">最小化</button>
      <button class="cover-btn">切换到封面</button>
      <button class="settings-btn">设置</button>
      <button class="lock-btn">锁定</button>
      <button class="collapse-btn">收起</button>
      <button class="close-btn">关闭</button>
    </div>
  </div>
  <div class="card-content">
    <!-- 基础卡片列表 -->
  </div>
</div>
```

**验收标准**:
- ✅ 窗口正确创建和显示
- ✅ 窗口结构符合规范
- ✅ 通过微内核路由加载数据和插件

---

**FR-025: 窗口操作功能**

**需求描述**:  
复合卡片窗口支持多种操作。

**菜单栏操作**:
- **卡片名称编辑**: 双击进入编辑，失去焦点自动保存
- **最小化**: 关闭窗口，不显示封面，从桌面消失
- **切换到封面**: 关闭当前窗口，创建封面窗口
- **设置**: 打开卡片设置对话框
- **锁定**: 切换编辑模式和查看模式
- **收起**: 切换展开/收起状态
- **关闭**: 关闭窗口，文件保留

**实现要求**:
- 所有操作通过微内核路由
- 操作后自动保存状态
- 提供操作反馈

**验收标准**:
- ✅ 所有菜单栏操作正常
- ✅ 编辑名称并自动保存
- ✅ 状态切换正确
- ✅ 设置对话框功能完整

---

**FR-026: 窗口显示状态**

**需求描述**:  
复合卡片窗口支持多种显示状态。

**状态类型**:
1. **展开状态**: 显示所有基础卡片完整内容，高度自适应
2. **收起状态**: 固定高度（16:9比例），内容可滚动查看
3. **封面状态**: 显示封面，固定尺寸，点击展开
4. **最小化状态**: 不在桌面显示，保留在文件列表

**状态切换**:
- 点击收起按钮：展开 ↔ 收起
- 点击封面按钮：展开 → 封面
- 点击封面窗口：封面 → 展开
- 点击最小化按钮：当前 → 最小化

**状态保存**:
- 每个卡片的显示状态独立保存
- 重新打开时恢复上次状态

**验收标准**:
- ✅ 所有状态切换正常
- ✅ 状态保存和恢复正常
- ✅ 状态动画流畅

---

**FR-027: 窗口移动和调整**

**需求描述**:  
卡片窗口可以移动和调整大小。

**移动功能**:
- 拖动窗口标题栏移动窗口
- 窗口在桌面层移动（使用世界坐标）
- 移动时显示窗口阴影
- 释放后自动保存位置

**调整大小**:
- 拖动窗口边缘调整宽度
- 拖动窗口角落同时调整宽度和高度
- 窗口有最小宽度限制
- 高度根据内容自适应或固定（收起状态）
- 调整后自动保存大小

**网格吸附**（可选）:
- 移动和调整时可吸附到网格
- 按住 Shift 禁用吸附
- 可在设置中启用/禁用

**验收标准**:
- ✅ 窗口移动流畅
- ✅ 大小调整正常
- ✅ 位置和大小正确保存
- ✅ 网格吸附功能正常（如启用）

---

**FR-028: 窗口焦点管理**

**需求描述**:  
管理窗口的焦点和堆叠顺序。

**焦点触发**:
- 点击窗口任意位置
- 从文件管理器点击文件
- 使用窗口切换快捷键（Ctrl/Cmd + Tab）

**焦点行为**:
- 将窗口置于所有窗口最前（z-index）
- 窗口边框高亮显示
- 相关工具窗口自动更新（如编辑面板）
- 触发 window:focused 事件

**堆叠顺序管理**:
- 维护窗口堆叠顺序列表
- 最近点击的窗口在最前
- 新创建的窗口在最前
- 工具窗口总在卡片窗口之上

**验收标准**:
- ✅ 焦点切换正常
- ✅ 堆叠顺序正确
- ✅ z-index 动态管理

---

### 3.2 封面窗口

**FR-029: 封面窗口显示**

**需求描述**:  
封面窗口显示卡片的自定义封面。

**功能要点**:
- 显示卡片封面（通过网页框架组件）
- 封面铺满窗口
- 下方透明底显示卡片名称
- 固定尺寸，比例可设置
- 点击封面展开为完整卡片

**封面渲染**:
- 通过微内核的 iframe-wrapper 创建网页框架
- 加载 `.card/cover.html` 文件
- 运行在安全沙箱中

**封面比例支持**:
- 正方形 (1:1)
- 书本比例 (3:4 或 4:3)
- 照片比例 (2:3 或 3:2)
- 标准照片 (3:4 或 4:3)
- 经典照片 (4:5 或 5:4)
- 纸张比例 (1:√2)
- 黄金比例 (1:1.618)
- 电影比例 (9:16 或 16:9)
- 横幅比例 (1:3 或 3:1)
- 手机比例 (9:19.5)
- 杂志比例 (8.5:11)
- 支持横竖切换

**验收标准**:
- ✅ 封面窗口正确显示
- ✅ 所有比例正确实现
- ✅ 点击展开功能正常
- ✅ 封面沙箱安全

---

**FR-030: 封面创建和编辑**

**需求描述**:  
用户可以上传和编辑卡片封面。

**创建方式**:
1. **上传网页文件**: 直接保存为 `cover.html`
2. **上传图片文件**: 图片保存到 `cardcover/` 文件夹，生成包含图片的 `cover.html`
3. **在线编辑HTML**: 提供代码编辑器编辑 HTML
4. **使用默认封面**: 系统生成默认封面，只显示卡片名称

**编辑功能**:
- 在卡片设置中访问封面编辑
- 预览封面效果
- 选择封面比例
- 切换横竖方向
- 保存并应用

**验收标准**:
- ✅ 所有创建方式正常工作
- ✅ 封面编辑功能完整
- ✅ 预览功能正常
- ✅ 保存后立即生效

---

### 3.3 箱子窗口

**FR-031: 箱子窗口渲染**

**需求描述**:  
显示箱子的布局内容。

**功能要点**:
- 通过微内核读取箱子数据（box.read）
- 通过微内核加载箱子布局插件
- 布局由箱子类型插件决定
- 支持多种箱子布局插件

**布局示例**:
- 列表布局
- 网格布局
- 瀑布流布局
- 时间线布局
- 书架布局
- 等（由箱子布局插件提供）

**验收标准**:
- ✅ 箱子窗口正确渲染
- ✅ 支持多种布局插件
- ✅ 通过微内核加载插件

---

## 4. 文件管理需求

### 4.1 文件浏览

**FR-032: 文件列表显示**

**需求描述**:  
文件管理器窗口显示所有卡片和箱子文件。

**显示内容**:
- 文件名
- 文件类型图标
- 修改时间
- 文件大小（可选）
- 标签（如果有）

**视图模式**:
- 列表视图（默认）
- 网格视图
- 树状视图（工作台布局）

**排序方式**:
- 按名称排序
- 按修改时间排序
- 按创建时间排序
- 按文件大小排序
- 自定义排序

**筛选功能**:
- 按文件类型筛选（卡片/箱子）
- 按标签筛选
- 按日期范围筛选

**验收标准**:
- ✅ 文件列表正确显示
- ✅ 所有视图模式正常
- ✅ 排序和筛选功能正常

---

**FR-033: 文件搜索**

**需求描述**:  
支持快速搜索文件。

**搜索方式**:
- 按文件名搜索
- 按内容搜索（全文检索）
- 按标签搜索
- 高级搜索（组合条件）

**搜索界面**:
- 搜索框在文件管理器顶部
- 实时显示搜索结果
- 高亮显示匹配项
- 快速跳转到结果

**快速打开**:
- 快捷键：Ctrl/Cmd + P
- 模糊搜索文件名
- 实时过滤结果
- 键盘导航选择
- 回车打开选中文件

**验收标准**:
- ✅ 搜索功能准确快速
- ✅ 全文检索正常工作
- ✅ 快速打开功能流畅
- ✅ 搜索性能良好（< 500ms）

---

### 4.2 文件操作

**FR-034: 创建文件**

**需求描述**:  
用户可以创建新的卡片或箱子文件。

**创建方式**:
- 点击创建按钮
- 使用快捷键（Ctrl/Cmd + N）
- 右键菜单选择新建
- 从卡箱库拖动到空白区域

**创建流程**:
1. 用户选择文件类型（复合卡片/箱子）
2. 通过微内核生成新的文件ID（id.generate）
3. 通过微内核创建文件（card.create 或 box.create）
4. 生成默认文件名（如"未命名卡片"）
5. 创建文件结构并保存
6. 添加到文件列表
7. 可选：自动打开新文件

**验收标准**:
- ✅ 文件创建成功
- ✅ 通过微内核路由创建
- ✅ 文件ID唯一
- ✅ 文件结构符合规范

---

**FR-035: 打开文件**

**需求描述**:  
用户可以打开已存在的卡片或箱子文件。

**打开方式**:
- 从文件管理器点击
- 拖拽文件到桌面
- 使用快速打开（Ctrl/Cmd + P）
- 从外部双击卡片文件

**打开流程**:
1. 获取文件ID或路径
2. 检查文件是否已打开
3. 如果已打开，聚焦到已有窗口
4. 如果未打开，创建新窗口
5. 通过微内核读取文件数据
6. 渲染文件内容
7. 恢复上次保存的窗口状态
8. 触发 file:opened 事件

**验收标准**:
- ✅ 文件正确打开
- ✅ 已打开文件不重复创建窗口
- ✅ 窗口状态正确恢复
- ✅ 打开时间 < 1s（中等大小卡片）

---

**FR-036: 删除文件**

**需求描述**:  
用户可以删除文件。

**删除流程**:
1. 选择要删除的文件
2. 点击删除或按删除键
3. 显示确认对话框："确定要删除 'XXX' 吗？"
4. 用户确认后通过微内核删除文件（card.delete）
5. 从文件列表移除
6. 关闭对应的窗口（如果打开）
7. 触发 file:deleted 事件

**安全机制**:
- 必须确认才能删除
- 默认移到系统回收站
- 按住 Shift 永久删除（需要二次确认）
- 记录删除日志

**批量删除**:
- 支持多选文件
- 批量删除确认
- 显示删除进度

**验收标准**:
- ✅ 删除功能正常
- ✅ 确认机制完善
- ✅ 回收站功能正常
- ✅ 批量删除正常

---

**FR-037: 重命名文件**

**需求描述**:  
用户可以重命名文件。

**操作方式**:
- 双击文件名
- 右键选择重命名
- 使用快捷键（F2）
- 选中后点击文件名

**重命名流程**:
1. 进入编辑模式
2. 输入新名称
3. 失去焦点或按回车保存
4. 通过微内核更新文件元数据（card.update）
5. 更新文件列表显示
6. 更新窗口标题（如果打开）
7. 按 ESC 取消

**验证**:
- 不允许空名称
- 不允许非法字符（< > : " / \ | ? *）
- 重名时自动添加编号
- 显示验证错误提示

**验收标准**:
- ✅ 重命名功能正常
- ✅ 验证规则正确
- ✅ 实时更新显示
- ✅ 通过微内核更新

---

**FR-038: 导入文件**

**需求描述**:  
用户可以导入外部文件。

**导入方式**:
- 从菜单选择导入
- 拖拽文件到文件管理器
- 拖拽文件到桌面区域
- 快捷键（Ctrl/Cmd + O）

**导入流程**:
1. 接收文件路径或拖拽数据
2. 通过微内核识别文件类型（file.identify）
3. 根据文件类型处理：
   - `.card` 文件：直接导入，复制到工作目录
   - 媒体文件：创建对应类型基础卡片的复合卡片
   - 文本文件：创建富文本或Markdown卡片
   - 其他类型：通过插件处理
4. 通过微内核创建卡片（card.create）
5. 添加到文件列表
6. 可选：自动打开新卡片

**批量导入**:
- 支持同时拖入多个文件
- 显示导入进度
- 并行处理文件

**验收标准**:
- ✅ 所有导入方式正常
- ✅ 文件类型正确识别
- ✅ 通过微内核路由处理
- ✅ 批量导入正常

---

**FR-039: 导出文件**

**需求描述**:  
用户可以导出卡片为不同格式。

**导出格式**:
1. **卡片文件（.card）**: 完整的卡片数据包
2. **网页文件（.html + 资源）**: 可在浏览器中打开
3. **图片文件（.png/.jpg）**: 渲染为长图
4. **PDF文件**: 适合打印和分享
5. **Markdown文件**: 纯文本格式

**导出流程**:
1. 选择要导出的文件
2. 点击导出按钮或菜单
3. 选择导出格式
4. 设置导出选项（资源模式、质量等）
5. 选择保存位置
6. 通过微内核执行导出（card.export）
7. 显示导出进度
8. 导出完成提示

**导出选项**:
- **全填充**: 导出包含所有资源
- **空壳**: 只导出配置，资源使用外部链接
- **包含嵌套**: 是否包含嵌套的卡片

**验收标准**:
- ✅ 所有导出格式正常
- ✅ 导出选项正确应用
- ✅ 通过微内核路由执行
- ✅ 导出进度反馈清晰

---

### 4.3 文件组织

**FR-040: 文件夹管理**（可选功能）

**需求描述**:  
支持文件夹组织文件。

**功能**:
- 创建文件夹
- 移动文件到文件夹
- 文件夹嵌套
- 折叠/展开文件夹
- 重命名文件夹
- 删除文件夹

**实现方式**:
- 文件夹作为虚拟概念或实际目录
- 通过标签系统实现（推荐）
- 或使用文件系统目录结构

**验收标准**:
- ✅ 文件夹功能正常
- ✅ 文件移动不丢失
- ✅ 嵌套层级无限制

---

**FR-041: 标签系统**（可选功能）

**需求描述**:  
为文件添加标签以便组织和筛选。

**功能**:
- 创建标签
- 为文件添加多个标签
- 按标签筛选文件
- 标签管理（重命名、删除、合并）
- 标签自动建议

**标签类型**:
- 简单标签：如"旅行"、"工作"
- 结构化标签：如 ["地点", "日本"]、["项目", "网站改版"]

**实现方式**:
- 通过微内核的标签系统（tag.add、tag.query）
- 标签保存在卡片元数据中
- 标签索引由内核维护

**验收标准**:
- ✅ 标签添加和删除正常
- ✅ 标签筛选准确
- ✅ 标签建议智能
- ✅ 通过微内核路由处理

---

## 5. 编辑功能需求

### 5.1 编辑面板系统

**FR-042: 编辑面板容器**

**需求描述**:  
编辑面板提供插件挂载容器。

**定位**:
- 无限画布布局：窗口层右侧固定
- 工作台布局：右侧分区窗口

**职责**:
- 提供挂载点给编辑组件插件
- 管理插件的加载和卸载
- 处理插件与数据的交互
- 不提供具体编辑界面

**验收标准**:
- ✅ 编辑面板位置正确
- ✅ 插件挂载功能正常
- ✅ 插件切换流畅

---

**FR-043: 编辑组件插件加载**

**需求描述**:  
根据选中的基础卡片类型加载对应的编辑组件插件。

**加载触发**:
- 用户点击复合卡片中的基础卡片（编辑模式下）
- 用户选中基础卡片

**加载流程**:
1. 确定被选中的基础卡片类型
2. 通过微内核获取对应的编辑组件插件（plugin.info）
3. 通过微内核加载插件代码（plugin.load）
4. 将插件挂载到编辑面板容器
5. 传递卡片数据给插件
6. 显示编辑面板
7. 触发 editor:loaded 事件

**卸载流程**:
1. 用户选中其他基础卡片或关闭编辑面板
2. 保存当前编辑状态
3. 卸载当前插件
4. 清理插件占用的资源
5. 触发 editor:unloaded 事件

**验收标准**:
- ✅ 插件加载时间 < 300ms
- ✅ 插件切换流畅
- ✅ 资源正确释放
- ✅ 通过微内核路由加载

---

**FR-044: 编辑数据同步**

**需求描述**:  
编辑组件的数据修改实时同步到卡片文件。

**数据流**:
1. 用户在编辑组件中修改数据
2. 编辑组件调用引擎API通知数据变化
3. 引擎接收变化事件
4. 更新内存中的卡片数据
5. 标记为脏数据，触发防抖保存
6. 通过微内核保存到文件（card.update）
7. 通知渲染器更新显示

**引擎提供给插件的API**:
```typescript
interface EditorAPI {
  // 更新数据
  updateData(newData: any): void;
  
  // 获取资源
  getResource(path: string): Promise<Resource>;
  
  // 上传资源
  uploadResource(file: File): Promise<string>;
  
  // 显示通知
  notify(message: string, type: 'info' | 'success' | 'warning' | 'error'): void;
  
  // 调用内核
  callKernel(service: string, payload: any): Promise<any>;
}
```

**验收标准**:
- ✅ 数据修改实时同步
- ✅ 渲染器实时更新
- ✅ API功能完整
- ✅ 所有操作通过微内核

---

**FR-045: 编辑面板界面**

**需求描述**:  
编辑面板的外观和布局。

**结构**:
- **标题栏**: 显示当前编辑的卡片类型名称
- **内容区**: 插件渲染区域，高度自适应
- **底部工具栏**（可选）: 保存、重置、关闭按钮

**特征**:
- 固定宽度或可调整宽度
- 高度占满屏幕或工作区
- 可折叠或隐藏
- 使用薯片组件库构建

**验收标准**:
- ✅ 面板布局美观
- ✅ 大小调整正常
- ✅ 折叠展开正常
- ✅ 使用组件库构建

---

### 5.2 基础卡片操作

**FR-046: 添加基础卡片**

**需求描述**:  
用户可以向复合卡片中添加基础卡片。

**添加方式**:
- 从卡箱库拖动基础卡片类型到卡片窗口
- 从文件系统拖入文件到卡片窗口
- 右键菜单选择"添加卡片"
- 快捷键（可配置）

**添加流程**:
1. 确定基础卡片类型和插入位置
2. 通过微内核生成基础卡片ID（id.generate）
3. 通过微内核添加基础卡片（card.add_base_card）
4. 创建基础卡片配置文件
5. 更新复合卡片结构
6. 渲染新基础卡片
7. 自动保存
8. 触发 base-card:added 事件

**插入位置**:
- 鼠标在基础卡片上方区域：插入到上方
- 鼠标在基础卡片下方区域：插入到下方
- 显示插入指示线

**验收标准**:
- ✅ 添加功能正常
- ✅ 插入位置准确
- ✅ 通过微内核路由添加
- ✅ 实时渲染新卡片

---

**FR-047: 删除基础卡片**

**需求描述**:  
用户可以删除复合卡片中的基础卡片。

**操作方式**:
- 选中基础卡片，按删除键
- 右键菜单选择删除
- 编辑面板中的删除按钮

**删除流程**:
1. 选中要删除的基础卡片
2. 显示确认对话框
3. 确认后通过微内核删除（card.remove_base_card）
4. 从复合卡片结构中移除
5. 删除对应的配置文件
6. 更新渲染
7. 自动保存
8. 触发 base-card:removed 事件

**验收标准**:
- ✅ 删除功能正常
- ✅ 确认机制完善
- ✅ 通过微内核路由删除
- ✅ 界面正确更新

---

**FR-048: 调整基础卡片顺序**

**需求描述**:  
用户可以拖动调整基础卡片的顺序。

**前提条件**:
- 卡片处于编辑模式

**操作流程**:
1. 鼠标在基础卡片上显示拖动手柄
2. 按住手柄或整个卡片拖动
3. 其他基础卡片自动调整位置让出空间
4. 蓝色插入指示线显示插入位置
5. 释放鼠标，基础卡片移动到新位置
6. 通过微内核更新结构（card.update）
7. 自动保存新顺序
8. 触发 base-card:reordered 事件

**视觉反馈**:
- 被拖动卡片显示阴影
- 其他卡片平滑移动
- 插入线清晰显示
- 拖动流畅跟手

**验收标准**:
- ✅ 拖动调整顺序正常
- ✅ 视觉反馈清晰
- ✅ 通过微内核更新
- ✅ 自动保存生效

---

**FR-049: 编辑模式切换**

**需求描述**:  
卡片支持编辑模式和查看模式切换。

**模式区别**:
- **编辑模式**: 点击基础卡片打开编辑面板，可以调整顺序、删除卡片
- **查看模式**: 可以与卡片内容正常交互，如播放视频、点击链接

**切换方式**:
- 点击锁定按钮
- 使用快捷键（Ctrl/Cmd + E）
- 右键菜单选择

**验收标准**:
- ✅ 模式切换正常
- ✅ 两种模式行为正确
- ✅ 切换状态保存

---

## 6. 拖拽系统需求

### 6.1 拖拽场景

**FR-050: 从卡箱库拖动**

**需求描述**:  
用户可以从卡箱库拖动基础卡片类型或箱子类型。

**拖动目标**:

**拖到桌面空白区域**:
- 创建新的复合卡片或箱子
- 拖动的类型自动添加进去
- 在鼠标释放位置创建窗口

**拖到已有卡片窗口**:
- 添加到该卡片中
- 根据鼠标位置决定插入位置
- 显示插入指示线

**拖到已有箱子窗口**:
- 创建新卡片并添加到箱子
- 根据箱子布局决定添加方式

**视觉反馈**:
- 拖动时图标跟随鼠标
- 显示半透明预览
- 有效区域高亮显示
- 插入位置显示指示线
- 无效区域显示禁止符号

**验收标准**:
- ✅ 所有拖动目标正常
- ✅ 视觉反馈清晰
- ✅ 创建和添加功能正常
- ✅ 通过微内核路由处理

---

**FR-051: 从文件系统拖入**

**需求描述**:  
用户可以从操作系统文件管理器拖动文件到编辑引擎。

**全局支持**:
- 编辑引擎任意位置都可接收文件拖拽
- 系统自动识别文件类型
- 根据拖放位置执行不同操作

**识别流程**:
1. 接收拖入的文件路径
2. 通过微内核调用文件识别（file.identify）
3. 确定文件类型和处理方式
4. 通过微内核路由到对应的处理插件

**拖放目标**:

**拖到桌面空白区域**:
- 创建对应类型的基础卡片的复合卡片
- 文件作为卡片内容
- 在释放位置创建窗口

**拖到已有卡片窗口**:
- 创建基础卡片并添加到该卡片
- 插入到指定位置

**拖到编辑面板**:
- 添加到当前正在编辑的基础卡片
- 具体处理由编辑组件插件决定

**支持的文件类型**:
- 视频文件（.mp4, .avi, .mov等）→ 创建视频卡片
- 音频文件（.mp3, .wav, .flac等）→ 创建音乐卡片
- 图片文件（.png, .jpg, .gif等）→ 创建图片卡片
- 文本文件（.txt, .md, .rtf等）→ 创建文本卡片
- 卡片文件（.card）→ 嵌套到目标卡片
- 箱子文件（.box）→ 打开箱子
- 其他文件 → 由插件决定处理方式

**验收标准**:
- ✅ 文件拖拽全局支持
- ✅ 文件类型正确识别
- ✅ 所有拖放目标正常
- ✅ 批量拖入正常
- ✅ 通过微内核路由处理

---

**FR-052: 卡片间拖拽**

**需求描述**:  
用户可以在卡片间拖拽嵌套。

**拖动复合卡片到复合卡片**:
- 被拖动的卡片作为整体嵌套进目标卡片
- 保持完整的卡片结构
- 成为目标卡片的一个基础卡片项（类型为嵌套卡片）

**操作流程**:
1. 拖动卡片窗口标题栏或使用特殊拖动手柄
2. 移动到目标卡片窗口
3. 目标卡片高亮边框
4. 显示"嵌套到此卡片"提示
5. 释放鼠标
6. 通过微内核执行嵌套操作
7. 被拖动卡片的窗口关闭
8. 在目标卡片中显示为嵌套卡片
9. 自动保存

**修饰键**:
- 无修饰键：移动（嵌套后原卡片删除）
- Ctrl/Cmd：复制（嵌套后原卡片保留）

**验收标准**:
- ✅ 嵌套功能正常
- ✅ 卡片结构保持完整
- ✅ 修饰键正确处理
- ✅ 通过微内核路由处理

---

**FR-053: 拖拽优先级判断**

**需求描述**:  
系统正确判断不同拖拽操作的意图。

**判断依据**:
1. **拖动起点**: 标题栏、内容区、边缘、空白区域
2. **拖动距离**: 避免误触（最小5像素）
3. **修饰键**: Ctrl/Cmd（复制）、Shift（特殊）、Alt（备选）
4. **目标区域**: 空白、窗口、编辑面板

**拖动场景**:
- 标题栏拖动 → 移动窗口
- 窗口边缘拖动 → 调整大小
- 基础卡片拖动 → 调整顺序
- 空白区域拖动 → 平移桌面
- 卡箱库拖动 → 创建新内容
- 文件拖入 → 导入文件

**验收标准**:
- ✅ 拖拽意图判断准确
- ✅ 无误触发
- ✅ 修饰键正确处理

---

**FR-054: 拖拽视觉反馈**

**需求描述**:  
拖拽操作必须有清晰的视觉反馈。

**跟随鼠标的元素**:
- 半透明的被拖动对象预览
- 或简化的图标表示
- 显示数量（如拖动多个文件时）

**鼠标指针变化**:
- 可拖动：手型指针 🖐
- 拖动中：抓手指针 ✊
- 可放置：正常指针
- 禁止放置：禁止符号 🚫

**目标区域反馈**:
- 有效区域：高亮边框、背景颜色变化
- 插入位置：蓝色指示线（3px粗）
- 无效区域：鼠标禁止符号、无高亮

**动画效果**:
- 拖起时轻微放大（scale 1.05）
- 放下时恢复原大小
- 插入时平滑移动动画
- 过渡时长 200-300ms

**验收标准**:
- ✅ 视觉反馈清晰明确
- ✅ 指示线位置准确
- ✅ 动画流畅
- ✅ 性能良好

---

**FR-055: 跨平台拖拽适配**

**需求描述**:  
拖拽系统支持鼠标、触摸板、触摸屏等多种输入设备。

**鼠标操作**:
- 标准拖拽：按下左键、移动、释放
- 多选拖拽：Ctrl/Cmd 多选后拖动

**触摸板操作**:
- 单指拖动：等同于鼠标拖动
- 双指滑动：滚动或平移桌面
- 双指捏合：缩放桌面

**触摸屏操作**:
- 长按后拖动：拖拽元素
- 单指滑动：滚动
- 双指捏合：缩放
- 双指拖动：平移桌面

**自动设备检测**:
- 检测输入设备类型
- 自动调整交互方式
- 统一的交互体验

**验收标准**:
- ✅ 所有输入设备支持
- ✅ 设备检测准确
- ✅ 体验一致

---

## 7. 实时保存需求

### 7.1 自动保存机制

**FR-056: 实时保存触发**

**需求描述**:  
用户操作自动触发保存，无需手动操作。

**保存触发时机**:
- 修改卡片名称，失去焦点时
- 编辑组件修改数据时
- 拖动调整顺序完成时
- 添加或删除基础卡片时
- 移动或调整窗口后
- 切换显示状态时
- 修改卡片设置时

**保存流程**:
1. 用户操作修改数据
2. 触发数据变化事件
3. 保存管理器标记为脏数据
4. 防抖延迟（500ms - 1s）
5. 防抖期满，执行保存
6. 通过微内核保存数据（card.update）
7. 保存成功后更新状态
8. 触发 file:saved 事件

**验收标准**:
- ✅ 所有修改自动保存
- ✅ 防抖延迟合理
- ✅ 保存不阻塞操作
- ✅ 通过微内核路由保存

---

**FR-057: 防抖动保存**

**需求描述**:  
使用防抖动机制避免频繁写文件。

**策略**:
- 用户停止操作后才写入文件
- 不同操作使用不同的防抖延迟
- 在防抖期间显示"未保存"状态（可选）

**防抖延迟配置**:
```typescript
const DEBOUNCE_DELAY = {
  TEXT_INPUT: 500,        // 文本输入：500ms
  WINDOW_MOVE: 300,       // 窗口移动：300ms
  WINDOW_RESIZE: 300,     // 窗口调整：300ms
  CARD_EDIT: 1000,        // 卡片编辑：1s
  REORDER: 500,           // 顺序调整：500ms
};
```

**紧急保存**:
- 应用退出时立即保存所有脏数据
- 切换文件时立即保存当前文件
- 用户主动保存时（Ctrl/Cmd + S）立即保存

**验收标准**:
- ✅ 防抖功能正常
- ✅ 延迟配置合理
- ✅ 紧急保存可靠
- ✅ 无数据丢失

---

**FR-058: 数据同步机制**

**需求描述**:  
保持内存、文件、界面三者的数据同步。

**三层同步**:
1. **界面 ↔ 内存**: 用户操作修改内存中的数据，内存变化触发界面更新
2. **内存 ↔ 文件**: 内存脏数据触发文件保存，文件变化加载到内存
3. **文件 ↔ 界面**: 文件变化通知界面更新

**同步流程**:
```
用户编辑
  ↓
内存数据更新
  ↓
标记为脏数据
  ↓
触发界面更新（实时）
  ↓
防抖延迟
  ↓
保存到文件（通过微内核）
  ↓
保存成功，清除脏标记
```

**冲突处理**:
- 检测文件是否被外部修改
- 对比文件修改时间
- 冲突时提示用户选择：保留哪个版本、合并、查看差异

**验收标准**:
- ✅ 三层同步正确
- ✅ 实时反馈及时
- ✅ 冲突检测准确
- ✅ 冲突解决机制完善

---

**FR-059: 撤销/重做功能**

**需求描述**:  
支持多步撤销和重做操作。

**实现方式**:
- 使用命令模式
- 维护操作历史栈
- 每个操作实现 execute、undo、redo 方法

**支持的操作**:
- 添加/删除基础卡片
- 修改基础卡片数据
- 调整基础卡片顺序
- 修改卡片名称
- 修改卡片设置

**快捷键**:
- 撤销：Ctrl/Cmd + Z
- 重做：Ctrl/Cmd + Shift + Z 或 Ctrl/Cmd + Y

**历史栈限制**:
- 最大历史记录数（如100步）
- 超过限制时移除最旧的记录

**持久化**（可选）:
- 历史记录可持久化到文件
- 重启后仍可撤销

**验收标准**:
- ✅ 撤销功能正常
- ✅ 重做功能正常
- ✅ 历史栈管理正确
- ✅ 快捷键响应

---

## 8. 卡箱库需求

### 8.1 卡箱库窗口

**FR-060: 卡箱库界面**

**需求描述**:  
卡箱库窗口显示所有可用的基础卡片类型和箱子类型。

**显示内容**:
- 各种基础卡片类型
- 各种箱子布局类型
- 以图标或卡片形式展示

**布局方式**:
- 网格布局（默认）
- 分类折叠面板
- 搜索框

**每项显示**:
- 类型图标
- 类型名称
- 简短描述
- 插件来源（如果是第三方插件）

**验收标准**:
- ✅ 卡箱库界面美观
- ✅ 所有类型正确显示
- ✅ 使用薯片组件库构建

---

**FR-061: 卡片类型分类**

**需求描述**:  
卡箱库中的基础卡片类型按分类组织。

**分类**（参考）:
- 文本类：富文本、Markdown、代码块
- 媒体类：图片、视频、音乐、3D模型
- 数据类：列表、表格、打分
- 图表类：日历、一天、甘特图、热力图
- 创意类：无限画布、思维导图
- 地理类：地图
- 内容类：剧集、图文、帖子
- 交互类：游戏、应用
- 信息类：名片、商品、设备
- 其他类：网页、聊天记录

**显示方式**:
- 折叠面板：每个分类一个面板
- 标签页：每个分类一个标签
- 或网格视图+分类筛选

**验收标准**:
- ✅ 分类组织清晰
- ✅ 折叠展开功能正常
- ✅ 分类可配置

---

**FR-062: 搜索和筛选**

**需求描述**:  
卡箱库支持搜索和筛选功能。

**搜索功能**:
- 按名称搜索
- 按标签搜索
- 按描述搜索
- 实时过滤结果

**筛选功能**:
- 按分类筛选
- 仅显示已安装插件
- 仅显示常用类型
- 仅显示收藏类型

**快捷访问**:
- 常用类型置顶
- 最近使用记录
- 收藏功能

**验收标准**:
- ✅ 搜索功能准确
- ✅ 筛选功能正常
- ✅ 快捷访问方便

---

**FR-063: 拖拽创建**

**需求描述**:  
从卡箱库拖拽图标创建新内容。

**操作流程**:
1. 找到想要的卡片或箱子类型
2. 按住并拖动图标
3. 图标跟随鼠标，显示半透明预览
4. 拖到目标位置
5. 目标区域高亮，显示提示
6. 释放鼠标创建

**反馈**:
- 拖动时图标跟随鼠标
- 目标区域高亮
- 显示创建预览
- 插入位置显示指示线

**验收标准**:
- ✅ 拖拽创建功能正常
- ✅ 视觉反馈清晰
- ✅ 创建位置准确

---

## 9. 系统功能需求

### 9.1 设置面板

**FR-064: 全局设置**

**需求描述**:  
提供全局设置面板。

**设置项**:
- **默认布局**: 选择启动时使用的布局
- **主题**: 选择全局主题包
- **语言**: 选择界面语言
- **自动保存间隔**: 设置防抖延迟
- **快捷键**: 自定义快捷键绑定
- **性能**: 渲染优化选项
- **文件**: 默认保存位置、自动备份

**实现方式**:
- 使用薯片组件库构建设置界面
- 通过微内核读写配置（config.get/set）
- 配置变化实时生效

**验收标准**:
- ✅ 设置界面美观易用
- ✅ 所有设置项正常工作
- ✅ 通过微内核路由配置
- ✅ 配置持久化正确

---

**FR-065: 卡片设置**

**需求描述**:  
提供单个卡片的设置对话框。

**设置项**:
- **卡片名称**: 修改卡片名称
- **主题包**: 选择卡片专属主题
- **封面**: 上传和编辑封面
- **封面比例**: 选择封面比例和方向
- **标签**: 添加和管理标签
- **导出**: 导出卡片选项
- **元数据**: 查看和编辑元数据

**实现方式**:
- 使用薯片组件库构建设置对话框
- 通过微内核读写卡片数据
- 修改后立即保存

**验收标准**:
- ✅ 设置对话框功能完整
- ✅ 所有设置项正常
- ✅ 实时保存生效
- ✅ 使用组件库构建

---

### 9.2 快捷键系统

**FR-066: 快捷键支持**

**需求描述**:  
提供完整的快捷键系统。

**必须支持的快捷键**:

**文件操作**:
- Ctrl/Cmd + N：创建新卡片
- Ctrl/Cmd + O：打开文件
- Ctrl/Cmd + S：手动保存
- Ctrl/Cmd + W：关闭当前窗口
- Ctrl/Cmd + Q：退出应用

**编辑操作**:
- Ctrl/Cmd + Z：撤销
- Ctrl/Cmd + Shift + Z：重做
- Ctrl/Cmd + C：复制
- Ctrl/Cmd + X：剪切
- Ctrl/Cmd + V：粘贴
- Ctrl/Cmd + A：全选

**视图操作**:
- Ctrl/Cmd + L：切换布局
- Ctrl/Cmd + =：放大桌面
- Ctrl/Cmd + -：缩小桌面
- Ctrl/Cmd + 0：重置缩放
- F11：全屏

**搜索和导航**:
- Ctrl/Cmd + F：搜索
- Ctrl/Cmd + P：快速打开文件
- Ctrl/Cmd + Tab：切换窗口

**系统**:
- Ctrl/Cmd + ,：打开设置
- F1：打开帮助

**自定义绑定**:
- 用户可在设置中修改快捷键
- 避免冲突检测
- 恢复默认快捷键

**验收标准**:
- ✅ 所有快捷键正常响应
- ✅ 自定义绑定功能正常
- ✅ 冲突检测准确
- ✅ 跨平台快捷键正确（Ctrl vs Cmd）

---

### 9.3 通知系统

**FR-067: 消息通知**

**需求描述**:  
提供多种形式的消息通知。

**通知类型**:
- **信息提示**（Info）: 一般操作反馈
- **成功提示**（Success）: 操作成功
- **警告提示**（Warning）: 需要注意的情况
- **错误提示**（Error）: 操作失败

**显示方式**:
- **Toast消息**: 右上角，自动消失（3-5秒）
- **对话框**: 需要用户确认时
- **状态栏**: 持续的状态提示
- **内联提示**: 表单验证错误

**实现方式**:
- 使用薯片组件库的 Message 和 Notification 组件
- 通过事件总线触发通知
- 通知配置可自定义

**验收标准**:
- ✅ 所有通知类型正常
- ✅ 显示方式合适
- ✅ 自动消失时间合理
- ✅ 使用组件库构建

---

### 9.4 帮助系统

**FR-068: 帮助文档**

**需求描述**:  
提供用户帮助和文档。

**帮助内容**:
- 用户手册
- 快捷键列表
- 插件开发文档
- 常见问题解答（FAQ）
- 版本更新日志
- 视频教程（可选）

**访问方式**:
- 帮助菜单
- F1 快捷键
- 在线文档链接
- 应用内引导

**搜索功能**:
- 搜索帮助文档
- 快速定位相关内容

**验收标准**:
- ✅ 帮助文档完整
- ✅ 访问方式便捷
- ✅ 搜索功能准确

---

## 10. 性能需求

### 10.1 响应速度

**FR-069: 性能指标**

**需求描述**:  
系统必须满足性能指标要求。

**强制性能指标**:
- **UI响应时间**: < 100ms
- **文件打开时间**: < 1s（中等大小卡片，<10MB）
- **布局切换时间**: < 500ms
- **拖拽帧率**: ≥ 60fps
- **缩放和平移**: ≥ 60fps
- **窗口动画**: ≥ 60fps
- **微内核路由延迟**: < 10ms (P95)

**性能测试**:
- 自动化性能测试
- 性能监控和报警
- 性能回归测试

**验收标准**:
- ✅ 所有性能指标达标
- ✅ 性能测试通过
- ✅ 无性能回归

---

### 10.2 资源管理

**FR-070: 内存管理**

**需求描述**:  
合理管理内存占用。

**要求**:
- 关闭窗口时释放资源
- 卸载插件时清理内存
- 使用 WeakMap 存储缓存
- 避免内存泄漏
- 定期触发垃圾回收（在适当时机）

**内存限制**:
- 编辑引擎基础占用：< 200MB
- 每个卡片窗口：< 50MB（平均）
- 总内存占用：随卡片数量线性增长，保持合理

**监控**:
- 监控内存使用情况
- 警告内存占用过高
- 建议关闭不需要的窗口

**验收标准**:
- ✅ 内存占用合理
- ✅ 无内存泄漏
- ✅ 资源正确释放

---

**FR-071: 渲染优化**

**需求描述**:  
优化渲染性能，支持大量窗口。

**优化策略**:
- **视口裁剪**: 只渲染可见区域的窗口
- **LOD**: 缩放小时简化窗口渲染
- **虚拟化**: 长列表使用虚拟滚动
- **懒加载**: 按需加载内容和资源
- **缓存**: 缓存渲染结果

**目标**:
- 支持 ≥100 个窗口流畅运行
- 无限画布缩放和平移 60fps
- 长列表滚动流畅

**验收标准**:
- ✅ 100个窗口流畅运行
- ✅ 所有动画60fps
- ✅ 无卡顿现象

---

## 11. 兼容性需求

### 11.1 操作系统

**FR-072: 跨平台支持**

**需求描述**:  
支持主流操作系统。

**支持的系统**:
- macOS 10.14+
- Windows 10+
- Linux（主流发行版：Ubuntu、Fedora、Arch等）

**平台适配**:
- 快捷键适配（Ctrl vs Cmd）
- 文件路径处理
- 系统原生功能集成
- UI风格适配（可选）

**验收标准**:
- ✅ 所有平台正常运行
- ✅ 功能一致性
- ✅ 性能一致性

---

### 11.2 输入设备

**FR-073: 输入设备支持**

**需求描述**:  
支持多种输入设备。

**支持的设备**:
- 鼠标
- 触摸板
- 触摸屏
- 键盘
- 手写笔（可选）

**自动检测**:
- 检测设备类型
- 自动调整交互方式
- 无需用户手动切换

**验收标准**:
- ✅ 所有设备支持
- ✅ 自动检测准确
- ✅ 体验一致

---

### 11.3 屏幕尺寸

**FR-074: 响应式布局**

**需求描述**:  
适配不同屏幕尺寸。

**支持的尺寸**:
- 最小分辨率：1280x720
- 推荐分辨率：1920x1080
- 支持高分辨率：2K、4K

**响应式策略**:
- 大屏幕（>1920px）：充分利用空间，可能并排显示更多工具窗口
- 中等屏幕（1280-1920px）：标准布局
- 小屏幕（<1280px）：紧凑布局，可能隐藏次要元素

**验收标准**:
- ✅ 所有尺寸正常显示
- ✅ 布局自动调整
- ✅ 最小尺寸可用

---

## 12. 安全性需求

### 12.1 插件安全

**FR-075: 插件沙箱**

**需求描述**:  
插件运行在隔离环境中。

**隔离机制**:
- 插件不能直接访问文件系统
- 插件不能直接访问网络
- 插件不能直接调用其他插件
- 所有操作通过引擎API（通过微内核转发）

**权限管理**:
- 插件声明所需权限
- 用户审批权限
- 运行时权限检查（由微内核执行）
- 权限变更需重新授权

**验收标准**:
- ✅ 插件隔离机制正常
- ✅ 权限管理完善
- ✅ 恶意插件无法破坏系统

---

### 12.2 数据安全

**FR-076: 输入验证**

**需求描述**:  
所有用户输入必须验证。

**验证内容**:
- 文件名：不允许非法字符
- 路径：防止路径遍历攻击
- 卡片ID：验证格式（10位62进制）
- 配置数据：验证Schema

**验证方式**:
- 前端验证（即时反馈）
- 后端验证（通过微内核，安全保证）
- 使用白名单而非黑名单

**验收标准**:
- ✅ 所有输入验证正常
- ✅ 无安全漏洞
- ✅ 验证错误提示友好

---

**FR-077: 内容安全**

**需求描述**:  
防止恶意内容攻击。

**防护措施**:
- **XSS防护**: HTML内容转义，或使用安全的渲染方式
- **封面沙箱**: 封面HTML运行在iframe沙箱
- **CSP策略**: 配置内容安全策略
- **资源验证**: 验证资源来源和类型

**验收标准**:
- ✅ XSS攻击无法成功
- ✅ 封面沙箱安全
- ✅ 恶意脚本无法执行

---

## 13. 错误处理需求

### 13.1 错误类型

**FR-078: 错误分类和处理**

**需求描述**:  
完善的错误处理机制。

**错误类型**:
- **用户错误**: 输入无效、操作冲突
- **系统错误**: 文件读写失败、插件加载失败
- **网络错误**: 资源下载失败、连接超时
- **资源错误**: 文件不存在、权限不足

**处理策略**:
- 用户错误：友好提示，提供修复建议
- 系统错误：记录日志，尝试恢复，显示错误信息
- 网络错误：提供重试选项，显示错误原因
- 资源错误：显示占位符，提供重新绑定选项

**错误提示**:
- 清晰说明发生了什么
- 说明为什么发生
- 提供如何解决的建议
- 提供相关操作按钮

**验收标准**:
- ✅ 所有错误正确捕获
- ✅ 错误提示友好
- ✅ 错误日志完整
- ✅ 恢复机制有效

---

### 13.2 容错机制

**FR-079: 文件损坏恢复**

**需求描述**:  
尝试恢复损坏的卡片文件。

**恢复流程**:
1. 检测文件损坏
2. 提示用户："文件可能已损坏，是否尝试恢复？"
3. 用户确认后尝试恢复
4. 解析可用的部分
5. 创建恢复文件
6. 提示恢复情况
7. 让用户确认是否使用恢复文件

**恢复策略**:
- 尝试解析损坏的ZIP
- 提取可读的配置文件
- 提取可用的资源文件
- 重建卡片结构

**验收标准**:
- ✅ 损坏检测准确
- ✅ 恢复机制有效
- ✅ 用户选择权保留

---

**FR-080: 插件加载失败处理**

**需求描述**:  
处理插件加载失败的情况。

**失败场景**:
- 插件文件不存在
- 插件版本不兼容
- 插件代码错误
- 插件依赖缺失

**处理方式**:
- 显示占位符或错误提示
- 提供安装插件选项
- 提供使用替代插件选项
- 提供删除此卡片选项
- 记录错误日志

**回退机制**:
- 使用默认插件（如果有）
- 或显示原始配置数据
- 保证卡片仍可打开

**验收标准**:
- ✅ 失败处理机制完善
- ✅ 提示清晰友好
- ✅ 回退机制有效
- ✅ 日志记录完整

---

## 14. 可访问性需求

### 14.1 键盘访问

**FR-081: 完整的键盘支持**

**需求描述**:  
所有功能都可通过键盘访问。

**要求**:
- Tab键在可交互元素间移动焦点
- 焦点元素有清晰的视觉指示
- Enter键激活按钮和确认操作
- ESC键取消操作和关闭对话框
- 方向键在列表和菜单中导航
- 完整的快捷键支持

**验收标准**:
- ✅ 所有功能可通过键盘访问
- ✅ 焦点顺序合理
- ✅ 焦点指示清晰

---

### 14.2 屏幕阅读器

**FR-082: 屏幕阅读器支持**

**需求描述**:  
支持屏幕阅读器访问。

**要求**:
- 使用语义化HTML
- 提供ARIA属性标注
- 图片提供alt文字
- 动态内容提供aria-live通知
- 表单元素有label关联

**验收标准**:
- ✅ 屏幕阅读器可以朗读所有内容
- ✅ 操作可以通过屏幕阅读器完成
- ✅ ARIA属性正确

---

### 14.3 视觉辅助

**FR-083: 视觉辅助功能**

**需求描述**:  
提供视觉辅助选项。

**功能**:
- 足够的颜色对比度
- 不仅依赖颜色传达信息（使用图标、文字）
- 可调整的字体大小
- 高对比度模式
- 减少动画选项（尊重系统设置）

**验收标准**:
- ✅ 对比度达标
- ✅ 信息不依赖颜色
- ✅ 辅助功能可用

---

## 15. 文件系统服务需求

### 15.1 文件读写抽象

**FR-084: FileSystemService 文件读写抽象**

**需求描述**:  
提供统一的文件系统操作抽象层，封装底层文件操作，支持多种存储后端。

**功能要点**:
- 提供统一的文件读写接口
- 支持文本文件和二进制文件操作
- 支持同步和异步操作模式
- 抽象底层文件系统差异（本地/远程/云存储）
- 提供文件操作的错误处理和重试机制

**技术要求**:
- 实现 IFileSystemService 接口
- 支持 UTF-8 编码的文本文件处理
- 支持大文件的流式读写
- 提供文件操作的进度回调
- 所有操作通过微内核路由

**验收标准**:
- ✅ 文件读写操作正常
- ✅ 支持多种文件格式
- ✅ 错误处理机制完善
- ✅ 通过微内核路由调用

---

### 15.2 工作区目录管理

**FR-085: 工作区目录管理**

**需求描述**:  
管理编辑器工作区的目录结构，包括根目录、卡片目录、临时目录等。

**功能要点**:
- 初始化工作区目录结构
- 获取和设置工作区根目录
- 管理卡片存储目录
- 管理临时文件目录
- 支持多工作区切换

**技术要求**:
- 工作区路径持久化存储
- 目录不存在时自动创建
- 提供目录存在性检查
- 支持路径规范化处理
- 跨平台路径兼容

**验收标准**:
- ✅ 工作区初始化正常
- ✅ 目录管理功能完整
- ✅ 多工作区切换正常
- ✅ 跨平台路径处理正确

---

### 15.3 卡片文件夹操作

**FR-086: 卡片文件夹操作**

**需求描述**:  
提供卡片文件夹的创建、读取、删除、复制等操作。

**功能要点**:
- 创建卡片文件夹及标准子目录结构
- 读取卡片文件夹内容
- 删除卡片文件夹（支持移动到回收站）
- 复制和移动卡片文件夹
- 重命名卡片文件夹

**技术要求**:
- 遵循卡片文件夹标准结构（.card/、content/、cardcover/）
- 支持递归操作
- 提供操作进度反馈
- 支持批量操作
- 原子性操作保证

**验收标准**:
- ✅ 文件夹操作功能完整
- ✅ 目录结构符合规范
- ✅ 批量操作正常
- ✅ 错误回滚机制有效

---

### 15.4 文件变更监听

**FR-087: 文件变更监听**

**需求描述**:  
监听工作区内文件的变更，支持外部修改检测和实时同步。

**功能要点**:
- 监听文件创建、修改、删除事件
- 监听目录创建、删除事件
- 支持递归监听子目录
- 提供防抖动的变更通知
- 支持暂停和恢复监听

**技术要求**:
- 使用文件系统监听器（fs.watch 或 chokidar）
- 事件防抖动处理（避免频繁触发）
- 支持忽略指定文件/目录
- 监听器资源管理和释放
- 跨平台兼容性

**验收标准**:
- ✅ 文件变更检测准确
- ✅ 事件通知及时
- ✅ 资源释放正确
- ✅ 跨平台正常工作

---

## 16. 卡片初始化需求

### 16.1 卡片ID生成

**FR-088: 卡片ID生成**

**需求描述**:  
生成全局唯一的卡片ID，遵循薯片生态的ID规范。

**功能要点**:
- 生成10位62进制的唯一ID
- 支持前缀类型标识（卡片/箱子/基础卡片）
- 保证ID的全局唯一性
- 支持ID有效性验证
- 支持批量ID生成

**技术要求**:
- ID格式：10位62进制字符（a-z、A-Z、0-9）
- 首字符区分类型（a-m: 卡片, n-z: 箱子, A-Z: 基础卡片）
- 使用高精度时间戳和随机数组合
- 通过微内核的 id.generate 服务生成
- ID碰撞概率 < 10^-15

**验收标准**:
- ✅ ID格式符合规范
- ✅ ID全局唯一
- ✅ 类型前缀正确
- ✅ 通过微内核路由生成

---

### 16.2 卡片目录结构创建

**FR-089: 卡片目录结构创建**

**需求描述**:  
创建符合规范的卡片目录结构。

**功能要点**:
- 创建卡片根目录（以卡片ID命名）
- 创建 `.card/` 配置目录
- 创建 `content/` 内容目录
- 创建 `cardcover/` 封面资源目录
- 支持自定义目录结构扩展

**技术要求**:
- 目录结构符合薯片卡片规范
- 目录创建的原子性保证
- 创建失败时自动清理
- 支持目录权限设置
- 跨平台路径处理

**验收标准**:
- ✅ 目录结构符合规范
- ✅ 原子性创建成功
- ✅ 失败回滚正常
- ✅ 跨平台兼容

---

### 16.3 配置文件初始化

**FR-090: 配置文件初始化（metadata.yaml、structure.yaml）**

**需求描述**:  
创建卡片的核心配置文件，包括元数据和结构配置。

**功能要点**:
- 创建 `metadata.yaml` 元数据文件
- 创建 `structure.yaml` 结构配置文件
- 设置默认元数据（ID、名称、创建时间、版本）
- 设置默认结构（空的基础卡片列表）
- 支持自定义初始配置

**技术要求**:
- YAML格式符合规范
- 支持默认值和自定义值合并
- 配置文件验证（Schema验证）
- 通过微内核的数据序列化服务
- 文件编码为UTF-8

**验收标准**:
- ✅ 配置文件格式正确
- ✅ 默认值设置正确
- ✅ Schema验证通过
- ✅ 通过微内核序列化

---

### 16.4 默认封面创建

**FR-091: 默认封面创建**

**需求描述**:  
为新卡片创建默认封面。

**功能要点**:
- 生成默认的 `cover.html` 文件
- 默认封面显示卡片名称
- 支持默认封面模板配置
- 支持主题适配的默认封面
- 封面尺寸和比例配置

**技术要求**:
- 封面HTML遵循安全规范
- 支持CSS变量用于主题适配
- 默认比例为16:9
- 封面文件保存到 `.card/` 目录
- 支持后续自定义替换

**验收标准**:
- ✅ 默认封面生成正确
- ✅ 封面显示卡片名称
- ✅ 主题适配正常
- ✅ 封面文件位置正确

---

## 17. 封面制作器需求

### 17.1 图片文件封面

**FR-092: 图片文件封面创建**

**需求描述**:  
支持上传图片文件创建封面。

**功能要点**:
- 支持常见图片格式（PNG、JPG、GIF、WebP）
- 图片自动裁剪/适配到封面比例
- 图片保存到 `cardcover/` 目录
- 生成包含图片的 `cover.html`
- 支持图片预览和调整

**技术要求**:
- 图片格式验证和转换
- 支持大图片的压缩处理
- 图片居中或填充模式选择
- 保持图片质量的同时控制文件大小
- 通过微内核的图片处理服务

**验收标准**:
- ✅ 图片上传正常
- ✅ 图片适配封面比例
- ✅ 生成的HTML正确引用图片
- ✅ 图片质量合格

---

### 17.2 HTML代码封面

**FR-093: HTML代码封面创建**

**需求描述**:  
支持直接编写HTML代码创建自定义封面。

**功能要点**:
- 提供HTML代码编辑器
- 支持CSS样式编辑
- 实时预览封面效果
- 代码语法高亮和自动补全
- 支持封面模板导入

**技术要求**:
- HTML内容安全验证（防XSS）
- 支持内联CSS和外部CSS
- 编辑器支持代码格式化
- 预览使用iframe沙箱
- 保存时验证HTML有效性

**验收标准**:
- ✅ HTML编辑器功能完整
- ✅ 实时预览正常
- ✅ 安全验证有效
- ✅ 代码保存正确

---

### 17.3 ZIP压缩包封面

**FR-094: ZIP压缩包封面创建**

**需求描述**:  
支持上传包含完整封面资源的ZIP压缩包。

**功能要点**:
- 支持上传ZIP文件
- 自动解压到 `cardcover/` 目录
- 识别入口文件（index.html 或 cover.html）
- 支持包含CSS、JS、图片等资源
- 资源路径自动调整

**技术要求**:
- ZIP文件格式验证
- 解压前的安全检查（防止路径遍历）
- 资源文件大小限制
- 自动查找入口HTML文件
- 通过微内核的ZIP处理服务

**验收标准**:
- ✅ ZIP上传和解压正常
- ✅ 入口文件识别正确
- ✅ 资源引用路径正确
- ✅ 安全检查有效

---

### 17.4 快速制作器模板

**FR-095: 快速制作器模板封面**

**需求描述**:  
提供预设模板快速创建封面。

**功能要点**:
- 提供多种预设封面模板
- 模板支持参数自定义（标题、颜色、背景）
- 模板分类（简约、图文、动态等）
- 支持收藏常用模板
- 支持导入第三方模板

**技术要求**:
- 模板使用参数化设计
- 模板预览功能
- 模板参数的表单编辑
- 模板本地缓存
- 支持模板更新和版本管理

**验收标准**:
- ✅ 模板列表显示正常
- ✅ 模板参数自定义有效
- ✅ 模板预览准确
- ✅ 生成的封面正确

---

### 17.5 封面比例管理

**FR-096: 封面比例管理**

**需求描述**:  
管理封面的尺寸比例和方向。

**功能要点**:
- 支持多种预设比例（1:1、3:4、16:9等）
- 支持自定义比例
- 支持横竖方向切换
- 比例变更时内容自动适配
- 保存比例配置到卡片元数据

**技术要求**:
- 预设比例列表：
  - 正方形 (1:1)
  - 书本比例 (3:4 / 4:3)
  - 照片比例 (2:3 / 3:2)
  - 电影比例 (16:9 / 9:16)
  - 黄金比例 (1:1.618)
  - 自定义比例
- 比例切换的过渡动画
- 比例信息存储在 metadata.yaml
- 封面预览区域自适应

**验收标准**:
- ✅ 预设比例切换正常
- ✅ 自定义比例设置正常
- ✅ 方向切换正常
- ✅ 比例配置保存正确

---

## 18. 总结

本文档定义了卡片编辑引擎的完整功能需求，核心要点：

1. **微内核架构**: 所有模块通过微内核路由通信，完全解耦
2. **公共基础层**: 完全使用基础层提供的通用组件，不重复开发
3. **薯片组件库**: 使用组件库构建所有界面，遵循样式分离原则
4. **插件化设计**: 布局、编辑、渲染功能由插件提供
5. **实时保存**: 自动保存机制，防抖策略
6. **丰富交互**: 多种拖拽场景，清晰的视觉反馈
7. **高性能**: 视口裁剪、LOD、虚拟化等优化
8. **跨平台**: 支持多操作系统、多输入设备

通过这些功能需求的实现，编辑引擎将成为一个功能完整、性能优秀、架构清晰的卡片编辑平台。

---

**文档维护者**: Chips生态团队  
**最后审核**: 2026-01-31  
**状态**: ✅ 生效
