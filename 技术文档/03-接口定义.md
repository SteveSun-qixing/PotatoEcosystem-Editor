# 卡片编辑引擎 - 接口定义

**版本**: 2.0.0  
**更新时间**: 2026-01-31  
**状态**: 正式版

---

## 1. 接口概述

### 1.1 接口分类

编辑引擎的接口分为以下几类：

1. **微内核调用接口**: 编辑引擎调用微内核提供的服务
2. **编辑引擎服务接口**: 编辑引擎向微内核注册的服务
3. **布局插件接口**: 布局插件必须实现的接口
4. **编辑组件插件接口**: 编辑组件插件必须实现的接口
5. **内部模块接口**: 编辑引擎内部模块的接口

### 1.2 通信协议

所有接口调用遵循薯片协议规范：
- 使用统一的请求/响应格式
- 包含协议版本号
- 包含消息ID和时间戳
- 使用标准错误码

---

## 2. 微内核调用接口

### 2.1 卡片管理接口

编辑引擎调用微内核的卡片管理服务。

#### 2.1.1 读取卡片 (card.read)

**服务名**: `card.read`  
**权限**: `card.read`

**请求格式**:
```typescript
interface CardReadRequest {
  cardId: string;                    // 卡片ID
  includeContent?: boolean;          // 是否包含基础卡片配置，默认true
  includeResources?: boolean;        // 是否包含资源列表，默认false
}
```

**响应格式**:
```typescript
interface CardReadResponse {
  card: {
    id: string;
    metadata: CardMetadata;
    structure: BaseCardInfo[];
    content: Record<string, any>;    // 基础卡片配置
    resources?: ResourceInfo[];      // 资源列表
  };
}

interface CardMetadata {
  name: string;
  createdAt: string;
  modifiedAt: string;
  theme: string;
  tags: Array<string | string[]>;
  chipStandardsVersion: string;
}

interface BaseCardInfo {
  id: string;
  type: string;
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "card.read",
  payload: {
    cardId: "a1B2c3D4e5",
    includeContent: true,
    includeResources: false
  }
});

const card = response.card;
```

---

#### 2.1.2 创建卡片 (card.create)

**服务名**: `card.create`  
**权限**: `card.write`

**请求格式**:
```typescript
interface CardCreateRequest {
  name: string;                      // 卡片名称
  theme?: string;                    // 主题包（可选）
  tags?: Array<string | string[]>;   // 标签（可选）
  saveTo?: string;                   // 保存路径（可选）
}
```

**响应格式**:
```typescript
interface CardCreateResponse {
  cardId: string;                    // 新卡片ID
  filePath: string;                  // 文件路径
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "card.create",
  payload: {
    name: "我的卡片",
    theme: "薯片官方:默认主题",
    tags: ["旅行", ["地点", "日本"]]
  }
});

const cardId = response.cardId;
```

---

#### 2.1.3 更新卡片 (card.update)

**服务名**: `card.update`  
**权限**: `card.write`

**请求格式**:
```typescript
interface CardUpdateRequest {
  cardId: string;
  updates: {
    metadata?: Partial<CardMetadata>;
    structure?: BaseCardInfo[];
    content?: Record<string, any>;
  };
  force?: boolean;                   // 强制覆盖（处理冲突时）
}
```

**响应格式**:
```typescript
interface CardUpdateResponse {
  success: boolean;
  modifiedAt: string;
}
```

**调用示例**:
```typescript
await core.request({
  service: "card.update",
  payload: {
    cardId: "a1B2c3D4e5",
    updates: {
      metadata: {
        name: "新名称",
        tags: ["更新的标签"]
      }
    }
  }
});
```

---

#### 2.1.4 删除卡片 (card.delete)

**服务名**: `card.delete`  
**权限**: `card.delete`

**请求格式**:
```typescript
interface CardDeleteRequest {
  cardId: string;
  permanent?: boolean;               // 是否永久删除，默认移到回收站
}
```

**调用示例**:
```typescript
await core.request({
  service: "card.delete",
  payload: {
    cardId: "a1B2c3D4e5",
    permanent: false
  }
});
```

---

#### 2.1.5 添加基础卡片 (card.add_base_card)

**服务名**: `card.add_base_card`  
**权限**: `card.write`

**请求格式**:
```typescript
interface AddBaseCardRequest {
  cardId: string;                    // 复合卡片ID
  baseCardType: string;              // 基础卡片类型
  config: any;                       // 基础卡片配置
  position?: number;                 // 插入位置，默认末尾
  baseCardId?: string;               // 指定基础卡片ID（撤销时使用）
}
```

**响应格式**:
```typescript
interface AddBaseCardResponse {
  baseCardId: string;                // 新基础卡片ID
  success: boolean;
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "card.add_base_card",
  payload: {
    cardId: "a1B2c3D4e5",
    baseCardType: "MarkdownCard",
    config: {
      contentSource: "inline",
      contentText: "# Hello World"
    },
    position: 0
  }
});

const baseCardId = response.baseCardId;
```

---

#### 2.1.6 移除基础卡片 (card.remove_base_card)

**服务名**: `card.remove_base_card`  
**权限**: `card.write`

**请求格式**:
```typescript
interface RemoveBaseCardRequest {
  cardId: string;                    // 复合卡片ID
  baseCardId: string;                // 基础卡片ID
}
```

**调用示例**:
```typescript
await core.request({
  service: "card.remove_base_card",
  payload: {
    cardId: "a1B2c3D4e5",
    baseCardId: "f6G7h8I9j0"
  }
});
```

---

#### 2.1.7 重排序基础卡片 (card.reorder)

**服务名**: `card.reorder`  
**权限**: `card.write`

**请求格式**:
```typescript
interface ReorderRequest {
  cardId: string;
  baseCardId?: string;               // 单个卡片移动
  newPosition?: number;
  order?: string[];                  // 完整顺序列表
}
```

**调用示例**:
```typescript
// 方式1：移动单个卡片
await core.request({
  service: "card.reorder",
  payload: {
    cardId: "a1B2c3D4e5",
    baseCardId: "f6G7h8I9j0",
    newPosition: 2
  }
});

// 方式2：设置完整顺序
await core.request({
  service: "card.reorder",
  payload: {
    cardId: "a1B2c3D4e5",
    order: ["id1", "id3", "id2", "id4"]
  }
});
```

---

#### 2.1.8 从文件创建卡片 (card.create-from-file)

**服务名**: `card.create-from-file`  
**权限**: `card.write`

**请求格式**:
```typescript
interface CreateFromFileRequest {
  filePath: string;                  // 文件路径
  fileType: string;                  // 文件类型
  extractResources?: boolean;        // 是否提取资源到卡片内，默认true
}
```

**响应格式**:
```typescript
interface CreateFromFileResponse {
  cardId: string;
  name: string;
  filePath: string;
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "card.create-from-file",
  payload: {
    filePath: "/path/to/video.mp4",
    fileType: "video/mp4",
    extractResources: true
  }
});
```

---

#### 2.1.9 导出卡片 (card.export)

**服务名**: `card.export`  
**权限**: `card.read`

**请求格式**:
```typescript
interface CardExportRequest {
  cardId: string;
  exportPath: string;
  format: 'card' | 'html' | 'image' | 'pdf' | 'markdown';
  mode?: 'full' | 'empty';           // 资源模式
  includeNested?: boolean;           // 是否包含嵌套卡片
}
```

**调用示例**:
```typescript
await core.request({
  service: "card.export",
  payload: {
    cardId: "a1B2c3D4e5",
    exportPath: "/path/to/export.html",
    format: "html",
    mode: "full",
    includeNested: true
  }
});
```

---

### 2.2 资源管理接口

#### 2.2.1 获取资源 (resource.fetch)

**服务名**: `resource.fetch`  
**权限**: `resource.read`

**请求格式**:
```typescript
interface ResourceFetchRequest {
  uri: string;                       // 资源URI
  options?: {
    cache?: boolean;                 // 是否使用缓存，默认true
    timeout?: number;                // 超时毫秒，默认10000
    authProfile?: string;            // 认证配置（可选）
  };
}
```

**响应格式**:
```typescript
interface ResourceFetchResponse {
  uri: string;
  contentType: string;
  size: number;
  data: any;                         // 数据或数据流
  metadata: {
    cached: boolean;
    source: string;
    lastModified?: string;
  };
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "resource.fetch",
  payload: {
    uri: "chips://local/cards/a1B2c3D4e5/video.mp4",
    options: { cache: true }
  }
});
```

---

#### 2.2.2 写入资源 (resource.write)

**服务名**: `resource.write`  
**权限**: `resource.write`

**请求格式**:
```typescript
interface ResourceWriteRequest {
  uri: string;
  data: any;
  options?: {
    overwrite?: boolean;             // 是否覆盖，默认false
    createDirectories?: boolean;     // 是否创建目录，默认true
  };
}
```

**调用示例**:
```typescript
await core.request({
  service: "resource.write",
  payload: {
    uri: "chips://local/cards/a1B2c3D4e5/image.jpg",
    data: imageData,
    options: { overwrite: true }
  }
});
```

---

### 2.3 插件管理接口

#### 2.3.1 加载插件 (plugin.load)

**服务名**: `plugin.load`  
**权限**: `plugin.load`

**请求格式**:
```typescript
interface PluginLoadRequest {
  pluginId: string;                  // 插件ID
  pluginType?: string;               // 插件类型（layout/editor/renderer）
  cardType?: string;                 // 卡片类型（加载编辑/渲染器时需要）
}
```

**响应格式**:
```typescript
interface PluginLoadResponse {
  plugin: any;                       // 插件实例
  metadata: PluginMetadata;
}
```

**调用示例**:
```typescript
// 加载布局插件
const layoutResponse = await core.request({
  service: "plugin.load",
  payload: {
    pluginId: "layout.infinite-canvas",
    pluginType: "layout"
  }
});

// 加载编辑组件插件
const editorResponse = await core.request({
  service: "plugin.load",
  payload: {
    pluginType: "editor",
    cardType: "MarkdownCard"
  }
});

// 加载渲染器插件
const rendererResponse = await core.request({
  service: "plugin.load",
  payload: {
    pluginType: "renderer",
    cardType: "VideoCard"
  }
});
```

---

#### 2.3.2 列出插件 (plugin.list)

**服务名**: `plugin.list`  
**权限**: `plugin.read`

**请求格式**:
```typescript
interface PluginListRequest {
  filter?: {
    type?: 'layout' | 'editor' | 'renderer' | 'theme' | 'base_card';
    enabled?: boolean;
    search?: string;
  };
}
```

**响应格式**:
```typescript
interface PluginListResponse {
  plugins: PluginInfo[];
}

interface PluginInfo {
  id: string;
  name: string;
  version: string;
  type: string;
  enabled: boolean;
  description: string;
  author: string;
  metadata: any;
}
```

**调用示例**:
```typescript
// 获取所有布局插件
const response = await core.request({
  service: "plugin.list",
  payload: {
    filter: { type: "layout" }
  }
});

const layouts = response.plugins;
```

---

### 2.4 文件系统接口

#### 2.4.1 识别文件 (file.identify)

**服务名**: `file.identify`  
**权限**: `file.read`

**请求格式**:
```typescript
interface FileIdentifyRequest {
  filePath: string;
}
```

**响应格式**:
```typescript
interface FileIdentifyResponse {
  fileType: string;                  // 文件类型标识
  extension: string;                 // 扩展名
  mimeType: string;                  // MIME类型
  handler: string;                   // 处理模块
  valid: boolean;                    // 是否有效
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "file.identify",
  payload: {
    filePath: "/path/to/video.mp4"
  }
});

// response.fileType: "video"
// response.mimeType: "video/mp4"
```

---

#### 2.4.2 列出文件 (file.list)

**服务名**: `file.list`  
**权限**: `file.read`

**请求格式**:
```typescript
interface FileListRequest {
  path?: string;                     // 路径，默认工作空间
  recursive?: boolean;               // 是否递归，默认false
  filter?: {
    extensions?: string[];           // 文件扩展名过滤
    pattern?: string;                // 文件名模式
  };
}
```

**响应格式**:
```typescript
interface FileListResponse {
  files: FileInfo[];
}

interface FileInfo {
  name: string;
  path: string;
  size: number;
  type: string;
  modifiedAt: string;
}
```

---

#### 2.4.3 搜索文件 (file.search)

**服务名**: `file.search`  
**权限**: `file.read`

**请求格式**:
```typescript
interface FileSearchRequest {
  query: string;                     // 搜索关键词
  searchContent?: boolean;           // 是否搜索内容，默认false
  searchTags?: boolean;              // 是否搜索标签，默认true
  limit?: number;                    // 结果数量限制
}
```

**响应格式**:
```typescript
interface FileSearchResponse {
  files: FileInfo[];
  total: number;
}
```

---

### 2.5 配置管理接口

#### 2.5.1 读取配置 (config.get)

**服务名**: `config.get`  
**权限**: `config.read`

**请求格式**:
```typescript
interface ConfigGetRequest {
  key: string;                       // 配置键（支持点分隔层级）
  scope?: 'system' | 'user' | 'module';  // 配置范围，默认user
}
```

**响应格式**:
```typescript
interface ConfigGetResponse {
  key: string;
  value: any;
  scope: string;
}
```

**调用示例**:
```typescript
const response = await core.request({
  service: "config.get",
  payload: {
    key: "editor.default_layout",
    scope: "user"
  }
});

const defaultLayout = response.value;
```

---

#### 2.5.2 写入配置 (config.set)

**服务名**: `config.set`  
**权限**: `config.write`

**请求格式**:
```typescript
interface ConfigSetRequest {
  key: string;
  value: any;
  scope?: 'system' | 'user' | 'module';
}
```

**调用示例**:
```typescript
await core.request({
  service: "config.set",
  payload: {
    key: "editor.default_layout",
    value: "infinite-canvas",
    scope: "user"
  }
});
```

---

### 2.6 事件系统接口

#### 2.6.1 订阅事件 (event.subscribe)

**方法**: `Core.event.subscribe()`

**调用示例**:
```typescript
// 订阅卡片更新事件
core.event.subscribe("card.updated", (event) => {
  console.log('Card updated:', event.payload);
  // 处理卡片更新
});

// 订阅窗口创建事件
core.event.subscribe("editor.window.created", (event) => {
  console.log('Window created:', event.payload.window);
});

// 订阅文件删除事件
core.event.subscribe("file.deleted", (event) => {
  const fileId = event.payload.fileId;
  // 关闭相关窗口
  windowManager.closeWindowByFileId(fileId);
});
```

---

#### 2.6.2 发布事件 (event.publish)

**方法**: `Core.event.publish()`

**调用示例**:
```typescript
// 发布窗口创建事件
await core.event.publish({
  eventType: "editor.window.created",
  payload: {
    window: {
      id: windowId,
      type: 'card',
      fileId: cardId
    }
  }
});

// 发布文件保存事件
await core.event.publish({
  eventType: "editor.file.saved",
  payload: { fileId: cardId }
});
```

---

### 2.7 公共基础层接口调用

#### 2.7.1 视频播放器 (foundation.video-player.*)

**创建播放器**:
```typescript
const response = await core.request({
  service: "foundation.video-player.create",
  payload: {
    container: elementId,             // 容器元素ID
    videoPath: "path/to/video.mp4",
    options: {
      controls: true,
      autoplay: false,
      loop: false,
      muted: false,
      width: 1920,
      height: 1080
    }
  }
});

const playerId = response.playerId;
```

**控制播放**:
```typescript
// 播放
await core.request({
  service: "foundation.video-player.play",
  payload: { playerId }
});

// 暂停
await core.request({
  service: "foundation.video-player.pause",
  payload: { playerId }
});

// 跳转
await core.request({
  service: "foundation.video-player.seek",
  payload: { playerId, time: 30.5 }
});
```

**添加字幕**:
```typescript
await core.request({
  service: "foundation.video-player.add-subtitle",
  payload: {
    playerId,
    subtitlePath: "path/to/subtitle.srt",
    language: "zh",
    label: "简体中文"
  }
});
```

**销毁播放器**:
```typescript
await core.request({
  service: "foundation.video-player.destroy",
  payload: { playerId }
});
```

---

#### 2.7.2 图片查看器 (foundation.image-viewer.*)

**显示图片**:
```typescript
await core.request({
  service: "foundation.image-viewer.display",
  payload: {
    container: elementId,
    imagePath: "path/to/image.jpg",
    fitMode: "contain",               // contain/cover/fill/none
    clickable: true                   // 是否支持点击放大
  }
});
```

**图片操作**:
```typescript
// 缩放
await core.request({
  service: "foundation.image-viewer.zoom",
  payload: { viewerId, scale: 1.5 }
});

// 旋转
await core.request({
  service: "foundation.image-viewer.rotate",
  payload: { viewerId, angle: 90 }
});
```

---

#### 2.7.3 富文本渲染器 (foundation.rich-text.*)

**渲染富文本**:
```typescript
await core.request({
  service: "foundation.rich-text.render",
  payload: {
    container: elementId,
    content: rtfContent,
    options: {
      editable: false,
      showToolbar: false
    }
  }
});
```

---

#### 2.7.4 Markdown解析器 (foundation.markdown.*)

**解析Markdown**:
```typescript
const response = await core.request({
  service: "foundation.markdown.parse",
  payload: {
    markdown: mdContent,
    options: {
      syntaxHighlight: true,
      showToc: true,
      highlightTheme: "github"
    }
  }
});

const htmlContent = response.html;
const toc = response.toc;           // 目录结构
```

---

#### 2.7.5 代码高亮器 (foundation.code-highlighter.*)

**高亮代码**:
```typescript
const response = await core.request({
  service: "foundation.code-highlighter.highlight",
  payload: {
    code: codeContent,
    language: "javascript",
    theme: "github",
    showLineNumbers: true
  }
});

const highlightedHtml = response.html;
```

---

#### 2.7.6 ZIP处理器 (foundation.zip-processor.*)

**创建ZIP**:
```typescript
await core.request({
  service: "foundation.zip-processor.create",
  payload: {
    files: {
      '.card/metadata.yaml': metadataContent,
      '.card/structure.yaml': structureContent,
      'video.mp4': videoData
    },
    outputPath: "/path/to/card.card",
    compressionLevel: 0               // 零压缩
  }
});
```

**解压ZIP**:
```typescript
const response = await core.request({
  service: "foundation.zip-processor.extract",
  payload: {
    zipPath: "/path/to/card.card",
    extractPath: "/path/to/temp"
  }
});

const extractedFiles = response.files;
```

---

#### 2.7.7 拖拽系统 (foundation.drag-drop.*)

**初始化拖拽系统**:
```typescript
await core.request({
  service: "foundation.drag-drop.init",
  payload: {}
});
```

**注册拖拽源**:
```typescript
await core.request({
  service: "foundation.drag-drop.register-source",
  payload: {
    sourceId: "cardbox-items",
    type: "cardbox-item",
    elements: document.querySelectorAll('.cardbox-item'),
    getData: (element) => ({
      cardType: element.dataset.cardType
    }),
    onDragStart: handleDragStart,
    onDragEnd: handleDragEnd
  }
});
```

**注册放置目标**:
```typescript
await core.request({
  service: "foundation.drag-drop.register-target",
  payload: {
    targetId: "desktop-canvas",
    type: "desktop-empty",
    element: document.getElementById('desktop-content'),
    accepts: ["cardbox-item", "file-system"],
    onDragOver: handleDragOver,
    onDrop: handleDrop
  }
});
```

---

#### 2.7.8 窗口管理器 (foundation.window-manager.*)

**创建窗口**:
```typescript
const response = await core.request({
  service: "foundation.window-manager.create",
  payload: {
    title: "窗口标题",
    width: 800,
    height: 600,
    resizable: true,
    movable: true
  }
});

const windowHandle = response.windowHandle;
```

---

#### 2.7.9 多语言系统 (foundation.i18n.*)

**翻译文本**:
```typescript
const response = await core.request({
  service: "foundation.i18n.translate",
  payload: {
    code: "i18n.editor.200001",
    vars: { count: 10 }
  }
});

const translatedText = response.text;
```

**设置语言**:
```typescript
await core.request({
  service: "foundation.i18n.set-locale",
  payload: { locale: "zh-CN" }
});
```

---

#### 2.7.10 日志系统 (foundation.log.*)

**写入日志**:
```typescript
await core.request({
  service: "foundation.log.write",
  payload: {
    level: "info",
    message: "Card opened successfully",
    context: {
      cardId: "a1B2c3D4e5",
      userId: "user123"
    }
  }
});
```

---

## 3. 编辑引擎服务接口

编辑引擎向微内核注册的服务，供其他模块调用。

### 3.1 窗口服务

#### 3.1.1 创建窗口 (editor.window.create)

**服务名**: `editor.window.create`

**请求格式**:
```typescript
interface WindowCreateRequest {
  fileId: string;
  position?: Position;
  size?: Size;
  state?: WindowState;
}
```

**响应格式**:
```typescript
interface WindowCreateResponse {
  windowId: string;
  window: Window;
}
```

---

#### 3.1.2 聚焦窗口 (editor.window.focus)

**服务名**: `editor.window.focus`

**请求格式**:
```typescript
interface WindowFocusRequest {
  windowId: string;
}
```

---

#### 3.1.3 关闭窗口 (editor.window.close)

**服务名**: `editor.window.close`

**请求格式**:
```typescript
interface WindowCloseRequest {
  windowId: string;
}
```

---

### 3.2 编辑面板服务

#### 3.2.1 加载编辑组件 (editor.edit-panel.load)

**服务名**: `editor.edit-panel.load`

**请求格式**:
```typescript
interface EditPanelLoadRequest {
  cardId: string;
  baseCardId: string;
}
```

**响应格式**:
```typescript
interface EditPanelLoadResponse {
  success: boolean;
  pluginId: string;
}
```

---

## 4. 布局插件接口

### 4.1 LayoutPlugin 接口定义

```typescript
/**
 * 布局插件必须实现的接口
 */
export interface LayoutPlugin {
  // === 基本信息 ===
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly description: string;
  readonly author: string;
  
  // === 生命周期 ===
  
  /**
   * 初始化布局插件
   * @param context 引擎上下文，提供调用引擎功能的接口
   */
  init(context: EngineContext): Promise<void>;
  
  /**
   * 挂载布局到容器
   * @param container 容器元素
   */
  mount(container: HTMLElement): Promise<void>;
  
  /**
   * 卸载布局
   */
  unmount(): Promise<void>;
  
  /**
   * 销毁布局（释放资源）
   */
  destroy(): Promise<void>;
  
  // === 窗口管理 ===
  
  /**
   * 创建窗口
   */
  createWindow(file: File, options?: WindowOptions): Promise<Window>;
  
  /**
   * 关闭窗口
   */
  closeWindow(windowId: string): Promise<void>;
  
  /**
   * 聚焦窗口
   */
  focusWindow(windowId: string): Promise<void>;
  
  /**
   * 获取所有窗口
   */
  getWindows(): Window[];
  
  // === 状态管理 ===
  
  /**
   * 获取布局状态
   */
  getState(): LayoutState;
  
  /**
   * 恢复布局状态
   */
  restoreState(state: LayoutState): Promise<void>;
  
  // === 布局特性 ===
  
  /**
   * 获取布局提供的特性
   */
  getFeatures(): LayoutFeatures;
  
  /**
   * 执行布局特定命令
   */
  executeCommand(command: string, ...args: any[]): Promise<void>;
}
```

---

### 4.2 EngineContext 接口

```typescript
/**
 * 引擎上下文，提供给布局插件
 */
export interface EngineContext {
  /**
   * 调用引擎功能（通过微内核转发）
   */
  callEngine(service: string, payload: any): Promise<any>;
  
  /**
   * 订阅事件（通过微内核事件总线）
   */
  on(eventType: string, handler: EventHandler): void;
  
  /**
   * 取消订阅
   */
  off(eventType: string, handler: EventHandler): void;
  
  /**
   * 获取配置（通过微内核）
   */
  getConfig(key: string): Promise<any>;
  
  /**
   * 设置配置（通过微内核）
   */
  setConfig(key: string, value: any): Promise<void>;
  
  /**
   * 获取薯片SDK实例
   */
  getCore(): Core;
}
```

---

### 4.3 LayoutFeatures 接口

```typescript
/**
 * 布局提供的特性
 */
export interface LayoutFeatures {
  // 是否支持无限画布
  supportsInfiniteCanvas: boolean;
  
  // 是否支持缩放
  supportsZoom: boolean;
  
  // 是否支持平移
  supportsPan: boolean;
  
  // 是否支持多窗口
  supportsMultipleWindows: boolean;
  
  // 是否支持窗格停靠
  supportsDocking: boolean;
  
  // 是否支持标签页
  supportsTabs: boolean;
  
  // 支持的窗口类型
  supportedWindowTypes: WindowType[];
  
  // 自定义特性
  customFeatures?: Record<string, any>;
}
```

---

### 4.4 LayoutState 接口

```typescript
/**
 * 布局状态（用于保存和恢复）
 */
export interface LayoutState {
  // 布局ID
  layoutId: string;
  
  // 打开的文件列表
  openedFiles: string[];
  
  // 窗口状态
  windows: WindowState[];
  
  // 布局特定状态
  layoutSpecific?: any;
}

export interface WindowState {
  windowId: string;
  fileId: string;
  position: Position;
  size: Size;
  state: 'expanded' | 'collapsed' | 'cover' | 'minimized';
  zIndex: number;
}
```

---

## 5. 编辑组件插件接口

### 5.1 EditorPlugin 接口定义

```typescript
/**
 * 编辑组件插件必须实现的接口
 */
export interface EditorPlugin {
  // === 基本信息 ===
  readonly id: string;
  readonly name: string;
  readonly version: string;
  readonly cardType: string;         // 支持的卡片类型
  
  // === 生命周期 ===
  
  /**
   * 挂载编辑组件
   * @param container 容器元素
   * @param options 选项（包含卡片数据和API）
   */
  mount(container: HTMLElement, options: EditorOptions): Promise<void>;
  
  /**
   * 卸载编辑组件
   */
  unmount(): Promise<void>;
  
  // === 数据操作 ===
  
  /**
   * 获取当前数据
   */
  getData(): any;
  
  /**
   * 设置数据
   */
  setData(data: any): Promise<void>;
  
  /**
   * 验证数据
   */
  validate(): ValidationResult;
  
  // === 回调（可选） ===
  
  /**
   * 保存前回调
   */
  onSave?(): Promise<void>;
  
  /**
   * 重置时回调
   */
  onReset?(): Promise<void>;
}
```

---

### 5.2 EditorOptions 接口

```typescript
/**
 * 编辑组件选项
 */
export interface EditorOptions {
  // 卡片ID
  cardId: string;
  
  // 基础卡片ID
  baseCardId: string;
  
  // 基础卡片数据
  data: any;
  
  // 编辑器API
  api: EditorAPI;
}
```

---

### 5.3 EditorAPI 接口

```typescript
/**
 * 编辑器API（引擎提供给编辑组件插件）
 */
export interface EditorAPI {
  /**
   * 更新数据（会触发自动保存）
   * 内部通过微内核调用 card.update
   */
  updateData(newData: any): Promise<void>;
  
  /**
   * 获取资源
   * 内部通过微内核调用 resource.fetch
   */
  getResource(path: string): Promise<Resource>;
  
  /**
   * 上传资源
   * 内部通过微内核调用 resource.write
   */
  uploadResource(file: File): Promise<string>;
  
  /**
   * 显示通知（使用薯片组件库的Message）
   */
  notify(message: string, type?: 'info' | 'success' | 'warning' | 'error'): void;
  
  /**
   * 调用微内核（提供完整的微内核访问能力）
   */
  callKernel(service: string, payload: any): Promise<any>;
  
  /**
   * 订阅事件
   */
  on(eventType: string, handler: EventHandler): void;
  
  /**
   * 取消订阅
   */
  off(eventType: string, handler: EventHandler): void;
}
```

---

### 5.4 编辑组件插件实现示例

```typescript
/**
 * Markdown编辑组件插件示例
 */
export class MarkdownEditorPlugin implements EditorPlugin {
  readonly id = "editor.markdown";
  readonly name = "Markdown编辑器";
  readonly version = "1.0.0";
  readonly cardType = "MarkdownCard";
  
  private container: HTMLElement | null = null;
  private editor: any = null;
  private data: any = null;
  private api: EditorAPI | null = null;
  
  /**
   * 挂载编辑组件
   */
  async mount(container: HTMLElement, options: EditorOptions): Promise<void> {
    this.container = container;
    this.data = options.data;
    this.api = options.api;
    
    // 使用基础层的TextEditor创建编辑器
    const response = await this.api.callKernel(
      "foundation.text-editor.create",
      {
        container: container.id,
        initialValue: this.data.contentText || '',
        options: {
          mode: "markdown",
          lineNumbers: true,
          theme: "default"
        }
      }
    );
    
    this.editor = response.editor;
    
    // 监听编辑器变化
    this.editor.on('change', this.handleChange);
    
    // 渲染编辑器界面（使用薯片组件库）
    this.renderUI();
  }
  
  /**
   * 渲染编辑器界面
   */
  private renderUI(): void {
    // 使用薯片组件库构建编辑器工具栏
    const app = createApp({
      template: `
        <div class="markdown-editor">
          <div class="editor-toolbar">
            <Button @click="insertHeading" size="small">
              <HeadingIcon />
            </Button>
            <Button @click="insertBold" size="small">
              <BoldIcon />
            </Button>
            <Button @click="insertItalic" size="small">
              <ItalicIcon />
            </Button>
            <Button @click="insertCode" size="small">
              <CodeIcon />
            </Button>
            <Divider type="vertical" />
            <Button @click="preview" size="small">
              {{ t('editor.preview') }}
            </Button>
          </div>
          <div id="${this.container!.id}-editor" class="editor-content"></div>
        </div>
      `,
      setup() {
        const insertHeading = () => {
          this.editor.insertText('# ');
        };
        // ... 其他方法
        
        return {
          insertHeading,
          // ...
        };
      }
    });
    
    app.mount(this.container!);
  }
  
  /**
   * 处理编辑器内容变化
   */
  private handleChange = debounce(async (content: string) => {
    // 更新数据（会触发自动保存）
    await this.api!.updateData({
      ...this.data,
      contentText: content
    });
  }, 500);
  
  /**
   * 卸载编辑组件
   */
  async unmount(): Promise<void> {
    if (this.editor) {
      // 销毁编辑器（通过微内核）
      await this.api!.callKernel(
        "foundation.text-editor.destroy",
        { editorId: this.editor.id }
      );
      
      this.editor = null;
    }
    
    // 清理DOM
    if (this.container) {
      this.container.innerHTML = '';
    }
  }
  
  /**
   * 获取当前数据
   */
  getData(): any {
    if (this.editor) {
      return {
        ...this.data,
        contentText: this.editor.getValue()
      };
    }
    return this.data;
  }
  
  /**
   * 设置数据
   */
  async setData(data: any): Promise<void> {
    this.data = data;
    if (this.editor) {
      this.editor.setValue(data.contentText || '');
    }
  }
  
  /**
   * 验证数据
   */
  validate(): ValidationResult {
    const content = this.getData().contentText;
    
    if (!content || content.trim() === '') {
      return {
        valid: false,
        errors: [t('validation.content_required')]
      };
    }
    
    return { valid: true, errors: [] };
  }
}
```

---

## 6. TypeScript 类型定义

### 6.1 核心类型

```typescript
// types/window.ts
export interface Window {
  id: string;
  type: WindowType;
  fileId?: string;
  position: Position;
  size: Size;
  state: WindowState;
  zIndex: number;
  layer: WindowLayer;
  createdAt: number;
  updatedAt: number;
  data?: any;
  visible?: boolean;                 // 是否可见（视口裁剪）
}

export enum WindowType {
  CARD = 'card',
  COVER = 'cover',
  BOX = 'box',
  TOOL = 'tool'
}

export enum WindowState {
  EXPANDED = 'expanded',
  COLLAPSED = 'collapsed',
  COVER = 'cover',
  MINIMIZED = 'minimized'
}

export enum WindowLayer {
  DESKTOP = 'desktop',
  WINDOW = 'window'
}

export interface Position {
  x: number;
  y: number;
}

export interface Size {
  width: number;
  height: number;
}

export interface WindowOptions {
  position?: Position;
  size?: Size;
  state?: WindowState;
  zIndex?: number;
}
```

---

```typescript
// types/card.ts
export interface Card {
  id: string;
  metadata: CardMetadata;
  structure: BaseCardInfo[];
  content: Record<string, any>;
  cover?: string;
  filePath?: string;
}

export interface CardMetadata {
  chipStandardsVersion: string;
  cardId: string;
  name: string;
  createdAt: string;
  modifiedAt: string;
  theme?: string;
  tags?: Array<string | string[]>;
  visibility?: 'public' | 'private' | 'unlisted';
  license?: string;
}

export interface BaseCardInfo {
  id: string;
  type: string;
}

export interface BaseCardConfig {
  cardType: string;
  theme?: string;
  layout?: {
    heightMode?: 'auto' | 'fixed';
    fixedHeight?: number;
    aspectRatio?: string;
  };
  [key: string]: any;
}
```

---

```typescript
// types/file.ts
export interface File {
  id: string;
  name: string;
  type: 'card' | 'box';
  path: string;
  size?: number;
  createdAt?: number;
  modifiedAt?: number;
  tags?: string[];
  coverUrl?: string;
}

export interface FileListOptions {
  path?: string;
  recursive?: boolean;
  filter?: {
    extensions?: string[];
    pattern?: string;
  };
}

export interface SearchOptions {
  searchContent?: boolean;
  searchTags?: boolean;
  limit?: number;
}
```

---

```typescript
// types/plugin.ts
export interface PluginInfo {
  id: string;
  name: string;
  version: string;
  type: 'layout' | 'editor' | 'renderer' | 'theme' | 'base_card';
  enabled: boolean;
  description: string;
  author: string;
  metadata: PluginMetadata;
}

export interface PluginMetadata {
  category?: string;
  icon?: string;
  tags?: string[];
  homepage?: string;
  repository?: string;
  [key: string]: any;
}

export interface PluginFilter {
  type?: string;
  enabled?: boolean;
  search?: string;
}
```

---

```typescript
// types/drag-drop.ts
export enum DragSourceType {
  CARDBOX_ITEM = 'cardbox-item',
  FILE_SYSTEM = 'file-system',
  CARD_WINDOW = 'card-window',
  BASE_CARD = 'base-card',
  WINDOW_TITLEBAR = 'window-titlebar',
  WINDOW_RESIZE = 'window-resize',
  DESKTOP = 'desktop',
}

export enum DropTargetType {
  DESKTOP_EMPTY = 'desktop-empty',
  CARD_WINDOW = 'card-window',
  BOX_WINDOW = 'box-window',
  EDIT_PANEL = 'edit-panel',
}

export interface DragEvent {
  sourceType: DragSourceType;
  sourceId: string;
  data: any;
  position: Position;
  modifierKeys: {
    ctrl: boolean;
    shift: boolean;
    alt: boolean;
  };
}

export interface DropEvent extends DragEvent {
  targetType: DropTargetType;
  targetId: string;
  insertPosition?: number;
}
```

---

```typescript
// types/resource.ts
export interface Resource {
  uri: string;
  contentType: string;
  size: number;
  data: any;
  metadata: ResourceMetadata;
}

export interface ResourceMetadata {
  cached: boolean;
  source: string;
  lastModified?: string;
  width?: number;
  height?: number;
  duration?: number;
}

export type ExportFormat = 'card' | 'html' | 'image' | 'pdf' | 'markdown';

export interface ExportOptions {
  mode?: 'full' | 'empty';
  includeNested?: boolean;
  quality?: number;
}
```

---

## 7. 错误接口

### 7.1 错误响应格式

```typescript
/**
 * 标准错误响应（遵循薯片协议）
 */
export interface ErrorResponse {
  status: 'error';
  error: {
    code: string;
    message: string;
    details?: any;
  };
}
```

### 7.2 编辑器错误类型

```typescript
export enum EditorErrorCode {
  // 窗口错误
  WINDOW_NOT_FOUND = 'E_EDITOR_001',
  WINDOW_CREATE_FAILED = 'E_EDITOR_002',
  WINDOW_INVALID_STATE = 'E_EDITOR_003',
  
  // 坐标错误
  INVALID_COORDINATES = 'E_EDITOR_010',
  TRANSFORM_ERROR = 'E_EDITOR_011',
  
  // 插件错误
  PLUGIN_LOAD_FAILED = 'E_EDITOR_020',
  PLUGIN_NOT_FOUND = 'E_EDITOR_021',
  PLUGIN_INVALID = 'E_EDITOR_022',
  
  // 文件错误
  FILE_SAVE_FAILED = 'E_EDITOR_030',
  FILE_READ_FAILED = 'E_EDITOR_031',
  FILE_NOT_FOUND = 'E_EDITOR_032',
  FILE_CONFLICT = 'E_EDITOR_033',
  
  // 拖拽错误
  DRAG_INVALID_TARGET = 'E_EDITOR_040',
  DRAG_INVALID_SOURCE = 'E_EDITOR_041',
  
  // 数据错误
  DATA_VALIDATION_FAILED = 'E_EDITOR_050',
  DATA_CORRUPTION = 'E_EDITOR_051',
}
```

---

## 8. 事件接口

### 8.1 编辑器事件

```typescript
/**
 * 编辑器发布的事件
 */
export enum EditorEvent {
  // 窗口事件
  WINDOW_CREATED = 'editor.window.created',
  WINDOW_CLOSED = 'editor.window.closed',
  WINDOW_FOCUSED = 'editor.window.focused',
  WINDOW_MOVED = 'editor.window.moved',
  WINDOW_RESIZED = 'editor.window.resized',
  WINDOW_STATE_CHANGED = 'editor.window.state-changed',
  
  // 文件事件
  FILE_OPENED = 'editor.file.opened',
  FILE_SAVED = 'editor.file.saved',
  FILE_MODIFIED = 'editor.file.modified',
  FILE_DELETED = 'editor.file.deleted',
  FILE_RENAMED = 'editor.file.renamed',
  FILE_IMPORTED = 'editor.file.imported',
  
  // 布局事件
  LAYOUT_CHANGED = 'editor.layout.changed',
  LAYOUT_LOADING = 'editor.layout.loading',
  LAYOUT_LOADED = 'editor.layout.loaded',
  
  // 编辑事件
  BASE_CARD_SELECTED = 'editor.base-card.selected',
  BASE_CARD_ADDED = 'editor.base-card.added',
  BASE_CARD_REMOVED = 'editor.base-card.removed',
  BASE_CARD_REORDERED = 'editor.base-card.reordered',
  BASE_CARD_MODIFIED = 'editor.base-card.modified',
  
  // 编辑面板事件
  EDIT_PANEL_OPENED = 'editor.edit-panel.opened',
  EDIT_PANEL_CLOSED = 'editor.edit-panel.closed',
  
  // 命令事件
  COMMAND_EXECUTED = 'editor.command.executed',
  COMMAND_UNDONE = 'editor.command.undone',
  COMMAND_REDONE = 'editor.command.redone',
  
  // 拖拽事件
  DRAG_START = 'editor.drag.start',
  DRAG_MOVE = 'editor.drag.move',
  DRAG_END = 'editor.drag.end',
  DROP = 'editor.drop',
}
```

### 8.2 事件数据格式

```typescript
/**
 * 窗口创建事件
 */
export interface WindowCreatedEvent {
  eventType: 'editor.window.created';
  payload: {
    window: Window;
  };
}

/**
 * 文件保存事件
 */
export interface FileSavedEvent {
  eventType: 'editor.file.saved';
  payload: {
    fileId: string;
    savedAt: string;
  };
}

/**
 * 布局切换事件
 */
export interface LayoutChangedEvent {
  eventType: 'editor.layout.changed';
  payload: {
    from: string;
    to: string;
  };
}

/**
 * 基础卡片添加事件
 */
export interface BaseCardAddedEvent {
  eventType: 'editor.base-card.added';
  payload: {
    cardId: string;
    baseCardId: string;
    baseCardType: string;
    position: number;
  };
}
```

---

## 9. 配置接口

### 9.1 编辑器配置结构

```typescript
/**
 * 编辑器配置
 */
export interface EditorConfig {
  // 布局配置
  layout: {
    defaultLayout: string;           // 默认布局ID
    infiniteCanvas?: InfiniteCanvasConfig;
    workbench?: WorkbenchConfig;
  };
  
  // 主题配置
  theme: {
    defaultTheme: string;            // 默认主题
    allowCardOverride: boolean;      // 允许卡片覆盖主题
  };
  
  // 语言配置
  locale: string;                    // 界面语言
  
  // 自动保存配置
  autoSave: {
    enabled: boolean;                // 是否启用
    debounceDelay: {
      textInput: number;             // 文本输入延迟（ms）
      windowMove: number;            // 窗口移动延迟
      windowResize: number;          // 窗口调整延迟
      cardEdit: number;              // 卡片编辑延迟
    };
  };
  
  // 性能配置
  performance: {
    enableViewportCulling: boolean;  // 启用视口裁剪
    enableLOD: boolean;              // 启用LOD
    maxWindowsWithoutCulling: number; // 不裁剪的最大窗口数
  };
  
  // 快捷键配置
  shortcuts: Record<string, string>;
  
  // 其他配置
  [key: string]: any;
}

export interface InfiniteCanvasConfig {
  defaultScale: number;              // 默认缩放
  minScale: number;                  // 最小缩放
  maxScale: number;                  // 最大缩放
  gridSize: number;                  // 网格大小
  gridStyle: 'dot' | 'line';         // 网格样式
  snapToGrid: boolean;               // 是否吸附网格
  dockPosition: 'bottom' | 'left' | 'right';  // 程序坞位置
}

export interface WorkbenchConfig {
  defaultLeftWidth: number;
  defaultRightWidth: number;
  defaultBottomHeight: number;
  fileManagerView: 'tree' | 'list' | 'grid';
  showBreadcrumb: boolean;
}
```

### 9.2 配置访问

```typescript
// 通过微内核读取配置
const config = await core.request({
  service: "config.get",
  payload: { key: "editor" }
});

// 通过微内核写入配置
await core.request({
  service: "config.set",
  payload: {
    key: "editor.layout.defaultLayout",
    value: "workbench"
  }
});
```

---

## 10. 请求响应格式

### 10.1 标准请求格式

```typescript
/**
 * 标准请求消息（遵循薯片协议）
 */
export interface Request {
  protocolVersion: string;           // "1.0.0"
  messageId: string;                 // UUID
  timestamp: string;                 // ISO 8601
  sender: string;                    // "chips.editor"
  service: string;                   // 服务名称
  payload: any;                      // 请求参数
  options?: {
    timeout?: number;
    priority?: 'low' | 'normal' | 'high' | 'critical';
    trace?: boolean;
  };
}
```

### 10.2 标准响应格式

```typescript
/**
 * 标准响应消息（遵循薯片协议）
 */
export interface Response {
  protocolVersion: string;
  messageId: string;
  requestId: string;
  timestamp: string;
  status: 'success' | 'error' | 'partial';
  data: any;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  metadata?: {
    executionTime: number;
    cacheHit?: boolean;
  };
}
```

---

## 11. 接口使用示例

### 11.1 完整的打开卡片流程

```typescript
/**
 * 打开卡片的完整接口调用流程
 */
async function openCard(cardId: string): Promise<void> {
  try {
    // 1. 读取卡片数据（通过微内核）
    const cardResponse = await core.request({
      service: "card.read",
      payload: {
        cardId,
        includeContent: true,
        includeResources: false
      }
    });
    
    const cardData = cardResponse.card;
    
    // 2. 为每个基础卡片加载渲染器插件（通过微内核）
    for (const baseCard of cardData.structure) {
      await core.request({
        service: "plugin.load",
        payload: {
          pluginType: "renderer",
          cardType: baseCard.type
        }
      });
    }
    
    // 3. 创建窗口
    const window = await windowManager.createWindow(cardId);
    
    // 4. 渲染基础卡片（使用薯片组件库）
    // 组件库内部通过微内核调用基础层
    // 例如：VideoCard调用 foundation.video-player.create
    
    // 5. 发布窗口创建事件
    await core.event.publish({
      eventType: "editor.window.created",
      payload: { window }
    });
    
  } catch (error) {
    // 错误处理
    await core.request({
      service: "foundation.log.write",
      payload: {
        level: "error",
        message: "Failed to open card",
        context: { cardId, error }
      }
    });
    
    Message.error(t('error.open_card_failed'));
  }
}
```

---

### 11.2 完整的编辑并保存流程

```typescript
/**
 * 编辑卡片并自动保存的完整接口调用流程
 */
async function editCard(cardId: string, baseCardId: string): Promise<void> {
  // 1. 加载编辑组件插件（通过微内核）
  const pluginResponse = await core.request({
    service: "plugin.load",
    payload: {
      pluginType: "editor",
      cardType: "MarkdownCard"
    }
  });
  
  const editorPlugin = pluginResponse.plugin;
  
  // 2. 读取基础卡片数据（通过微内核）
  const cardResponse = await core.request({
    service: "card.read",
    payload: { cardId }
  });
  
  const baseCardData = cardResponse.card.content[baseCardId];
  
  // 3. 挂载编辑组件
  const container = document.getElementById('edit-plugin-container');
  await editorPlugin.mount(container, {
    cardId,
    baseCardId,
    data: baseCardData,
    api: {
      // API内部通过微内核操作
      updateData: async (newData: any) => {
        await core.request({
          service: "card.update",
          payload: {
            cardId,
            updates: {
              content: { [baseCardId]: newData }
            }
          }
        });
        
        // 触发自动保存
        saveManager.markDirty(cardId, 'card-edit', newData);
      },
      
      getResource: async (path: string) => {
        return await core.request({
          service: "resource.fetch",
          payload: { uri: `card://${cardId}/${path}` }
        });
      },
      
      uploadResource: async (file: File) => {
        const uri = `card://${cardId}/${file.name}`;
        await core.request({
          service: "resource.write",
          payload: { uri, data: file }
        });
        return uri;
      },
      
      notify: (message: string, type: string) => {
        Message[type](message);
      },
      
      callKernel: async (service: string, payload: any) => {
        return await core.request({ service, payload });
      }
    }
  });
  
  // 4. 用户编辑（编辑组件内部使用基础层的TextEditor等）
  
  // 5. 编辑组件调用updateData()
  //    → API内部调用core.request("card.update")
  //    → 微内核保存数据
  
  // 6. 标记为脏数据，触发防抖保存
  //    → 1秒后调用saveNow()
  //    → 通过微内核最终保存到文件
  
  // 7. 发布保存事件
  await core.event.publish({
    eventType: "editor.file.saved",
    payload: { fileId: cardId }
  });
}
```

---

### 11.3 完整的拖拽创建卡片流程

```typescript
/**
 * 从卡箱库拖拽创建卡片的完整接口调用流程
 */
async function createCardByDrag(
  cardType: string,
  position: Position
): Promise<void> {
  // 1. 创建卡片（通过微内核）
  const createResponse = await core.request({
    service: "card.create",
    payload: {
      name: t('card.untitled')
    }
  });
  
  const cardId = createResponse.cardId;
  
  // 2. 添加基础卡片（通过微内核）
  const addResponse = await core.request({
    service: "card.add_base_card",
    payload: {
      cardId,
      baseCardType: cardType,
      config: {},  // 默认配置
      position: 0
    }
  });
  
  const baseCardId = addResponse.baseCardId;
  
  // 3. 创建窗口
  const window = await windowManager.createWindow(cardId, {
    position,
    size: { width: 600, height: 800 },
    state: 'expanded'
  });
  
  // 4. 发布事件
  await core.event.publish({
    eventType: "editor.window.created",
    payload: { window }
  });
  
  await core.event.publish({
    eventType: "editor.base-card.added",
    payload: { cardId, baseCardId, baseCardType: cardType, position: 0 }
  });
}
```

---

## 12. 接口调用规范

### 12.1 强制规范

**所有调用必须通过微内核** ⭐:
```typescript
// ✅ 正确：通过微内核路由
const response = await core.request({
  service: "card.read",
  payload: { cardId }
});

// ❌ 错误：直接调用
import { CardReader } from './card-reader';
const card = await CardReader.read(cardId);  // 禁止！
```

**所有接口必须有错误处理**:
```typescript
// ✅ 正确：完整的错误处理
try {
  const response = await core.request({
    service: "card.update",
    payload: { cardId, updates }
  });
  
  Message.success(t('message.save_success'));
  
} catch (error) {
  // 记录错误
  await core.request({
    service: "foundation.log.write",
    payload: {
      level: "error",
      message: "Failed to update card",
      context: { cardId, error }
    }
  });
  
  // 显示错误
  Message.error(t('message.save_failed'));
}
```

**所有异步操作必须有超时**:
```typescript
const response = await core.request({
  service: "card.read",
  payload: { cardId },
  options: { timeout: 10000 }  // 10秒超时
});
```

---

### 12.2 性能优化规范

**使用批量请求**:
```typescript
// ✅ 优化：批量请求
const response = await core.request({
  service: "batch.request",
  payload: {
    requests: cardIds.map(id => ({
      service: "card.read",
      payload: { cardId: id }
    })),
    strategy: "parallel"
  }
});

// ❌ 低效：串行请求
for (const cardId of cardIds) {
  await core.request({
    service: "card.read",
    payload: { cardId }
  });
}
```

**使用缓存**:
```typescript
// 检查缓存
const cacheResponse = await core.request({
  service: "foundation.cache-manager.get",
  payload: { key: resourceUri }
});

if (cacheResponse.cached) {
  return cacheResponse.data;
}

// 获取资源并缓存
const resource = await core.request({
  service: "resource.fetch",
  payload: { uri: resourceUri }
});

await core.request({
  service: "foundation.cache-manager.set",
  payload: {
    key: resourceUri,
    value: resource,
    ttl: 3600
  }
});
```

---

### 12.3 安全规范

**输入验证**:
```typescript
// ✅ 正确：验证输入
function updateCardName(cardId: string, name: string) {
  // 验证卡片ID
  if (!/^[0-9a-zA-Z]{10}$/.test(cardId)) {
    throw new EditorError(
      EditorErrorCode.DATA_VALIDATION_FAILED,
      t('error.invalid_card_id')
    );
  }
  
  // 验证文件名
  const validation = ValidationUtils.validateFileName(name);
  if (!validation.valid) {
    throw new EditorError(
      EditorErrorCode.DATA_VALIDATION_FAILED,
      validation.error
    );
  }
  
  // 调用微内核更新
  return core.request({
    service: "card.update",
    payload: {
      cardId,
      updates: { metadata: { name } }
    }
  });
}
```

---

## 13. 接口速查表

### 13.1 卡片接口

| 服务名 | 权限 | 用途 |
|--------|------|------|
| card.read | card.read | 读取卡片 |
| card.create | card.write | 创建卡片 |
| card.update | card.write | 更新卡片 |
| card.delete | card.delete | 删除卡片 |
| card.add_base_card | card.write | 添加基础卡片 |
| card.remove_base_card | card.write | 移除基础卡片 |
| card.reorder | card.write | 重排序 |
| card.export | card.read | 导出卡片 |

---

### 13.2 资源接口

| 服务名 | 权限 | 用途 |
|--------|------|------|
| resource.fetch | resource.read | 获取资源 |
| resource.write | resource.write | 写入资源 |
| resource.exists | resource.read | 检查存在 |
| resource.meta | resource.read | 获取元信息 |
| resource.delete | resource.delete | 删除资源 |

---

### 13.3 插件接口

| 服务名 | 权限 | 用途 |
|--------|------|------|
| plugin.load | plugin.load | 加载插件 |
| plugin.unload | plugin.unload | 卸载插件 |
| plugin.list | plugin.read | 列出插件 |
| plugin.info | plugin.read | 获取插件信息 |
| plugin.install | plugin.install | 安装插件 |
| plugin.uninstall | plugin.uninstall | 卸载插件 |

---

### 13.4 基础层接口

| 服务名 | 用途 |
|--------|------|
| foundation.video-player.create | 创建视频播放器 |
| foundation.audio-player.create | 创建音频播放器 |
| foundation.image-viewer.display | 显示图片 |
| foundation.markdown.parse | 解析Markdown |
| foundation.code-highlighter.highlight | 代码高亮 |
| foundation.zip-processor.create | 创建ZIP |
| foundation.zip-processor.extract | 解压ZIP |
| foundation.drag-drop.init | 初始化拖拽系统 |
| foundation.drag-drop.register-source | 注册拖拽源 |
| foundation.drag-drop.register-target | 注册放置目标 |

---

## 14. 总结

### 14.1 接口设计原则

1. **统一规范**: 所有接口遵循薯片协议规范
2. **中心路由**: 所有调用通过微内核路由
3. **类型安全**: 完整的TypeScript类型定义
4. **错误处理**: 标准的错误响应格式
5. **性能优化**: 支持批量请求和缓存

### 14.2 接口层次

```
应用层接口（编辑引擎调用）
  ↓ 通过薯片SDK
微内核接口（薯片协议）
  ↓ 路由到
基础层接口（公共基础层服务）
插件接口（插件系统服务）
```

### 14.3 开发建议

1. **使用服务层**: 优先使用封装好的服务类（CardService、ResourceService等）
2. **类型安全**: 使用TypeScript类型定义，避免类型错误
3. **错误处理**: 所有调用都要有try-catch
4. **性能优化**: 使用批量请求、缓存等优化手段
5. **遵循规范**: 严格遵循薯片协议和编码规范

---

**文档维护者**: Chips生态团队  
**最后审核**: 2026-01-31  
**状态**: ✅ 生效
