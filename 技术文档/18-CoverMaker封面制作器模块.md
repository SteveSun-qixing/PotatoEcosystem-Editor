# CoverMaker 封面制作器模块

## 模块定位与职责

封面制作器是编辑引擎的核心功能模块之一，负责卡片封面的创建、编辑和管理。封面是用户浏览卡片列表或在桌面上查看收起状态时看到的预览内容，良好的封面设计能帮助用户快速识别卡片内容。

封面以 HTML 网页形式存储在卡片目录的 `.card/cover.html` 文件中，通过 iframe 沙箱渲染显示。这种设计使封面支持丰富的视觉效果，包括动态背景、自定义样式、交互动画等，同时保证安全隔离。如果卡片没有设置封面，系统自动使用默认封面——白色背景配合居中显示的卡片名称。

封面制作器的核心职责包括：提供多种封面创建方式满足不同用户需求，管理封面比例适配不同展示场景，实时预览封面效果，以及将最终结果生成为标准的 cover.html 文件。


## 四种封面创建方式

封面制作器提供四种创建方式，从简单到复杂，满足不同技术背景用户的需求。

### 选择图片文件

这是最简单直接的封面创建方式。用户点击「选择图片文件」按钮后，系统弹出文件选择对话框，用户从本地文件系统选择一张图片。选择完成后，图片文件复制到卡片的 `cardcover` 资源文件夹中，系统根据图片路径自动生成一个标准的 HTML 封面页面。生成的 HTML 使用 CSS 将图片居中显示并自适应封面区域大小，图片默认采用 `object-fit: cover` 模式，确保完整覆盖封面区域而不留空白。

支持的图片格式包括 JPG、PNG、GIF、WebP 和 SVG。对于 GIF 等动图格式，封面会保留动画效果。系统在写入前会检查图片文件的有效性，如果文件损坏或格式不支持，会提示用户重新选择。

生成的 HTML 模板结构如下：封面容器占满整个视口，图片元素使用绝对定位撑满容器，通过 `object-fit` 属性控制图片的缩放裁剪行为。这种结构简洁高效，确保图片在任何封面比例下都能正确显示。

### 粘贴 HTML 代码

这种方式面向有前端开发经验的用户，提供完全的自定义能力。用户在代码编辑区域输入或粘贴 HTML 代码，可以随时编辑修改，点击确认后代码直接保存为 cover.html 文件。

代码编辑区提供语法高亮和基本的格式化功能。编辑器右侧显示实时预览，用户每次修改代码后预览区域自动刷新，展示封面的实际渲染效果。预览区域使用与正式显示相同的 iframe 沙箱环境，确保所见即所得。

用户可以在 HTML 中使用内联 CSS 样式，也可以在 `<style>` 标签中编写样式表。支持引用卡片内的资源文件，使用相对路径指向 `cardcover` 文件夹或卡片根目录中的文件。封面代码在沙箱中运行时有安全限制：不能访问父窗口、不能提交表单、不能弹出新窗口、不能发起网络请求。这些限制确保封面代码不会影响编辑器的安全性和稳定性。

### 上传 ZIP 压缩包

当封面包含多个文件时（比如样式表、脚本、图片资源等），用户可以将所有文件打包为 ZIP 压缩包上传。系统接收压缩包后执行以下处理流程：首先验证压缩包格式是否正确，然后解压到临时目录进行检查，查找压缩包根目录或一级子目录中的 index.html 文件作为封面入口。

如果找到 index.html，系统将解压后的所有文件移动到卡片的 `cardcover` 文件夹中，index.html 的内容复制为 cover.html。如果压缩包中不存在 index.html 文件，系统提示用户「压缩包中未找到 index.html 入口文件，请检查后重新上传」。

压缩包上传适合从外部设计工具导出的封面模板，或者从网上下载的封面素材包。系统对压缩包的总大小有限制，超过限制会提示用户优化资源文件的体积。解压过程中如果遇到文件名编码问题（如中文乱码），系统会尝试多种编码方式进行解析。

### 快速制作器

快速制作器是编辑引擎内置的封面模板系统，专为不熟悉 HTML 代码的普通用户设计。用户从预设的风格模板中选择一个，然后填写要显示的文字内容，系统根据选择的模板和填写的文字自动生成封面 HTML。

快速制作器的界面分为三个区域：左侧是模板选择网格，每个模板显示缩略预览图和名称；中间是配置面板，用户填写标题、副标题等文字内容，以及选择颜色方案；右侧是实时预览区，展示当前配置的封面效果。

文字配置项包括主标题、副标题、描述文字，每个配置项可以独立设置字体大小、颜色、位置。部分模板还支持配置背景颜色或渐变方向。所有配置项都有合理的默认值，用户可以只填写标题就生成可用的封面。


## 快速制作器模板设计

快速制作器内置多种风格模板，覆盖常见的封面设计需求。每个模板是一个独立的 HTML 模板文件，包含预设的样式结构和可配置的占位符。

简约白底模板采用纯白色背景，主标题居中显示使用深灰色无衬线字体，副标题在主标题下方使用较小字号和浅灰色。这种风格干净清爽，适合笔记、文档类卡片。

渐变背景模板提供多种预设的渐变配色，从蓝紫渐变到橙红暖色调到冷灰商务风格。文字使用白色或深色，根据背景明暗自动调整以保证可读性。渐变方向可以在配置中选择对角线、垂直或水平。

深色风格模板使用深灰或纯黑背景，搭配白色或彩色文字。适合技术类、创意类卡片，给人专业沉稳的感觉。部分深色模板带有微妙的纹理背景或边框装饰。

几何图形模板在背景中加入简单的几何装饰元素，如圆形、三角形、线条等。这些元素使用 CSS 或 SVG 绘制，颜色可以配置。几何风格现代感强，适合设计类、项目类卡片。

纯色边框模板使用白色背景配合彩色粗边框，边框颜色可以从预设的色板中选择。文字排列在边框内部，整体风格简洁有力。

每个模板在系统中以 JSON 配置文件的形式存储，描述模板的基本信息、可配置项、HTML 模板字符串。模板管理器负责加载和解析这些配置，渲染时将用户填写的内容替换到模板中的占位符位置。


## 封面比例与尺寸管理

封面支持多种预设比例，用户可以根据展示场景和个人喜好选择合适的比例。比例设置保存在卡片元数据中，影响封面在桌面上显示时的尺寸。

系统预设的封面比例包括：正方形比例 1:1 适合头像、Logo 类封面；标准照片比例 3:4 是默认选项，接近传统照片的纵横比；横版照片 4:3 适合横向构图的图片封面；手机比例 9:16 适合竖屏截图或手机界面类封面；视频比例 16:9 适合横向宽屏内容；书本比例 2:3 接近书籍封面的比例。

用户在卡片设置对话框的「封面设置」选项卡中选择比例。选择比例后，预览区域立即按新比例显示封面效果，用户可以直观看到不同比例下封面的呈现效果。比例选择器以下拉列表形式呈现，每个选项显示比例数值和描述性名称。

封面比例存储在卡片元数据的 `coverRatio` 字段中，格式为 `宽:高` 的字符串，如 `"3:4"`。显示封面时，系统解析比例字符串计算出 CSS 的 `aspect-ratio` 属性值。封面容器的宽度固定（默认 200px），高度根据比例自动计算。

不同的布局模式可能对封面显示有不同的处理。无限画布布局中，封面作为独立的小窗口显示在桌面上，大小由比例和预设宽度决定。工作台布局或网格布局中，封面可能会根据容器大小自适应缩放，但始终保持设定的比例。


## 接口设计

### CoverMaker 类

`CoverMaker` 是封面制作器的核心类，封装了封面创建的所有逻辑。

```typescript
class CoverMaker {
  private cardId: string;
  private fileSystem: FileSystemService;
  
  constructor(cardId: string, fileSystem: FileSystemService);
  
  // 创建方式
  createFromImage(imageFile: File): Promise<CoverResult>;
  createFromHTML(htmlCode: string): Promise<CoverResult>;
  createFromZip(zipFile: File): Promise<CoverResult>;
  createFromTemplate(templateId: string, config: TemplateConfig): Promise<CoverResult>;
  
  // 预览
  generatePreview(source: CoverSource): Promise<string>;
  
  // 保存
  saveCover(htmlContent: string): Promise<void>;
  
  // 比例管理
  setCoverRatio(ratio: CoverRatio): void;
  getCoverRatio(): CoverRatio;
  
  // 工具方法
  validateHTML(code: string): ValidationResult;
  validateZip(file: File): Promise<ValidationResult>;
}
```

`createFromImage` 方法接收用户选择的图片文件，将图片复制到资源目录并生成包装 HTML，返回生成结果。`createFromHTML` 方法接收用户输入的 HTML 代码，进行必要的安全检查后直接作为封面内容。`createFromZip` 方法处理压缩包上传，解压验证后提取 index.html 内容。`createFromTemplate` 方法根据模板 ID 和配置参数生成封面 HTML。

所有创建方法都返回 `CoverResult` 对象，包含生成的 HTML 内容、是否成功、错误信息等。生成预览时调用 `generatePreview` 方法，传入封面来源信息，返回可以在 iframe 中显示的 HTML 字符串。

### 类型定义

```typescript
// 封面比例类型
type CoverRatio = '1:1' | '3:4' | '4:3' | '9:16' | '16:9' | '2:3';

// 封面创建结果
interface CoverResult {
  success: boolean;
  html?: string;
  error?: string;
  resources?: string[];  // 额外的资源文件路径
}

// 模板配置
interface TemplateConfig {
  title?: string;
  subtitle?: string;
  description?: string;
  primaryColor?: string;
  backgroundColor?: string;
  gradientDirection?: 'diagonal' | 'vertical' | 'horizontal';
}

// 封面来源（用于预览）
type CoverSource = 
  | { type: 'image'; file: File }
  | { type: 'html'; code: string }
  | { type: 'zip'; file: File }
  | { type: 'template'; templateId: string; config: TemplateConfig };

// 验证结果
interface ValidationResult {
  valid: boolean;
  errors: string[];
  warnings: string[];
}

// 模板定义
interface CoverTemplate {
  id: string;
  name: string;
  thumbnail: string;
  category: string;
  configSchema: TemplateConfigSchema;
  htmlTemplate: string;
}
```

### CoverTemplateManager 类

`CoverTemplateManager` 负责管理快速制作器的模板库。

```typescript
class CoverTemplateManager {
  private templates: Map<string, CoverTemplate>;
  
  // 加载模板
  loadBuiltinTemplates(): Promise<void>;
  loadCustomTemplates(path: string): Promise<void>;
  
  // 查询模板
  getTemplate(id: string): CoverTemplate | undefined;
  getAllTemplates(): CoverTemplate[];
  getTemplatesByCategory(category: string): CoverTemplate[];
  
  // 渲染模板
  renderTemplate(template: CoverTemplate, config: TemplateConfig): string;
}
```

内置模板在编辑器初始化时自动加载。`renderTemplate` 方法将用户配置的内容替换到模板的占位符中，返回最终的 HTML 字符串。模板中的占位符使用双花括号语法，如 `{{title}}`、`{{subtitle}}` 等。


## UI 交互设计

封面制作器的 UI 集成在卡片设置对话框（`CardSettingsDialog`）的「封面设置」选项卡中。整个选项卡分为上下两个主要区域：上方是封面预览和比例选择，下方是四种创建方式的切换面板。

### 预览区域

预览区域显示当前封面的实时效果。预览容器的宽度固定，高度根据选择的比例自动调整。容器内使用 iframe 加载封面 HTML，iframe 设置为沙箱模式，禁用脚本执行和外部访问。如果卡片尚未设置封面，预览区显示默认封面效果——白色背景配合居中的卡片名称。

预览区域右上角有刷新按钮，点击后重新加载当前封面。在编辑 HTML 代码或调整快速制作器配置时，预览会自动更新，但如果用户需要强制刷新也可以手动触发。

比例选择器位于预览区域下方，以下拉列表形式呈现。选择新比例后，预览区域立即按新比例调整尺寸，用户可以直观对比不同比例的效果。

### 创建方式切换

四种创建方式以标签页形式组织，用户点击标签切换不同的创建面板。每个标签页显示方式名称和简短图标，当前激活的标签高亮显示。

「选择图片」面板包含一个文件选择按钮和已选择图片的缩略预览。点击按钮弹出系统文件选择对话框，选择图片后缩略图显示在按钮下方，同时上方的封面预览自动更新。面板底部显示支持的图片格式说明。

「粘贴 HTML」面板包含一个多行代码编辑器，支持语法高亮。编辑器下方有「验证代码」按钮，点击后检查 HTML 语法和安全性，在编辑器下方显示验证结果。代码修改后封面预览自动更新，使用防抖机制避免频繁刷新。

「上传压缩包」面板包含文件拖放区域和文件选择按钮。用户可以直接将 ZIP 文件拖到该区域，也可以点击按钮选择文件。上传后显示处理进度，处理完成后显示解压结果——成功时预览自动更新，失败时显示错误信息。

「快速制作器」面板分为左右两栏：左栏是模板选择网格，每个模板显示缩略图和名称，点击选中高亮边框；右栏是配置表单，根据选中模板显示可配置的字段（标题、副标题、颜色等）。配置修改实时反映到上方的封面预览中。

### 操作按钮

选项卡底部有「恢复默认」和「应用」两个按钮。「恢复默认」清除当前封面设置，恢复为系统默认封面。「应用」将当前预览的封面内容保存为 cover.html 文件。如果用户切换选项卡或关闭对话框时有未保存的更改，系统提示用户是否保存。


## 错误处理

封面制作器在各个环节都有完善的错误处理机制，确保用户获得清晰的反馈。

图片文件处理时可能遇到的错误包括：文件格式不支持、文件损坏无法读取、文件体积超过限制。系统在读取文件前先检查扩展名和 MIME 类型，读取时捕获解码错误。错误信息以友好的中文提示展示，如「不支持的图片格式，请选择 JPG、PNG、GIF、WebP 或 SVG 文件」。

HTML 代码验证时检查基本的语法正确性和潜在的安全问题。语法错误时指出错误位置和可能的原因。安全检查会警告或阻止包含危险元素的代码，如 `<script>` 标签中的外部脚本引用、`<iframe>` 指向外部地址等。验证结果区分错误和警告：错误必须修复才能保存，警告可以忽略但建议处理。

ZIP 压缩包处理时可能遇到：压缩包损坏、格式不正确（不是 ZIP 格式）、解压后找不到 index.html、压缩包体积或文件数量超过限制、文件名编码问题。每种情况都有对应的错误提示，指导用户如何修正。解压过程中如果部分文件失败，系统记录失败的文件列表，让用户决定是否继续。

快速制作器的配置验证较为宽松，大多数字段允许为空使用默认值。但对于必填字段（如主标题），为空时在字段下方显示提示，保存按钮禁用直到填写。颜色值会验证格式是否正确（支持 HEX、RGB、HSL 格式）。

文件保存时可能因磁盘空间不足、权限不足、文件被占用等原因失败。保存失败时提示具体原因，建议用户检查磁盘空间或重试。为防止数据丢失，保存前系统将之前的封面备份到临时位置，保存成功后删除备份，保存失败则恢复备份。

所有错误处理都遵循以下原则：提供清晰具体的错误描述、给出可操作的解决建议、不丢失用户已输入的内容、在合适的位置显示错误信息（字段级错误显示在字段旁，全局错误显示在面板顶部）。
