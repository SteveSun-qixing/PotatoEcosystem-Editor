# 11-测试手册

## 1. 测试策略

### 1.1 测试金字塔

```
       /\
      /E2E\          端到端测试 (10%)
     /------\        - Playwright/Cypress
    /Integration\    集成测试 (20%)
   /------------\    - 组件集成测试
  /Unit Tests    \   单元测试 (70%)
 /----------------\  - Jest/Vitest
```

### 1.2 测试类型

**单元测试（Unit Tests）**
- 测试单个函数、组件、类
- 覆盖率目标：80%+
- 执行速度：快速（毫秒级）
- 工具：Jest / Vitest

**组件测试（Component Tests）**
- 测试React/Vue组件
- UI交互测试
- 快照测试
- 工具：React Testing Library

**集成测试（Integration Tests）**
- 测试模块间协作
- 数据流测试
- 工具：Jest + Testing Library

**UI测试（UI Tests）**
- 浏览器自动化测试
- 跨浏览器测试
- 工具：Playwright / Cypress

**E2E测试（End-to-End Tests）**
- 完整用户流程测试
- 真实场景模拟
- 工具：Playwright

**拖拽交互测试（Drag & Drop Tests）**
- 拖拽操作模拟
- 拖放目标验证
- 工具：Testing Library + DnD Kit

**性能测试（Performance Tests）**
- 渲染性能
- 内存占用
- 响应时间
- 工具：Lighthouse, React DevTools Profiler

---

## 2. 测试框架选择

### 2.1 单元测试框架

**推荐: Vitest**

```typescript
// 配置文件 vitest.config.ts
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: './tests/setup.ts',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '**/*.d.ts',
        '**/*.config.*',
      ],
    },
  },
});
```

**基础测试**
```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { WindowManager } from '../src/engine/WindowManager';

describe('WindowManager', () => {
  let windowManager: WindowManager;

  beforeEach(() => {
    windowManager = new WindowManager(eventBus);
  });

  it('should create a window', () => {
    const window = windowManager.createWindow({
      type: 'card',
      position: { x: 100, y: 100 },
      size: { width: 400, height: 300 },
    });

    expect(window).toBeDefined();
    expect(window.type).toBe('card');
  });

  it('should focus window', () => {
    const window = windowManager.createWindow({ type: 'card' });
    windowManager.focusWindow(window.id);

    expect(windowManager.getFocusedWindow()?.id).toBe(window.id);
  });
});
```

---

### 2.2 组件测试框架

**React Testing Library**

```typescript
import { render, screen, fireEvent } from '@testing-library/react';
import { describe, it, expect, vi } from 'vitest';
import { CardWindow } from '../src/ui/components/CardWindow';

describe('CardWindow Component', () => {
  it('should render window with title', () => {
    render(
      <CardWindow
        id="test-window"
        title="Test Card"
        position={{ x: 0, y: 0 }}
        size={{ width: 400, height: 300 }}
      />
    );

    expect(screen.getByText('Test Card')).toBeInTheDocument();
  });

  it('should handle close button click', () => {
    const onClose = vi.fn();
    render(
      <CardWindow
        id="test-window"
        title="Test"
        onClose={onClose}
      />
    );

    const closeButton = screen.getByRole('button', { name: /close/i });
    fireEvent.click(closeButton);

    expect(onClose).toHaveBeenCalledWith('test-window');
  });

  it('should handle drag', () => {
    const onDragStart = vi.fn();
    render(
      <CardWindow
        id="test-window"
        title="Test"
        onDragStart={onDragStart}
      />
    );

    const header = screen.getByText('Test').closest('.window-header');
    fireEvent.mouseDown(header!);

    expect(onDragStart).toHaveBeenCalled();
  });
});
```

---

### 2.3 E2E测试框架

**Playwright**

```typescript
// tests/e2e/basic.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Editor Basic Operations', () => {
  test('should create new card', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // 点击新建卡片按钮
    await page.click('[data-testid="new-card-btn"]');

    // 选择卡片类型
    await page.click('[data-testid="card-type-todo"]');

    // 验证窗口已创建
    await expect(page.locator('.card-window')).toBeVisible();

    // 输入标题
    await page.fill('[data-testid="card-title"]', 'My Todo');

    // 保存
    await page.click('[data-testid="save-btn"]');

    // 验证保存成功
    await expect(page.locator('.toast-success')).toBeVisible();
  });

  test('should switch layout', async ({ page }) => {
    await page.goto('http://localhost:3000');

    // 打开布局菜单
    await page.click('[data-testid="layout-menu"]');

    // 选择工作台布局
    await page.click('[data-testid="layout-workbench"]');

    // 验证布局已切换
    await expect(page.locator('.workbench-layout')).toBeVisible();
  });
});
```

**Playwright配置**
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

---

## 3. 核心功能测试用例

### 3.1 布局管理器测试

```typescript
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { LayoutManager } from '../src/engine/LayoutManager';

describe('LayoutManager', () => {
  let layoutManager: LayoutManager;
  let mockContext: LayoutContext;

  beforeEach(() => {
    mockContext = {
      kernel: mockKernel,
      windowManager: mockWindowManager,
      fileManager: mockFileManager,
      eventBus: new EventBus(),
      config: {},
    };

    const container = document.createElement('div');
    layoutManager = new LayoutManager(container, mockContext, mockContext.eventBus);
  });

  it('should scan layouts', async () => {
    const layouts = await layoutManager.scanLayouts();
    expect(layouts).toContain('infinite-canvas');
    expect(layouts).toContain('workbench');
  });

  it('should switch layout', async () => {
    await layoutManager.switchLayout('workbench');

    const currentLayout = layoutManager.getCurrentLayout();
    expect(currentLayout?.id).toBe('workbench');
  });

  it('should save layout state', async () => {
    await layoutManager.switchLayout('infinite-canvas');

    // 修改状态
    const layout = layoutManager.getCurrentLayout();
    // ... 修改布局状态

    // 切换到其他布局
    await layoutManager.switchLayout('workbench');

    // 切换回来
    await layoutManager.switchLayout('infinite-canvas');

    // 验证状态已恢复
    // ...
  });
});
```

---

### 3.2 窗口管理器测试

```typescript
describe('WindowManager', () => {
  let windowManager: WindowManager;

  beforeEach(() => {
    windowManager = new WindowManager(new EventBus());
  });

  it('should create window with default options', () => {
    const window = windowManager.createWindow({
      type: 'card',
    });

    expect(window.id).toBeDefined();
    expect(window.type).toBe('card');
    expect(window.position).toBeDefined();
    expect(window.size).toBeDefined();
  });

  it('should manage z-index correctly', () => {
    const window1 = windowManager.createWindow({ type: 'card' });
    const window2 = windowManager.createWindow({ type: 'card' });
    const window3 = windowManager.createWindow({ type: 'card' });

    // 聚焦window1
    windowManager.focusWindow(window1.id);

    const windows = windowManager.getWindows();
    const zIndexes = windows.map(w => w.zIndex);

    // 验证z-index顺序
    expect(zIndexes[0]).toBeLessThan(zIndexes[1]);
    expect(zIndexes[1]).toBeLessThan(zIndexes[2]);
  });

  it('should handle window close', () => {
    const window = windowManager.createWindow({ type: 'card' });

    windowManager.closeWindow(window.id);

    expect(windowManager.getWindow(window.id)).toBeUndefined();
  });

  it('should find window by file id', () => {
    const window = windowManager.createWindow({
      type: 'card',
      fileId: 'file123',
    });

    const found = windowManager.findWindowByFileId('file123');

    expect(found?.id).toBe(window.id);
  });
});
```

---

### 3.3 文件管理器测试

```typescript
describe('FileManager', () => {
  let fileManager: FileManager;

  beforeEach(async () => {
    const tempDir = await createTempDir();
    fileManager = new FileManager(tempDir, new EventBus());
    await fileManager.init();
  });

  afterEach(async () => {
    await cleanupTempDir();
  });

  it('should create file', async () => {
    const file = await fileManager.createFile('card', 'Test Card');

    expect(file.id).toBeDefined();
    expect(file.name).toBe('Test Card');
    expect(file.type).toBe('card');
  });

  it('should read file', async () => {
    const file = await fileManager.createFile('card', 'Test');

    const data = await fileManager.readFile(file.id);

    expect(data).toBeDefined();
  });

  it('should update file', async () => {
    const file = await fileManager.createFile('card', 'Test');

    await fileManager.updateFile(file.id, { title: 'Updated' });

    const updated = await fileManager.readFile(file.id);
    expect(updated.title).toBe('Updated');
  });

  it('should delete file', async () => {
    const file = await fileManager.createFile('card', 'Test');

    await fileManager.deleteFile(file.id);

    expect(fileManager.getFile(file.id)).toBeUndefined();
  });

  it('should search files', async () => {
    await fileManager.createFile('card', 'Todo List');
    await fileManager.createFile('card', 'Shopping List');
    await fileManager.createFile('card', 'Notes');

    const results = fileManager.searchFiles('list');

    expect(results).toHaveLength(2);
  });
});
```

---

### 3.4 拖拽系统测试

```typescript
import { fireEvent } from '@testing-library/react';

describe('DragDropHandler', () => {
  let dragDropHandler: DragDropHandler;

  beforeEach(() => {
    dragDropHandler = new DragDropHandler(new EventBus());
  });

  it('should register drop target', () => {
    const target: DropTarget = {
      id: 'canvas',
      accepts: ['card', 'file'],
      onDrop: vi.fn(),
    };

    dragDropHandler.registerDropTarget('canvas', target);

    // 验证已注册
    expect(dragDropHandler.getDropTarget('canvas')).toBe(target);
  });

  it('should handle drag start', () => {
    const source: DragSource = {
      id: 'card-1',
      type: 'card',
      data: { fileId: 'file123' },
    };

    const mockEvent = new MouseEvent('mousedown', {
      clientX: 100,
      clientY: 100,
    });

    dragDropHandler.startDrag(source, mockEvent);

    expect(dragDropHandler.iseDragging()).toBe(true);
  });

  it('should validate drop target', () => {
    const source: DragSource = {
      type: 'card',
      data: {},
    };

    const validTarget: DropTarget = {
      accepts: ['card'],
      onDrop: vi.fn(),
    };

    const invalidTarget: DropTarget = {
      accepts: ['file'],
      onDrop: vi.fn(),
    };

    expect(dragDropHandler.canDrop(source, validTarget)).toBe(true);
    expect(dragDropHandler.canDrop(source, invalidTarget)).toBe(false);
  });
});
```

**组件拖拽测试**
```typescript
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { DndContext } from '@dnd-kit/core';

describe('Card Drag & Drop', () => {
  it('should drag card to canvas', async () => {
    const user = userEvent.setup();
    const onDrop = vi.fn();

    render(
      <DndContext>
        <CardList />
        <Canvas onDrop={onDrop} />
      </DndContext>
    );

    const card = screen.getByTestId('card-todo');
    const canvas = screen.getByTestId('canvas');

    // 模拟拖拽
    await user.pointer([
      { keys: '[MouseLeft>]', target: card },
      { coords: { x: 100, y: 100 } },
      { coords: { x: 200, y: 200 }, target: canvas },
      { keys: '[/MouseLeft]' },
    ]);

    expect(onDrop).toHaveBeenCalled();
  });
});
```

---

### 3.5 保存管理器测试

```typescript
describe('SaveManager', () => {
  let saveManager: SaveManager;
  let fileManager: FileManager;

  beforeEach(() => {
    fileManager = new FileManager('./temp', new EventBus());
    saveManager = new SaveManager(fileManager, new EventBus());
  });

  it('should mark file as dirty', () => {
    saveManager.markDirty('file123');

    expect(saveManager.isDirty('file123')).toBe(true);
  });

  it('should auto-save dirty files', async () => {
    vi.useFakeTimers();

    saveManager.markDirty('file123');
    saveManager.start();

    // 等待自动保存间隔
    vi.advanceTimersByTime(5000);

    await vi.runAllTimersAsync();

    expect(saveManager.isDirty('file123')).toBe(false);

    vi.useRealTimers();
  });

  it('should save immediately', async () => {
    saveManager.markDirty('file123');

    await saveManager.saveNow('file123');

    expect(saveManager.isDirty('file123')).toBe(false);
  });
});
```

---

## 4. 测试覆盖率要求

### 4.1 覆盖率目标

**核心模块**
- EditorEngine: 85%+
- LayoutManager: 85%+
- WindowManager: 90%+
- FileManager: 90%+
- DragDropHandler: 85%+
- SaveManager: 90%+

**UI组件**
- 布局组件: 80%+
- 窗口组件: 85%+
- 工具组件: 75%+

**工具函数**
- 工具函数: 90%+

### 4.2 生成覆盖率报告

```bash
# 使用Vitest
npm run test:coverage

# 使用Jest
npm run test -- --coverage

# 查看HTML报告
open coverage/index.html
```

---

## 5. CI/CD集成

### 5.1 GitHub Actions配置

```yaml
# .github/workflows/test.yml
name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18, 20]
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linter
        run: npm run lint
      
      - name: Run type check
        run: npm run type-check
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Run component tests
        run: npm run test:component
      
      - name: Generate coverage
        run: npm run test:coverage
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
  
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 18
      - run: npm ci
      - run: npx playwright install --with-deps
      - run: npm run test:e2e
      - uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
```

---

## 6. Mock策略

### 6.1 Mock内核API

```typescript
import { vi } from 'vitest';

export const createMockKernel = () => ({
  route: vi.fn().mockResolvedValue({
    status: 200,
    data: {},
  }),
  subscribe: vi.fn(),
  unsubscribe: vi.fn(),
  getModule: vi.fn(),
});
```

### 6.2 Mock文件系统

```typescript
import { vi } from 'vitest';

vi.mock('fs-extra', () => ({
  readFile: vi.fn().mockResolvedValue('file content'),
  writeFile: vi.fn().mockResolvedValue(undefined),
  exists: vi.fn().mockResolvedValue(true),
  remove: vi.fn().mockResolvedValue(undefined),
}));
```

### 6.3 Mock事件总线

```typescript
export const createMockEventBus = () => ({
  on: vi.fn(),
  off: vi.fn(),
  emit: vi.fn(),
  once: vi.fn(),
});
```

---

## 7. 性能测试

### 7.1 渲染性能测试

```typescript
import { render } from '@testing-library/react';
import { performance } from 'perf_hooks';

describe('Rendering Performance', () => {
  it('should render 100 windows in under 1 second', () => {
    const start = performance.now();

    render(
      <Canvas>
        {Array.from({ length: 100 }, (_, i) => (
          <CardWindow key={i} id={`window-${i}`} />
        ))}
      </Canvas>
    );

    const end = performance.now();
    const duration = end - start;

    expect(duration).toBeLessThan(1000);
  });
});
```

### 7.2 内存泄漏测试

```typescript
describe('Memory Leaks', () => {
  it('should cleanup windows properly', () => {
    const windowManager = new WindowManager(new EventBus());

    // 创建100个窗口
    for (let i = 0; i < 100; i++) {
      windowManager.createWindow({ type: 'card' });
    }

    const initialMemory = process.memoryUsage().heapUsed;

    // 关闭所有窗口
    windowManager.destroyAll();

    // 强制垃圾回收（需要--expose-gc）
    if (global.gc) {
      global.gc();
    }

    const finalMemory = process.memoryUsage().heapUsed;

    // 内存应该释放
    expect(finalMemory).toBeLessThanOrEqual(initialMemory * 1.1);
  });
});
```

---

## 8. 测试最佳实践

### 8.1 测试命名

```typescript
// 好的命名
it('should create window when createWindow is called with valid options', () => {});

// 不好的命名
it('test1', () => {});
```

### 8.2 AAA模式

```typescript
it('should focus window', () => {
  // Arrange (准备)
  const windowManager = new WindowManager(new EventBus());
  const window = windowManager.createWindow({ type: 'card' });

  // Act (执行)
  windowManager.focusWindow(window.id);

  // Assert (断言)
  expect(windowManager.getFocusedWindow()?.id).toBe(window.id);
});
```

### 8.3 测试隔离

```typescript
describe('WindowManager', () => {
  let windowManager: WindowManager;

  beforeEach(() => {
    // 每个测试前重新创建
    windowManager = new WindowManager(new EventBus());
  });

  afterEach(() => {
    // 清理
    windowManager.destroyAll();
  });
});
```

---

## 9. 测试脚本

```json
{
  "scripts": {
    "test": "vitest",
    "test:unit": "vitest run --dir tests/unit",
    "test:component": "vitest run --dir tests/component",
    "test:integration": "vitest run --dir tests/integration",
    "test:e2e": "playwright test",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest watch",
    "test:ui": "vitest --ui"
  }
}
```

---

完善的测试体系确保编辑引擎的质量和稳定性,覆盖所有核心功能和交互场景。
