# 卡片编辑引擎 - 代码结构

## 1. 项目结构

```
chips-editor/
├── src/                          # 源代码
│   ├── engine/                   # 编辑引擎核心
│   ├── kernel/                   # 内核
│   ├── layouts/                  # 布局插件
│   ├── plugins/                  # 其他插件
│   ├── ui/                       # UI 组件
│   ├── types/                    # 类型定义
│   ├── utils/                    # 工具函数
│   └── index.ts                  # 入口文件
│
├── plugins/                      # 外部插件(可选)
│   ├── editors/                  # 编辑组件插件
│   ├── renderers/                # 渲染器插件
│   └── themes/                   # 主题插件
│
├── public/                       # 公共资源
│   ├── assets/                   # 静态资源
│   └── index.html                # HTML 模板
│
├── tests/                        # 测试
│   ├── unit/                     # 单元测试
│   ├── integration/              # 集成测试
│   └── e2e/                      # 端到端测试
│
├── docs/                         # 文档
│   ├── api/                      # API 文档
│   ├── guides/                   # 指南
│   └── examples/                 # 示例
│
├── scripts/                      # 脚本
│   ├── build.js                  # 构建脚本
│   └── dev.js                    # 开发脚本
│
├── dist/                         # 构建输出(生成)
├── node_modules/                 # 依赖(生成)
├── package.json                  # 项目配置
├── tsconfig.json                 # TypeScript 配置
├── webpack.config.js             # Webpack 配置
├── .eslintrc.js                  # ESLint 配置
├── .prettierrc                   # Prettier 配置
├── .gitignore                    # Git 忽略文件
└── README.md                     # 项目说明
```

## 2. 核心模块详细结构

### 2.1 engine/ 编辑引擎

```
src/engine/
├── EditorEngine.ts               # 主引擎类
├── LayoutManager.ts              # 布局管理器
├── WindowManager.ts              # 窗口管理器
├── FileManager.ts                # 文件管理器
├── DragDropHandler.ts            # 拖拽处理器
├── SaveManager.ts                # 保存管理器
├── EventBus.ts                   # 事件总线
└── index.ts                      # 模块导出
```

### 2.2 kernel/ 内核

```
src/kernel/
├── Kernel.ts                     # 内核主类
├── PluginLoader.ts               # 插件加载器
├── FileRecognizer.ts             # 文件识别器
├── DataProcessor.ts              # 数据处理器
├── ResourceManager.ts            # 资源管理器
├── ConfigManager.ts              # 配置管理器
├── Router.ts                     # 路由器
└── index.ts                      # 模块导出
```

### 2.3 layouts/ 布局插件

```
src/layouts/
├── infinite-canvas/              # 无限画布布局
│   ├── InfiniteCanvasLayout.ts  # 布局主类
│   ├── DesktopLayer.ts           # 桌面层
│   ├── WindowLayer.ts            # 窗口层
│   ├── ZoomController.ts         # 缩放控制器
│   ├── components/               # React 组件
│   │   ├── CardWindow.tsx
│   │   ├── ToolWindow.tsx
│   │   ├── Dock.tsx
│   │   └── ZoomSlider.tsx
│   ├── styles/                   # 样式
│   │   └── infinite-canvas.css
│   └── manifest.json             # 插件元数据
│
└── workbench/                    # 工作台布局
    ├── WorkbenchLayout.ts
    ├── Sidebar.ts
    ├── PreviewArea.ts
    ├── EditPanel.ts
    ├── components/
    │   ├── FileTree.tsx
    │   ├── TabBar.tsx
    │   └── Splitter.tsx
    ├── styles/
    │   └── workbench.css
    └── manifest.json
```

### 2.4 plugins/ 插件

```
src/plugins/
├── editors/                      # 编辑组件插件
│   ├── rich-text/
│   │   ├── RichTextEditor.ts
│   │   └── manifest.json
│   ├── markdown/
│   │   ├── MarkdownEditor.ts
│   │   └── manifest.json
│   └── image/
│       ├── ImageEditor.ts
│       └── manifest.json
│
├── renderers/                    # 渲染器插件
│   ├── rich-text/
│   │   ├── RichTextRenderer.ts
│   │   └── manifest.json
│   └── markdown/
│       ├── MarkdownRenderer.ts
│       └── manifest.json
│
└── themes/                       # 主题插件
    ├── default/
    │   ├── theme.css
    │   └── manifest.json
    └── dark/
        ├── theme.css
        └── manifest.json
```

### 2.5 ui/ UI 组件

```
src/ui/
├── components/                   # 通用组件
│   ├── Button.tsx
│   ├── Input.tsx
│   ├── Dialog.tsx
│   ├── Toast.tsx
│   ├── ContextMenu.tsx
│   └── index.ts
│
├── layouts/                      # 布局组件
│   ├── Flex.tsx
│   ├── Grid.tsx
│   └── index.ts
│
├── styles/                       # 全局样式
│   ├── variables.css             # CSS 变量
│   ├── reset.css                 # 样式重置
│   ├── global.css                # 全局样式
│   └── themes/                   # 主题
│       ├── light.css
│       └── dark.css
│
└── utils/                        # UI 工具
    ├── hooks.ts                  # React Hooks
    ├── animations.ts             # 动画工具
    └── index.ts
```

### 2.6 types/ 类型定义

```
src/types/
├── engine.ts                     # 引擎相关类型
├── kernel.ts                     # 内核相关类型
├── plugins.ts                    # 插件相关类型
├── window.ts                     # 窗口相关类型
├── file.ts                       # 文件相关类型
├── events.ts                     # 事件相关类型
└── index.ts                      # 类型导出
```

### 2.7 utils/ 工具函数

```
src/utils/
├── id.ts                         # ID 生成
├── file.ts                       # 文件操作工具
├── dom.ts                        # DOM 操作工具
├── date.ts                       # 日期工具
├── string.ts                     # 字符串工具
├── debounce.ts                   # 防抖
├── throttle.ts                   # 节流
├── logger.ts                     # 日志工具
└── index.ts                      # 工具导出
```

## 3. 配置文件

### 3.1 package.json

```json
{
  "name": "chips-editor",
  "version": "1.0.0",
  "description": "Chips Card Editor Engine",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "scripts": {
    "dev": "webpack serve --mode development",
    "build": "webpack --mode production",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint": "eslint src --ext .ts,.tsx",
    "lint:fix": "eslint src --ext .ts,.tsx --fix",
    "type-check": "tsc --noEmit"
  },
  "dependencies": {
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "zustand": "^4.0.0",
    "fs-extra": "^11.0.0",
    "chokidar": "^3.5.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/node": "^18.0.0",
    "typescript": "^5.0.0",
    "webpack": "^5.0.0",
    "webpack-cli": "^5.0.0",
    "webpack-dev-server": "^4.0.0",
    "ts-loader": "^9.0.0",
    "@typescript-eslint/eslint-plugin": "^5.0.0",
    "@typescript-eslint/parser": "^5.0.0",
    "eslint": "^8.0.0",
    "prettier": "^2.0.0",
    "jest": "^29.0.0",
    "@testing-library/react": "^13.0.0"
  }
}
```

### 3.2 tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "ESNext",
    "lib": ["ES2020", "DOM", "DOM.Iterable"],
    "jsx": "react",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "removeComments": true,
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "moduleResolution": "node",
    "allowSyntheticDefaultImports": true,
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"],
      "@engine/*": ["src/engine/*"],
      "@kernel/*": ["src/kernel/*"],
      "@ui/*": ["src/ui/*"],
      "@types/*": ["src/types/*"],
      "@utils/*": ["src/utils/*"]
    }
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

### 3.3 webpack.config.js

```javascript
const path = require('path');
const HtmlWebpackPlugin = require('html-webpack-plugin');

module.exports = {
  entry: './src/index.ts',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'chips-editor.js',
    library: 'ChipsEditor',
    libraryTarget: 'umd',
    clean: true,
  },
  resolve: {
    extensions: ['.ts', '.tsx', '.js', '.jsx'],
    alias: {
      '@': path.resolve(__dirname, 'src'),
      '@engine': path.resolve(__dirname, 'src/engine'),
      '@kernel': path.resolve(__dirname, 'src/kernel'),
      '@ui': path.resolve(__dirname, 'src/ui'),
      '@types': path.resolve(__dirname, 'src/types'),
      '@utils': path.resolve(__dirname, 'src/utils'),
    },
  },
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        use: 'ts-loader',
        exclude: /node_modules/,
      },
      {
        test: /\.css$/,
        use: ['style-loader', 'css-loader'],
      },
    ],
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: 'public/index.html',
    }),
  ],
  devServer: {
    static: './dist',
    hot: true,
    port: 3000,
  },
};
```

### 3.4 .eslintrc.js

```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  extends: [
    'eslint:recommended',
    'plugin:@typescript-eslint/recommended',
    'plugin:react/recommended',
  ],
  plugins: ['@typescript-eslint', 'react'],
  rules: {
    '@typescript-eslint/no-explicit-any': 'warn',
    '@typescript-eslint/no-unused-vars': 'error',
    'react/prop-types': 'off',
  },
  settings: {
    react: {
      version: 'detect',
    },
  },
};
```

### 3.5 jest.config.js

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts', '**/*.test.tsx'],
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@engine/(.*)$': '<rootDir>/src/engine/$1',
    '^@kernel/(.*)$': '<rootDir>/src/kernel/$1',
    '^@ui/(.*)$': '<rootDir>/src/ui/$1',
    '^@types/(.*)$': '<rootDir>/src/types/$1',
    '^@utils/(.*)$': '<rootDir>/src/utils/$1',
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/**/index.ts',
  ],
};
```

## 4. 入口文件

### 4.1 src/index.ts

```typescript
// 核心导出
export { EditorEngine } from './engine/EditorEngine';
export { EventBus } from './engine/EventBus';

// 类型导出
export type {
  // 引擎类型
  Window,
  WindowType,
  WindowState,
  File,
  FileType,
  
  // 插件类型
  LayoutPlugin,
  EditorPlugin,
  RendererPlugin,
  
  // 配置类型
  EditorConfig,
  LayoutContext,
  
  // 事件类型
  EventHandler,
} from './types';

// 工具导出
export {
  generateId,
  debounce,
  throttle,
} from './utils';

// 默认导出
export { EditorEngine as default } from './engine/EditorEngine';
```

### 4.2 使用示例

```typescript
import EditorEngine, { WindowType } from 'chips-editor';

// 创建编辑引擎实例
const container = document.getElementById('app')!;
const editor = new EditorEngine(container, {
  basePath: './data',
  defaultLayout: 'infinite-canvas',
});

// 初始化
await editor.init();

// 创建文件
const file = await editor.createFile('card', 'My First Card');

// 打开文件
await editor.openFile(file.id);

// 监听事件
editor.on('file:opened', (file) => {
  console.log('File opened:', file);
});

// 切换布局
await editor.switchLayout('workbench');
```

## 5. 代码规范

### 5.1 命名规范

- **类名**: PascalCase (如 `EditorEngine`)
- **接口名**: PascalCase (如 `LayoutPlugin`)
- **函数名**: camelCase (如 `createWindow`)
- **变量名**: camelCase (如 `windowManager`)
- **常量名**: UPPER_SNAKE_CASE (如 `MAX_WINDOWS`)
- **私有成员**: 前缀 `_` 或使用 `private` 关键字

### 5.2 文件命名

- **组件文件**: PascalCase.tsx (如 `CardWindow.tsx`)
- **类文件**: PascalCase.ts (如 `WindowManager.ts`)
- **工具文件**: camelCase.ts (如 `debounce.ts`)
- **类型文件**: camelCase.ts (如 `window.ts`)

### 5.3 代码风格

- 使用 2 空格缩进
- 使用单引号
- 语句结尾使用分号
- 每行最大长度 100 字符
- 使用 Prettier 格式化

### 5.4 注释规范

```typescript
/**
 * 创建新窗口
 * @param options 窗口选项
 * @returns 创建的窗口对象
 */
createWindow(options: CreateWindowOptions): Window {
  // 实现...
}
```

## 6. Git 工作流

### 6.1 分支策略

- `main`: 主分支,稳定版本
- `develop`: 开发分支
- `feature/*`: 功能分支
- `bugfix/*`: 修复分支
- `release/*`: 发布分支

### 6.2 提交规范

```
type(scope): subject

body

footer
```

**类型**:
- `feat`: 新功能
- `fix`: 修复
- `docs`: 文档
- `style`: 格式
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具

**示例**:
```
feat(window): add window resize support

Add resize handles to windows and implement resize logic

Closes #123
```

## 7. 构建和部署

### 7.1 开发环境

```bash
# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 类型检查
npm run type-check

# 代码检查
npm run lint
```

### 7.2 生产构建

```bash
# 构建
npm run build

# 生成产物
dist/
├── chips-editor.js
├── chips-editor.js.map
├── index.d.ts
└── types/
```

### 7.3 测试

```bash
# 运行测试
npm test

# 监听模式
npm run test:watch

# 覆盖率报告
npm run test:coverage
```

## 8. 总结

代码结构的设计要点:

1. **清晰的目录组织**: 按功能模块划分目录
2. **模块化**: 每个模块职责单一,便于维护
3. **类型安全**: 使用 TypeScript,定义完整类型
4. **配置化**: 通过配置文件管理项目设置
5. **工具链**: 使用现代化的开发工具
6. **规范化**: 统一的代码规范和提交规范
7. **文档化**: 完善的文档和注释

通过良好的代码结构,项目易于理解、开发和维护,团队协作更加高效。
