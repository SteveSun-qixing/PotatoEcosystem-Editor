# Phase4 - æ— é™ç”»å¸ƒå¸ƒå±€

**å‘¨æœŸ**: 2 å‘¨  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**ä¾èµ–**: Phase3  
**çŠ¶æ€**: å¾…å¼€å‘

---

## 1. é˜¶æ®µç›®æ ‡

å®ç°ç¼–è¾‘å™¨çš„æ ¸å¿ƒå¸ƒå±€ â€”â€” æ— é™ç”»å¸ƒå¸ƒå±€ï¼š
- ä¸¤å±‚ç•Œé¢è®¾è®¡ï¼ˆæ¡Œé¢å±‚ + çª—å£å±‚ï¼‰
- æ— é™ç”»å¸ƒåŠŸèƒ½ï¼ˆç¼©æ”¾ã€å¹³ç§»ï¼‰
- ç½‘æ ¼èƒŒæ™¯
- ç¼©æ”¾æ§åˆ¶å™¨
- çª—å£å±‚å·¥å…·çª—å£ç®¡ç†

---

## 2. ä»»åŠ¡åˆ—è¡¨

### 2.1 åˆ›å»ºæ— é™ç”»å¸ƒä¸»ç»„ä»¶

**ä»»åŠ¡ ID**: P4-T01  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 4h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/InfiniteCanvas.vue`

```vue
<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, provide } from 'vue';
import DesktopLayer from './DesktopLayer.vue';
import WindowLayer from './WindowLayer.vue';
import ZoomControl from './ZoomControl.vue';
import { useUIStore } from '@/core/state';
import { useCanvasControls } from './use-canvas';

const uiStore = useUIStore();

// ç”»å¸ƒå®¹å™¨å¼•ç”¨
const canvasRef = ref<HTMLElement | null>(null);

// ä½¿ç”¨ç”»å¸ƒæ§åˆ¶ hook
const {
  zoom,
  panX,
  panY,
  handleWheel,
  handleMouseDown,
  handleMouseMove,
  handleMouseUp,
  zoomIn,
  zoomOut,
  zoomTo,
  resetView,
  fitToContent,
} = useCanvasControls();

// æ¡Œé¢å±‚æ ·å¼ï¼ˆåº”ç”¨ç¼©æ”¾å’Œå¹³ç§»ï¼‰
const desktopStyle = computed(() => ({
  transform: `translate(${panX.value}px, ${panY.value}px) scale(${zoom.value})`,
  transformOrigin: '0 0',
}));

// ç½‘æ ¼æ ·å¼
const gridStyle = computed(() => {
  const gridSize = 20 * zoom.value;
  return {
    backgroundSize: `${gridSize}px ${gridSize}px`,
    backgroundPosition: `${panX.value % gridSize}px ${panY.value % gridSize}px`,
  };
});

// æä¾›ç»™å­ç»„ä»¶çš„ä¸Šä¸‹æ–‡
provide('canvas', {
  zoom,
  panX,
  panY,
  zoomIn,
  zoomOut,
  resetView,
});

// ç›‘å¬é”®ç›˜å¿«æ·é”®
function handleKeyDown(e: KeyboardEvent) {
  // Ctrl/Cmd + 0: é‡ç½®è§†å›¾
  if ((e.ctrlKey || e.metaKey) && e.key === '0') {
    e.preventDefault();
    resetView();
  }
  // Ctrl/Cmd + +: æ”¾å¤§
  if ((e.ctrlKey || e.metaKey) && e.key === '=') {
    e.preventDefault();
    zoomIn();
  }
  // Ctrl/Cmd + -: ç¼©å°
  if ((e.ctrlKey || e.metaKey) && e.key === '-') {
    e.preventDefault();
    zoomOut();
  }
}

onMounted(() => {
  document.addEventListener('keydown', handleKeyDown);
});

onUnmounted(() => {
  document.removeEventListener('keydown', handleKeyDown);
});
</script>

<template>
  <div
    ref="canvasRef"
    class="infinite-canvas"
    @wheel.prevent="handleWheel"
    @mousedown="handleMouseDown"
    @mousemove="handleMouseMove"
    @mouseup="handleMouseUp"
    @mouseleave="handleMouseUp"
  >
    <!-- ç½‘æ ¼èƒŒæ™¯ -->
    <div
      v-if="uiStore.showGrid"
      class="infinite-canvas__grid"
      :style="gridStyle"
    />

    <!-- æ¡Œé¢å±‚ -->
    <DesktopLayer :style="desktopStyle">
      <slot name="desktop" />
    </DesktopLayer>

    <!-- çª—å£å±‚ï¼ˆä¸å—ç¼©æ”¾å½±å“ï¼‰ -->
    <WindowLayer>
      <slot name="window" />
    </WindowLayer>

    <!-- ç¼©æ”¾æ§åˆ¶å™¨ -->
    <ZoomControl
      :zoom="zoom"
      @zoom-in="zoomIn"
      @zoom-out="zoomOut"
      @zoom-to="zoomTo"
      @reset="resetView"
      @fit="fitToContent"
    />
  </div>
</template>

<style scoped>
.infinite-canvas {
  position: relative;
  width: 100%;
  height: 100%;
  overflow: hidden;
  background: var(--chips-color-background, #fafafa);
  cursor: grab;
}

.infinite-canvas:active {
  cursor: grabbing;
}

.infinite-canvas__grid {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  background-image:
    linear-gradient(to right, var(--chips-color-border, #e0e0e0) 1px, transparent 1px),
    linear-gradient(to bottom, var(--chips-color-border, #e0e0e0) 1px, transparent 1px);
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç”»å¸ƒç»„ä»¶ç»“æ„æ­£ç¡®
- [ ] ä¸¤å±‚è®¾è®¡å®ç°
- [ ] ç½‘æ ¼èƒŒæ™¯æ˜¾ç¤º
- [ ] å¿«æ·é”®æ”¯æŒ

---

### 2.2 åˆ›å»ºç”»å¸ƒæ§åˆ¶ Hook

**ä»»åŠ¡ ID**: P4-T02  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 4h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/use-canvas.ts`

```typescript
import { ref, watch, computed } from 'vue';
import { useUIStore } from '@/core/state';

interface CanvasControlsOptions {
  minZoom?: number;
  maxZoom?: number;
  zoomStep?: number;
  smoothZoom?: boolean;
}

/**
 * ç”»å¸ƒæ§åˆ¶ Hook
 * æä¾›ç¼©æ”¾ã€å¹³ç§»ç­‰ç”»å¸ƒæ“ä½œ
 */
export function useCanvasControls(options: CanvasControlsOptions = {}) {
  const {
    minZoom = 0.1,
    maxZoom = 5,
    zoomStep = 0.1,
    smoothZoom = true,
  } = options;

  const uiStore = useUIStore();

  // çŠ¶æ€
  const zoom = ref(uiStore.canvas.zoom);
  const panX = ref(uiStore.canvas.panX);
  const panY = ref(uiStore.canvas.panY);
  const isPanning = ref(false);
  const panStart = ref({ x: 0, y: 0 });
  const panOrigin = ref({ x: 0, y: 0 });

  // åŒæ­¥åˆ° store
  watch([zoom, panX, panY], () => {
    uiStore.updateCanvas({
      zoom: zoom.value,
      panX: panX.value,
      panY: panY.value,
    });
  });

  // ç¼©æ”¾ç™¾åˆ†æ¯”
  const zoomPercent = computed(() => Math.round(zoom.value * 100));

  /**
   * å¤„ç†é¼ æ ‡æ»šè½®ç¼©æ”¾
   */
  function handleWheel(e: WheelEvent) {
    const delta = e.deltaY > 0 ? -zoomStep : zoomStep;
    const newZoom = Math.max(minZoom, Math.min(maxZoom, zoom.value + delta));

    if (smoothZoom) {
      // ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
      const rect = (e.currentTarget as HTMLElement).getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // è®¡ç®—ç¼©æ”¾å‰åçš„ä¸–ç•Œåæ ‡å·®å¼‚
      const worldX = (mouseX - panX.value) / zoom.value;
      const worldY = (mouseY - panY.value) / zoom.value;

      zoom.value = newZoom;

      // è°ƒæ•´å¹³ç§»ä»¥ä¿æŒé¼ æ ‡ä½ç½®ä¸å˜
      panX.value = mouseX - worldX * newZoom;
      panY.value = mouseY - worldY * newZoom;
    } else {
      zoom.value = newZoom;
    }
  }

  /**
   * å¤„ç†é¼ æ ‡æŒ‰ä¸‹ï¼ˆå¼€å§‹å¹³ç§»ï¼‰
   */
  function handleMouseDown(e: MouseEvent) {
    // åªå“åº”é¼ æ ‡ä¸­é”®æˆ–æŒ‰ä½ç©ºæ ¼é”®æ—¶çš„å·¦é”®
    if (e.button === 1 || (e.button === 0 && e.target === e.currentTarget)) {
      isPanning.value = true;
      panStart.value = { x: e.clientX, y: e.clientY };
      panOrigin.value = { x: panX.value, y: panY.value };
      e.preventDefault();
    }
  }

  /**
   * å¤„ç†é¼ æ ‡ç§»åŠ¨ï¼ˆå¹³ç§»ä¸­ï¼‰
   */
  function handleMouseMove(e: MouseEvent) {
    if (!isPanning.value) return;

    const deltaX = e.clientX - panStart.value.x;
    const deltaY = e.clientY - panStart.value.y;

    panX.value = panOrigin.value.x + deltaX;
    panY.value = panOrigin.value.y + deltaY;
  }

  /**
   * å¤„ç†é¼ æ ‡æŠ¬èµ·ï¼ˆç»“æŸå¹³ç§»ï¼‰
   */
  function handleMouseUp() {
    isPanning.value = false;
  }

  /**
   * æ”¾å¤§
   */
  function zoomIn() {
    zoom.value = Math.min(maxZoom, zoom.value + zoomStep);
  }

  /**
   * ç¼©å°
   */
  function zoomOut() {
    zoom.value = Math.max(minZoom, zoom.value - zoomStep);
  }

  /**
   * ç¼©æ”¾åˆ°æŒ‡å®šå€¼
   */
  function zoomTo(value: number) {
    zoom.value = Math.max(minZoom, Math.min(maxZoom, value));
  }

  /**
   * é‡ç½®è§†å›¾
   */
  function resetView() {
    zoom.value = 1;
    panX.value = 0;
    panY.value = 0;
  }

  /**
   * é€‚åº”å†…å®¹
   */
  function fitToContent(contentBounds?: { x: number; y: number; width: number; height: number }) {
    if (!contentBounds) {
      resetView();
      return;
    }

    // è®¡ç®—é€‚åº”è§†å£çš„ç¼©æ”¾æ¯”ä¾‹
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    const padding = 50;

    const scaleX = (viewportWidth - padding * 2) / contentBounds.width;
    const scaleY = (viewportHeight - padding * 2) / contentBounds.height;
    const newZoom = Math.min(scaleX, scaleY, 1);

    zoom.value = Math.max(minZoom, Math.min(maxZoom, newZoom));

    // å±…ä¸­å†…å®¹
    panX.value = (viewportWidth - contentBounds.width * zoom.value) / 2 - contentBounds.x * zoom.value;
    panY.value = (viewportHeight - contentBounds.height * zoom.value) / 2 - contentBounds.y * zoom.value;
  }

  /**
   * å¹³ç§»åˆ°æŒ‡å®šä½ç½®
   */
  function panTo(x: number, y: number) {
    panX.value = x;
    panY.value = y;
  }

  /**
   * å°†å±å¹•åæ ‡è½¬æ¢ä¸ºä¸–ç•Œåæ ‡
   */
  function screenToWorld(screenX: number, screenY: number): { x: number; y: number } {
    return {
      x: (screenX - panX.value) / zoom.value,
      y: (screenY - panY.value) / zoom.value,
    };
  }

  /**
   * å°†ä¸–ç•Œåæ ‡è½¬æ¢ä¸ºå±å¹•åæ ‡
   */
  function worldToScreen(worldX: number, worldY: number): { x: number; y: number } {
    return {
      x: worldX * zoom.value + panX.value,
      y: worldY * zoom.value + panY.value,
    };
  }

  return {
    // çŠ¶æ€
    zoom,
    panX,
    panY,
    isPanning,
    zoomPercent,
    
    // äº‹ä»¶å¤„ç†
    handleWheel,
    handleMouseDown,
    handleMouseMove,
    handleMouseUp,
    
    // æ§åˆ¶æ–¹æ³•
    zoomIn,
    zoomOut,
    zoomTo,
    resetView,
    fitToContent,
    panTo,
    
    // å·¥å…·æ–¹æ³•
    screenToWorld,
    worldToScreen,
  };
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç¼©æ”¾åŠŸèƒ½æ­£å¸¸
- [ ] å¹³ç§»åŠŸèƒ½æ­£å¸¸
- [ ] ä»¥é¼ æ ‡ä½ç½®ä¸ºä¸­å¿ƒç¼©æ”¾
- [ ] åæ ‡è½¬æ¢æ­£ç¡®

---

### 2.3 åˆ›å»ºæ¡Œé¢å±‚ç»„ä»¶

**ä»»åŠ¡ ID**: P4-T03  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 3h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/DesktopLayer.vue`

```vue
<script setup lang="ts">
import { computed, inject } from 'vue';
import { CardWindow, ToolWindow } from '@/components/window';
import { useUIStore, useCardStore } from '@/core/state';
import { useWindowManager } from '@/core/window-manager';
import type { CardWindowConfig, ToolWindowConfig } from '@/types';

const uiStore = useUIStore();
const cardStore = useCardStore();
const windowManager = useWindowManager();

// è·å–å¡ç‰‡çª—å£ï¼ˆåœ¨æ¡Œé¢å±‚æ˜¾ç¤ºï¼‰
const cardWindows = computed(() => uiStore.cardWindows);

// å¤„ç†å¡ç‰‡çª—å£æ›´æ–°
function handleCardWindowUpdate(windowId: string, updates: Partial<CardWindowConfig>) {
  windowManager.updateWindow(windowId, updates);
}

// å¤„ç†å¡ç‰‡çª—å£å…³é—­
function handleCardWindowClose(windowId: string, cardId: string) {
  // ä» UI store ç§»é™¤çª—å£
  windowManager.closeWindow(windowId);
  // è¯¢é—®æ˜¯å¦ä¿å­˜å¡ç‰‡
  // TODO: å¦‚æœæœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œå¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
}

// å¤„ç†å¡ç‰‡çª—å£èšç„¦
function handleCardWindowFocus(windowId: string, cardId: string) {
  windowManager.focusWindow(windowId);
  cardStore.setActiveCard(cardId);
}
</script>

<template>
  <div class="desktop-layer">
    <!-- å¡ç‰‡çª—å£ -->
    <CardWindow
      v-for="window in cardWindows"
      :key="window.id"
      :config="window"
      @update:config="(updates) => handleCardWindowUpdate(window.id, updates)"
      @close="handleCardWindowClose(window.id, window.cardId)"
      @focus="handleCardWindowFocus(window.id, window.cardId)"
    />

    <!-- å…¶ä»–æ¡Œé¢å†…å®¹æ’æ§½ -->
    <slot />
  </div>
</template>

<style scoped>
.desktop-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 0;
  height: 0;
  /* æ¡Œé¢å±‚æœ¬èº«ä¸å ç©ºé—´ï¼Œå†…å®¹é€šè¿‡ç»å¯¹å®šä½æ”¾ç½® */
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æ¡Œé¢å±‚æ­£ç¡®æ¸²æŸ“
- [ ] å¡ç‰‡çª—å£æ˜¾ç¤ºæ­£å¸¸
- [ ] çª—å£äº‹ä»¶å¤„ç†æ­£å¸¸

---

### 2.4 åˆ›å»ºçª—å£å±‚ç»„ä»¶

**ä»»åŠ¡ ID**: P4-T04  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 3h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/WindowLayer.vue`

```vue
<script setup lang="ts">
import { computed, ref } from 'vue';
import { ToolWindow } from '@/components/window';
import Dock from '@/components/dock/Dock.vue';
import { useUIStore } from '@/core/state';
import { useWindowManager } from '@/core/window-manager';
import type { ToolWindowConfig } from '@/types';

const uiStore = useUIStore();
const windowManager = useWindowManager();

// è·å–å·¥å…·çª—å£ï¼ˆåœ¨çª—å£å±‚æ˜¾ç¤ºï¼Œä¸æœ€å°åŒ–çš„ï¼‰
const toolWindows = computed(() => 
  uiStore.toolWindows.filter(w => w.state !== 'minimized')
);

// æœ€å°åŒ–çš„å·¥å…·çª—å£ï¼ˆæ˜¾ç¤ºåœ¨ç¨‹åºåï¼‰
const minimizedTools = computed(() => 
  uiStore.toolWindows.filter(w => w.state === 'minimized')
);

// å¤„ç†å·¥å…·çª—å£æ›´æ–°
function handleToolWindowUpdate(windowId: string, updates: Partial<ToolWindowConfig>) {
  windowManager.updateWindow(windowId, updates);
}

// å¤„ç†å·¥å…·çª—å£å…³é—­
function handleToolWindowClose(windowId: string) {
  windowManager.closeWindow(windowId);
}

// å¤„ç†å·¥å…·çª—å£èšç„¦
function handleToolWindowFocus(windowId: string) {
  windowManager.focusWindow(windowId);
}

// ä»ç¨‹åºåæ¢å¤å·¥å…·çª—å£
function handleRestoreTool(toolId: string) {
  uiStore.restoreTool(toolId);
}
</script>

<template>
  <div class="window-layer">
    <!-- å·¥å…·çª—å£ -->
    <ToolWindow
      v-for="window in toolWindows"
      :key="window.id"
      :config="window"
      @update:config="(updates) => handleToolWindowUpdate(window.id, updates)"
      @close="handleToolWindowClose(window.id)"
      @focus="handleToolWindowFocus(window.id)"
    >
      <!-- åŠ¨æ€ç»„ä»¶æ’æ§½ -->
      <component :is="window.component" v-if="window.component" />
    </ToolWindow>

    <!-- å…¶ä»–çª—å£å±‚å†…å®¹æ’æ§½ -->
    <slot />

    <!-- ç¨‹åºå -->
    <Dock
      :minimized-tools="minimizedTools"
      @restore-tool="handleRestoreTool"
    />
  </div>
</template>

<style scoped>
.window-layer {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.window-layer > :deep(*) {
  pointer-events: auto;
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] çª—å£å±‚æ­£ç¡®æ¸²æŸ“
- [ ] å·¥å…·çª—å£æ˜¾ç¤ºæ­£å¸¸
- [ ] çª—å£å±‚ä¸å—ç”»å¸ƒç¼©æ”¾å½±å“
- [ ] ç¨‹åºåé›†æˆæ­£å¸¸

---

### 2.5 åˆ›å»ºç¼©æ”¾æ§åˆ¶å™¨ç»„ä»¶

**ä»»åŠ¡ ID**: P4-T05  
**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜  
**é¢„è®¡å·¥æ—¶**: 2h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/ZoomControl.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';

interface Props {
  zoom: number;
  minZoom?: number;
  maxZoom?: number;
}

const props = withDefaults(defineProps<Props>(), {
  minZoom: 0.1,
  maxZoom: 5,
});

const emit = defineEmits<{
  'zoom-in': [];
  'zoom-out': [];
  'zoom-to': [value: number];
  'reset': [];
  'fit': [];
}>();

// ç¼©æ”¾ç™¾åˆ†æ¯”
const zoomPercent = computed(() => Math.round(props.zoom * 100));

// é¢„è®¾ç¼©æ”¾å€¼
const zoomPresets = [25, 50, 75, 100, 125, 150, 200, 300];

// æ˜¯å¦å¯ä»¥æ”¾å¤§
const canZoomIn = computed(() => props.zoom < props.maxZoom);

// æ˜¯å¦å¯ä»¥ç¼©å°
const canZoomOut = computed(() => props.zoom > props.minZoom);

// å¤„ç†æ»‘å—å˜åŒ–
function handleSliderChange(e: Event) {
  const value = (e.target as HTMLInputElement).valueAsNumber;
  emit('zoom-to', value / 100);
}

// é€‰æ‹©é¢„è®¾å€¼
function selectPreset(value: number) {
  emit('zoom-to', value / 100);
}
</script>

<template>
  <div class="zoom-control">
    <!-- ç¼©å°æŒ‰é’® -->
    <button
      class="zoom-control__button"
      :disabled="!canZoomOut"
      @click="emit('zoom-out')"
      title="ç¼©å° (Ctrl+-)"
    >
      âˆ’
    </button>

    <!-- ç¼©æ”¾æ»‘å— -->
    <div class="zoom-control__slider-container">
      <input
        type="range"
        class="zoom-control__slider"
        :min="minZoom * 100"
        :max="maxZoom * 100"
        :value="zoomPercent"
        step="5"
        @input="handleSliderChange"
      />
    </div>

    <!-- æ”¾å¤§æŒ‰é’® -->
    <button
      class="zoom-control__button"
      :disabled="!canZoomIn"
      @click="emit('zoom-in')"
      title="æ”¾å¤§ (Ctrl++)"
    >
      +
    </button>

    <!-- ç¼©æ”¾ç™¾åˆ†æ¯”æ˜¾ç¤º -->
    <div class="zoom-control__value">
      <select
        :value="zoomPercent"
        class="zoom-control__select"
        @change="(e) => selectPreset(Number((e.target as HTMLSelectElement).value))"
      >
        <option
          v-for="preset in zoomPresets"
          :key="preset"
          :value="preset"
        >
          {{ preset }}%
        </option>
        <option
          v-if="!zoomPresets.includes(zoomPercent)"
          :value="zoomPercent"
          selected
        >
          {{ zoomPercent }}%
        </option>
      </select>
    </div>

    <!-- é‡ç½®æŒ‰é’® -->
    <button
      class="zoom-control__button zoom-control__button--text"
      @click="emit('reset')"
      title="é‡ç½®è§†å›¾ (Ctrl+0)"
    >
      é‡ç½®
    </button>

    <!-- é€‚åº”å†…å®¹æŒ‰é’® -->
    <button
      class="zoom-control__button zoom-control__button--text"
      @click="emit('fit')"
      title="é€‚åº”å†…å®¹"
    >
      é€‚åº”
    </button>
  </div>
</template>

<style scoped>
.zoom-control {
  position: absolute;
  bottom: 20px;
  right: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background: var(--chips-color-surface);
  border-radius: var(--chips-radius-lg);
  box-shadow: var(--chips-shadow-md);
  z-index: 1000;
}

.zoom-control__button {
  width: 28px;
  height: 28px;
  border: none;
  border-radius: var(--chips-radius-sm);
  background: var(--chips-color-surface-variant);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 500;
  color: var(--chips-color-text-primary);
  transition: background-color 0.2s;
}

.zoom-control__button:hover:not(:disabled) {
  background: var(--chips-color-primary-light);
  color: var(--chips-color-primary);
}

.zoom-control__button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.zoom-control__button--text {
  width: auto;
  padding: 0 12px;
  font-size: 12px;
}

.zoom-control__slider-container {
  width: 100px;
}

.zoom-control__slider {
  width: 100%;
  height: 4px;
  appearance: none;
  background: var(--chips-color-border);
  border-radius: 2px;
  cursor: pointer;
}

.zoom-control__slider::-webkit-slider-thumb {
  appearance: none;
  width: 12px;
  height: 12px;
  background: var(--chips-color-primary);
  border-radius: 50%;
  cursor: pointer;
}

.zoom-control__value {
  min-width: 60px;
}

.zoom-control__select {
  width: 100%;
  padding: 4px 8px;
  border: 1px solid var(--chips-color-border);
  border-radius: var(--chips-radius-sm);
  background: var(--chips-color-surface);
  font-size: 12px;
  cursor: pointer;
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç¼©æ”¾æ»‘å—æ­£å¸¸
- [ ] ç¼©æ”¾æŒ‰é’®æ­£å¸¸
- [ ] é¢„è®¾å€¼é€‰æ‹©æ­£å¸¸
- [ ] é‡ç½®å’Œé€‚åº”åŠŸèƒ½æ­£å¸¸

---

### 2.6 åˆ›å»ºå¸ƒå±€ç´¢å¼•

**ä»»åŠ¡ ID**: P4-T06  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡å·¥æ—¶**: 0.5h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/layouts/infinite-canvas/index.ts`

```typescript
export { default as InfiniteCanvas } from './InfiniteCanvas.vue';
export { default as DesktopLayer } from './DesktopLayer.vue';
export { default as WindowLayer } from './WindowLayer.vue';
export { default as ZoomControl } from './ZoomControl.vue';
export { useCanvasControls } from './use-canvas';
```

2. åˆ›å»º `src/layouts/index.ts`

```typescript
export * from './infinite-canvas';
// export * from './workbench';  // Phase9 å®ç°
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯¼å‡ºç»“æ„æ­£ç¡®

---

### 2.7 é›†æˆåˆ° App.vue

**ä»»åŠ¡ ID**: P4-T07  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 2h

**è¯¦ç»†æ­¥éª¤**:

1. æ›´æ–° `src/App.vue`

```vue
<script setup lang="ts">
import { ref, onMounted, provide, computed } from 'vue';
import { ChipsProvider } from '@chips/components';
import { InfiniteCanvas } from '@/layouts';
import FileManager from '@/components/file-manager/FileManager.vue';
import EditPanel from '@/components/edit-panel/EditPanel.vue';
import CardBoxLibrary from '@/components/card-box-library/CardBoxLibrary.vue';
import { createEditor, ChipsEditor } from '@/core';
import { useEditorStore } from '@/core/state';

// ç¼–è¾‘å™¨å®ä¾‹
let editor: ChipsEditor | null = null;

// çŠ¶æ€
const editorStore = useEditorStore();
const isReady = computed(() => editorStore.isReady);
const currentLayout = computed(() => editorStore.currentLayout);

// åˆå§‹åŒ–ç¼–è¾‘å™¨
onMounted(async () => {
  try {
    editor = createEditor({
      layout: 'infinite-canvas',
      debug: true,
    });
    
    await editor.initialize();
  } catch (error) {
    console.error('Failed to initialize editor:', error);
  }
});

// æä¾›ç¼–è¾‘å™¨å®ä¾‹ç»™å­ç»„ä»¶
provide('editor', {
  get instance() { return editor; },
});
</script>

<template>
  <ChipsProvider>
    <div id="chips-editor">
      <!-- åŠ è½½çŠ¶æ€ -->
      <div v-if="!isReady" class="editor-loading">
        <div class="editor-loading__spinner" />
        <div class="editor-loading__text">æ­£åœ¨åˆå§‹åŒ–ç¼–è¾‘å™¨...</div>
      </div>

      <!-- ç¼–è¾‘å™¨ä¸»ä½“ -->
      <template v-else>
        <!-- æ— é™ç”»å¸ƒå¸ƒå±€ -->
        <InfiniteCanvas v-if="currentLayout === 'infinite-canvas'">
          <template #desktop>
            <!-- æ¡Œé¢å†…å®¹ç”± DesktopLayer ç®¡ç† -->
          </template>

          <template #window>
            <!-- æ–‡ä»¶ç®¡ç†å™¨ -->
            <FileManager />
            <!-- ç¼–è¾‘é¢æ¿ -->
            <EditPanel />
            <!-- å¡ç®±åº“ -->
            <CardBoxLibrary />
          </template>
        </InfiniteCanvas>

        <!-- å·¥ä½œå°å¸ƒå±€ï¼ˆPhase9 å®ç°ï¼‰ -->
        <!-- <Workbench v-else-if="currentLayout === 'workbench'" /> -->
      </template>
    </div>
  </ChipsProvider>
</template>

<style>
/* å…¨å±€æ ·å¼ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  width: 100%;
  height: 100%;
  overflow: hidden;
}

#chips-editor {
  width: 100%;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.editor-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  width: 100%;
  height: 100%;
  background: var(--chips-color-background, #fafafa);
}

.editor-loading__spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--chips-color-border, #e0e0e0);
  border-top-color: var(--chips-color-primary, #3b82f6);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

.editor-loading__text {
  margin-top: 16px;
  color: var(--chips-color-text-secondary, #666);
  font-size: 14px;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] ç¼–è¾‘å™¨æ­£ç¡®åŠ è½½
- [ ] æ— é™ç”»å¸ƒå¸ƒå±€æ˜¾ç¤ºæ­£å¸¸
- [ ] å·¥å…·çª—å£ä½ç½®æ­£ç¡®

---

### 2.8 ç¼–å†™å•å…ƒæµ‹è¯•

**ä»»åŠ¡ ID**: P4-T08  
**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜  
**é¢„è®¡å·¥æ—¶**: 4h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `tests/unit/layouts/use-canvas.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { useCanvasControls } from '@/layouts/infinite-canvas/use-canvas';

describe('useCanvasControls', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('should initialize with default values', () => {
    const { zoom, panX, panY } = useCanvasControls();
    expect(zoom.value).toBe(1);
    expect(panX.value).toBe(0);
    expect(panY.value).toBe(0);
  });

  it('should zoom in', () => {
    const { zoom, zoomIn } = useCanvasControls();
    zoomIn();
    expect(zoom.value).toBeGreaterThan(1);
  });

  it('should zoom out', () => {
    const { zoom, zoomOut } = useCanvasControls();
    zoomOut();
    expect(zoom.value).toBeLessThan(1);
  });

  it('should respect min/max zoom', () => {
    const { zoom, zoomIn, zoomOut } = useCanvasControls({
      minZoom: 0.5,
      maxZoom: 2,
    });

    // ç¼©å°åˆ°æœ€å°å€¼
    for (let i = 0; i < 20; i++) zoomOut();
    expect(zoom.value).toBeGreaterThanOrEqual(0.5);

    // æ”¾å¤§åˆ°æœ€å¤§å€¼
    for (let i = 0; i < 30; i++) zoomIn();
    expect(zoom.value).toBeLessThanOrEqual(2);
  });

  it('should reset view', () => {
    const { zoom, panX, panY, zoomIn, resetView } = useCanvasControls();
    
    zoomIn();
    panX.value = 100;
    panY.value = 200;
    
    resetView();
    
    expect(zoom.value).toBe(1);
    expect(panX.value).toBe(0);
    expect(panY.value).toBe(0);
  });

  it('should convert screen to world coordinates', () => {
    const { zoom, panX, panY, screenToWorld } = useCanvasControls();
    
    zoom.value = 2;
    panX.value = 100;
    panY.value = 50;
    
    const world = screenToWorld(200, 150);
    
    expect(world.x).toBe((200 - 100) / 2);
    expect(world.y).toBe((150 - 50) / 2);
  });

  it('should convert world to screen coordinates', () => {
    const { zoom, panX, panY, worldToScreen } = useCanvasControls();
    
    zoom.value = 2;
    panX.value = 100;
    panY.value = 50;
    
    const screen = worldToScreen(50, 50);
    
    expect(screen.x).toBe(50 * 2 + 100);
    expect(screen.y).toBe(50 * 2 + 50);
  });
});
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### 2.9 æäº¤ä»£ç 

**ä»»åŠ¡ ID**: P4-T09  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 0.5h

**è¯¦ç»†æ­¥éª¤**:
1. è¿è¡Œæ‰€æœ‰æµ‹è¯•
2. è¿è¡Œ lint
3. æäº¤ä»£ç ï¼š`git commit -m "feat(layout): æ— é™ç”»å¸ƒå¸ƒå±€"`

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ä»£ç æ—  lint é”™è¯¯
- [ ] æäº¤å®Œæˆ

---

## 3. å®Œæˆæ ‡å‡†

- [ ] InfiniteCanvas ä¸»ç»„ä»¶å®Œæˆ
- [ ] ç”»å¸ƒæ§åˆ¶ Hook å®Œæˆ
- [ ] æ¡Œé¢å±‚ç»„ä»¶å®Œæˆ
- [ ] çª—å£å±‚ç»„ä»¶å®Œæˆ
- [ ] ç¼©æ”¾æ§åˆ¶å™¨å®Œæˆ
- [ ] é›†æˆåˆ° App.vue
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] ä»£ç æäº¤å®Œæˆ

---

**ä»»åŠ¡åˆ†é…**: å­ä»£ç†-01  
**å¼€å§‹æ—¶é—´**: å¾…å®š  
**å®Œæˆæ—¶é—´**: å¾…å®š
