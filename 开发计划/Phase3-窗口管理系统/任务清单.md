# Phase3 - çª—å£ç®¡ç†ç³»ç»Ÿ

**å‘¨æœŸ**: 1 å‘¨  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**ä¾èµ–**: Phase2  
**çŠ¶æ€**: å¾…å¼€å‘

---

## 1. é˜¶æ®µç›®æ ‡

å®ç°ç¼–è¾‘å™¨çš„çª—å£ç®¡ç†ç³»ç»Ÿï¼š
- å¡ç‰‡çª—å£ç»„ä»¶ï¼ˆCardWindowï¼‰
- å·¥å…·çª—å£ç»„ä»¶ï¼ˆToolWindowï¼‰
- çª—å£èœå•æ ï¼ˆWindowMenuï¼‰
- çª—å£ç®¡ç†å™¨æœåŠ¡
- çª—å£çŠ¶æ€ï¼ˆæ­£å¸¸ã€æœ€å°åŒ–ã€æ”¶èµ·ã€å°é¢ï¼‰

---

## 2. ä»»åŠ¡åˆ—è¡¨

### 2.1 åˆ›å»ºçª—å£åŸºç¡€ç»„ä»¶

**ä»»åŠ¡ ID**: P3-T01  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 3h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/components/window/BaseWindow.vue`

```vue
<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted } from 'vue';
import type { WindowConfig, WindowPosition, WindowSize } from '@/types';

interface Props {
  config: WindowConfig;
  draggable?: boolean;
  resizable?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  draggable: true,
  resizable: true,
});

const emit = defineEmits<{
  'update:position': [position: WindowPosition];
  'update:size': [size: WindowSize];
  'focus': [];
  'close': [];
  'minimize': [];
  'collapse': [];
}>();

// æ‹–æ‹½çŠ¶æ€
const isDragging = ref(false);
const dragStart = ref({ x: 0, y: 0 });
const initialPosition = ref({ x: 0, y: 0 });

// ç¼©æ”¾çŠ¶æ€
const isResizing = ref(false);
const resizeStart = ref({ x: 0, y: 0 });
const initialSize = ref({ width: 0, height: 0 });

// è®¡ç®—æ ·å¼
const windowStyle = computed(() => ({
  transform: `translate(${props.config.position.x}px, ${props.config.position.y}px)`,
  width: `${props.config.size.width}px`,
  height: props.config.state === 'collapsed' ? 'auto' : `${props.config.size.height}px`,
  zIndex: props.config.zIndex,
}));

// çª—å£ç±»å
const windowClass = computed(() => ({
  'base-window': true,
  'base-window--dragging': isDragging.value,
  'base-window--resizing': isResizing.value,
  'base-window--minimized': props.config.state === 'minimized',
  'base-window--collapsed': props.config.state === 'collapsed',
}));

// æ‹–æ‹½å¼€å§‹
function handleDragStart(e: MouseEvent) {
  if (!props.draggable) return;
  
  isDragging.value = true;
  dragStart.value = { x: e.clientX, y: e.clientY };
  initialPosition.value = { ...props.config.position };
  
  document.addEventListener('mousemove', handleDragMove);
  document.addEventListener('mouseup', handleDragEnd);
}

// æ‹–æ‹½ç§»åŠ¨
function handleDragMove(e: MouseEvent) {
  if (!isDragging.value) return;
  
  const deltaX = e.clientX - dragStart.value.x;
  const deltaY = e.clientY - dragStart.value.y;
  
  emit('update:position', {
    x: initialPosition.value.x + deltaX,
    y: initialPosition.value.y + deltaY,
  });
}

// æ‹–æ‹½ç»“æŸ
function handleDragEnd() {
  isDragging.value = false;
  document.removeEventListener('mousemove', handleDragMove);
  document.removeEventListener('mouseup', handleDragEnd);
}

// ç¼©æ”¾å¼€å§‹
function handleResizeStart(e: MouseEvent) {
  if (!props.resizable) return;
  
  e.stopPropagation();
  isResizing.value = true;
  resizeStart.value = { x: e.clientX, y: e.clientY };
  initialSize.value = { ...props.config.size };
  
  document.addEventListener('mousemove', handleResizeMove);
  document.addEventListener('mouseup', handleResizeEnd);
}

// ç¼©æ”¾ç§»åŠ¨
function handleResizeMove(e: MouseEvent) {
  if (!isResizing.value) return;
  
  const deltaX = e.clientX - resizeStart.value.x;
  const deltaY = e.clientY - resizeStart.value.y;
  
  emit('update:size', {
    width: Math.max(200, initialSize.value.width + deltaX),
    height: Math.max(100, initialSize.value.height + deltaY),
  });
}

// ç¼©æ”¾ç»“æŸ
function handleResizeEnd() {
  isResizing.value = false;
  document.removeEventListener('mousemove', handleResizeMove);
  document.removeEventListener('mouseup', handleResizeEnd);
}

// èšç„¦çª—å£
function handleFocus() {
  emit('focus');
}

// æ¸…ç†
onUnmounted(() => {
  document.removeEventListener('mousemove', handleDragMove);
  document.removeEventListener('mouseup', handleDragEnd);
  document.removeEventListener('mousemove', handleResizeMove);
  document.removeEventListener('mouseup', handleResizeEnd);
});
</script>

<template>
  <div
    :class="windowClass"
    :style="windowStyle"
    @mousedown="handleFocus"
  >
    <!-- æ ‡é¢˜æ  -->
    <div
      class="base-window__header"
      @mousedown="handleDragStart"
    >
      <slot name="header">
        <span class="base-window__title">{{ config.title }}</span>
      </slot>
      
      <div class="base-window__actions">
        <slot name="actions">
          <button
            v-if="config.minimizable !== false"
            class="base-window__action base-window__action--minimize"
            @click="emit('minimize')"
          >
            âˆ’
          </button>
          <button
            class="base-window__action base-window__action--collapse"
            @click="emit('collapse')"
          >
            â—¡
          </button>
          <button
            v-if="config.closable !== false"
            class="base-window__action base-window__action--close"
            @click="emit('close')"
          >
            Ã—
          </button>
        </slot>
      </div>
    </div>
    
    <!-- å†…å®¹åŒº -->
    <div
      v-show="config.state !== 'collapsed'"
      class="base-window__content"
    >
      <slot />
    </div>
    
    <!-- ç¼©æ”¾æ‰‹æŸ„ -->
    <div
      v-if="resizable && config.state === 'normal'"
      class="base-window__resize-handle"
      @mousedown="handleResizeStart"
    />
  </div>
</template>

<style scoped>
.base-window {
  position: absolute;
  background: var(--chips-color-surface, #ffffff);
  border-radius: var(--chips-radius-md, 8px);
  box-shadow: var(--chips-shadow-lg);
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.base-window--dragging {
  cursor: grabbing;
  user-select: none;
}

.base-window--minimized {
  display: none;
}

.base-window--collapsed .base-window__content {
  display: none;
}

.base-window__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: var(--chips-color-surface-variant, #f5f5f5);
  cursor: grab;
  user-select: none;
}

.base-window__title {
  font-size: 14px;
  font-weight: 500;
  color: var(--chips-color-text-primary);
}

.base-window__actions {
  display: flex;
  gap: 4px;
}

.base-window__action {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 4px;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  color: var(--chips-color-text-secondary);
}

.base-window__action:hover {
  background: var(--chips-color-surface-hover);
}

.base-window__action--close:hover {
  background: var(--chips-color-error);
  color: white;
}

.base-window__content {
  flex: 1;
  overflow: auto;
}

.base-window__resize-handle {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 16px;
  height: 16px;
  cursor: se-resize;
}

.base-window__resize-handle::after {
  content: '';
  position: absolute;
  bottom: 4px;
  right: 4px;
  width: 8px;
  height: 8px;
  border-right: 2px solid var(--chips-color-border);
  border-bottom: 2px solid var(--chips-color-border);
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] çª—å£å¯æ‹–æ‹½
- [ ] çª—å£å¯ç¼©æ”¾
- [ ] çª—å£çŠ¶æ€åˆ‡æ¢æ­£å¸¸
- [ ] æ ·å¼æ­£ç¡®

---

### 2.2 åˆ›å»ºå¡ç‰‡çª—å£ç»„ä»¶

**ä»»åŠ¡ ID**: P3-T02  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 4h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/components/window/CardWindow.vue`

```vue
<script setup lang="ts">
import { ref, computed, watch, onMounted } from 'vue';
import BaseWindow from './BaseWindow.vue';
import WindowMenu from './WindowMenu.vue';
import { useCardStore, useUIStore } from '@/core/state';
import type { CardWindowConfig } from '@/types';

interface Props {
  config: CardWindowConfig;
}

const props = defineProps<Props>();

const emit = defineEmits<{
  'close': [];
  'focus': [];
  'update:config': [config: Partial<CardWindowConfig>];
}>();

const cardStore = useCardStore();
const uiStore = useUIStore();

// è·å–å¡ç‰‡ä¿¡æ¯
const cardInfo = computed(() => cardStore.openCards.get(props.config.cardId));

// æ˜¯å¦æ­£åœ¨ç¼–è¾‘
const isEditing = computed(() => props.config.isEditing);

// å°é¢æ¯”ä¾‹é€‰é¡¹
const coverRatios = [
  { value: '1:1', label: 'æ­£æ–¹å½¢' },
  { value: '3:4', label: 'æ ‡å‡†ç…§ç‰‡' },
  { value: '9:16', label: 'æ‰‹æœºæ¯”ä¾‹' },
  { value: '16:9', label: 'è§†é¢‘æ¯”ä¾‹' },
];

// çª—å£çŠ¶æ€
const windowState = computed(() => props.config.state);

// åˆ‡æ¢ç¼–è¾‘æ¨¡å¼
function toggleEditMode() {
  emit('update:config', { isEditing: !isEditing.value });
}

// åˆ‡æ¢åˆ°å°é¢æ¨¡å¼
function switchToCover() {
  emit('update:config', { state: 'cover' });
}

// ä»å°é¢æ¢å¤
function restoreFromCover() {
  emit('update:config', { state: 'normal' });
}

// è®¾ç½®å°é¢æ¯”ä¾‹
function setCoverRatio(ratio: string) {
  emit('update:config', { coverRatio: ratio });
}

// æ›´æ–°ä½ç½®
function updatePosition(position: { x: number; y: number }) {
  emit('update:config', { position });
}

// æ›´æ–°å¤§å°
function updateSize(size: { width: number; height: number }) {
  emit('update:config', { size });
}

// å…³é—­çª—å£
function handleClose() {
  emit('close');
}

// æœ€å°åŒ–
function handleMinimize() {
  emit('update:config', { state: 'minimized' });
}

// æ”¶èµ·
function handleCollapse() {
  const newState = windowState.value === 'collapsed' ? 'normal' : 'collapsed';
  emit('update:config', { state: newState });
}
</script>

<template>
  <div v-if="windowState === 'cover'" class="card-cover" @click="restoreFromCover">
    <!-- å°é¢æ¨¡å¼ -->
    <div
      class="card-cover__image"
      :style="{ aspectRatio: config.coverRatio?.replace(':', '/') || '3/4' }"
    >
      <!-- å°é¢å†…å®¹ç”±æ¸²æŸ“å™¨æä¾› -->
      <slot name="cover">
        <div class="card-cover__placeholder">
          {{ cardInfo?.metadata.name }}
        </div>
      </slot>
    </div>
    <div class="card-cover__title">
      {{ cardInfo?.metadata.name }}
    </div>
  </div>

  <BaseWindow
    v-else
    :config="config"
    @update:position="updatePosition"
    @update:size="updateSize"
    @focus="emit('focus')"
    @close="handleClose"
    @minimize="handleMinimize"
    @collapse="handleCollapse"
  >
    <template #header>
      <WindowMenu
        :title="cardInfo?.metadata.name || 'æœªå‘½åå¡ç‰‡'"
        :is-editing="isEditing"
        :show-lock="true"
        @toggle-edit="toggleEditMode"
        @switch-to-cover="switchToCover"
        @settings="() => {}"
      />
    </template>

    <template #default>
      <div class="card-window__content">
        <!-- å¡ç‰‡å†…å®¹ç”±æ¸²æŸ“å™¨æä¾› -->
        <slot>
          <div v-if="cardInfo?.isLoading" class="card-window__loading">
            åŠ è½½ä¸­...
          </div>
          <div v-else class="card-window__body">
            <!-- åŸºç¡€å¡ç‰‡åˆ—è¡¨ -->
            <div
              v-for="baseCard in cardInfo?.structure"
              :key="baseCard.id"
              class="card-window__base-card"
              :class="{ 'card-window__base-card--selected': cardStore.selectedBaseCardId === baseCard.id }"
              @click="cardStore.setSelectedBaseCard(baseCard.id)"
            >
              <div class="card-window__base-card-placeholder">
                {{ baseCard.type }}
              </div>
            </div>
          </div>
        </slot>
      </div>
    </template>
  </BaseWindow>
</template>

<style scoped>
.card-cover {
  position: absolute;
  cursor: pointer;
  transition: transform 0.2s;
}

.card-cover:hover {
  transform: scale(1.02);
}

.card-cover__image {
  width: 200px;
  background: var(--chips-color-surface);
  border-radius: var(--chips-radius-md);
  overflow: hidden;
  box-shadow: var(--chips-shadow-md);
}

.card-cover__placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--chips-color-surface-variant);
  color: var(--chips-color-text-secondary);
}

.card-cover__title {
  margin-top: 8px;
  text-align: center;
  font-size: 12px;
  color: var(--chips-color-text-secondary);
}

.card-window__content {
  padding: 16px;
  min-height: 200px;
}

.card-window__loading {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 200px;
  color: var(--chips-color-text-secondary);
}

.card-window__body {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.card-window__base-card {
  border: 1px solid var(--chips-color-border);
  border-radius: var(--chips-radius-sm);
  overflow: hidden;
  cursor: pointer;
  transition: border-color 0.2s;
}

.card-window__base-card:hover {
  border-color: var(--chips-color-primary);
}

.card-window__base-card--selected {
  border-color: var(--chips-color-primary);
  box-shadow: 0 0 0 2px var(--chips-color-primary-light);
}

.card-window__base-card-placeholder {
  padding: 24px;
  text-align: center;
  color: var(--chips-color-text-secondary);
  background: var(--chips-color-surface-variant);
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¡ç‰‡çª—å£æ˜¾ç¤ºæ­£å¸¸
- [ ] ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- [ ] å°é¢æ¨¡å¼åˆ‡æ¢æ­£å¸¸
- [ ] åŸºç¡€å¡ç‰‡é€‰æ‹©æ­£å¸¸

---

### 2.3 åˆ›å»ºå·¥å…·çª—å£ç»„ä»¶

**ä»»åŠ¡ ID**: P3-T03  
**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜  
**é¢„è®¡å·¥æ—¶**: 2h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/components/window/ToolWindow.vue`

```vue
<script setup lang="ts">
import { computed } from 'vue';
import BaseWindow from './BaseWindow.vue';
import { useUIStore } from '@/core/state';
import type { ToolWindowConfig } from '@/types';

interface Props {
  config: ToolWindowConfig;
}

const props = defineProps<Props>();

const emit = defineEmits<{
  'close': [];
  'focus': [];
  'update:config': [config: Partial<ToolWindowConfig>];
}>();

const uiStore = useUIStore();

// æ˜¯å¦æœ€å°åŒ–
const isMinimized = computed(() => uiStore.minimizedTools.has(props.config.id));

// æ›´æ–°ä½ç½®
function updatePosition(position: { x: number; y: number }) {
  emit('update:config', { position });
}

// æ›´æ–°å¤§å°
function updateSize(size: { width: number; height: number }) {
  emit('update:config', { size });
}

// æœ€å°åŒ–åˆ°ç¨‹åºå
function handleMinimize() {
  uiStore.minimizeTool(props.config.id);
}

// æ”¶èµ·
function handleCollapse() {
  const newState = props.config.state === 'collapsed' ? 'normal' : 'collapsed';
  emit('update:config', { state: newState });
}

// å…³é—­
function handleClose() {
  emit('close');
}
</script>

<template>
  <BaseWindow
    v-if="!isMinimized"
    :config="config"
    @update:position="updatePosition"
    @update:size="updateSize"
    @focus="emit('focus')"
    @close="handleClose"
    @minimize="handleMinimize"
    @collapse="handleCollapse"
  >
    <template #header>
      <div class="tool-window__header">
        <span v-if="config.icon" class="tool-window__icon">
          {{ config.icon }}
        </span>
        <span class="tool-window__title">{{ config.title }}</span>
      </div>
    </template>

    <template #default>
      <div class="tool-window__content">
        <slot />
      </div>
    </template>
  </BaseWindow>
</template>

<style scoped>
.tool-window__header {
  display: flex;
  align-items: center;
  gap: 8px;
}

.tool-window__icon {
  font-size: 16px;
}

.tool-window__title {
  font-size: 14px;
  font-weight: 500;
  color: var(--chips-color-text-primary);
}

.tool-window__content {
  padding: 12px;
  min-height: 100px;
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å·¥å…·çª—å£æ˜¾ç¤ºæ­£å¸¸
- [ ] æœ€å°åŒ–åˆ°ç¨‹åºåæ­£å¸¸
- [ ] æ”¶èµ·/å±•å¼€æ­£å¸¸

---

### 2.4 åˆ›å»ºçª—å£èœå•æ ç»„ä»¶

**ä»»åŠ¡ ID**: P3-T04  
**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜  
**é¢„è®¡å·¥æ—¶**: 2h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/components/window/WindowMenu.vue`

```vue
<script setup lang="ts">
import { ref } from 'vue';

interface Props {
  title: string;
  isEditing?: boolean;
  showLock?: boolean;
  showSettings?: boolean;
}

withDefaults(defineProps<Props>(), {
  isEditing: false,
  showLock: false,
  showSettings: true,
});

const emit = defineEmits<{
  'toggle-edit': [];
  'switch-to-cover': [];
  'settings': [];
  'update:title': [title: string];
}>();

const isEditingTitle = ref(false);
const editingTitle = ref('');

function startEditTitle(currentTitle: string) {
  editingTitle.value = currentTitle;
  isEditingTitle.value = true;
}

function saveTitle() {
  if (editingTitle.value.trim()) {
    emit('update:title', editingTitle.value.trim());
  }
  isEditingTitle.value = false;
}

function cancelEditTitle() {
  isEditingTitle.value = false;
}
</script>

<template>
  <div class="window-menu">
    <div class="window-menu__left">
      <!-- å¡ç‰‡åç§° -->
      <div v-if="!isEditingTitle" class="window-menu__title" @dblclick="startEditTitle(title)">
        {{ title }}
      </div>
      <input
        v-else
        v-model="editingTitle"
        class="window-menu__title-input"
        @blur="saveTitle"
        @keydown.enter="saveTitle"
        @keydown.escape="cancelEditTitle"
        autofocus
      />
    </div>

    <div class="window-menu__right">
      <!-- é”å®š/ç¼–è¾‘æ¨¡å¼åˆ‡æ¢ -->
      <button
        v-if="showLock"
        class="window-menu__button"
        :class="{ 'window-menu__button--active': isEditing }"
        @click="emit('toggle-edit')"
        :title="isEditing ? 'åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼' : 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼'"
      >
        {{ isEditing ? 'ğŸ”“' : 'ğŸ”’' }}
      </button>

      <!-- åˆ‡æ¢åˆ°å°é¢ -->
      <button
        class="window-menu__button"
        @click="emit('switch-to-cover')"
        title="åˆ‡æ¢åˆ°å°é¢"
      >
        ğŸ–¼ï¸
      </button>

      <!-- è®¾ç½® -->
      <button
        v-if="showSettings"
        class="window-menu__button"
        @click="emit('settings')"
        title="è®¾ç½®"
      >
        âš™ï¸
      </button>
    </div>
  </div>
</template>

<style scoped>
.window-menu {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
  padding: 0 4px;
}

.window-menu__left {
  flex: 1;
  min-width: 0;
}

.window-menu__title {
  font-size: 14px;
  font-weight: 500;
  color: var(--chips-color-text-primary);
  cursor: text;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.window-menu__title-input {
  width: 100%;
  font-size: 14px;
  font-weight: 500;
  border: none;
  background: var(--chips-color-surface);
  border-radius: 4px;
  padding: 2px 8px;
  outline: none;
}

.window-menu__title-input:focus {
  box-shadow: 0 0 0 2px var(--chips-color-primary);
}

.window-menu__right {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-left: 12px;
}

.window-menu__button {
  width: 28px;
  height: 28px;
  border: none;
  border-radius: 4px;
  background: transparent;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: background-color 0.2s;
}

.window-menu__button:hover {
  background: var(--chips-color-surface-hover);
}

.window-menu__button--active {
  background: var(--chips-color-primary-light);
  color: var(--chips-color-primary);
}
</style>
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] èœå•æ æ˜¾ç¤ºæ­£å¸¸
- [ ] æ ‡é¢˜ç¼–è¾‘åŠŸèƒ½æ­£å¸¸
- [ ] æŒ‰é’®ç‚¹å‡»äº‹ä»¶æ­£å¸¸

---

### 2.5 åˆ›å»ºçª—å£ç®¡ç†æœåŠ¡

**ä»»åŠ¡ ID**: P3-T05  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 3h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/core/window-manager.ts`

```typescript
import { useUIStore, useCardStore } from '@/core/state';
import type { 
  WindowConfig, 
  CardWindowConfig, 
  ToolWindowConfig,
  WindowPosition,
  WindowSize 
} from '@/types';
import { generateId } from '@/utils';

/**
 * çª—å£ç®¡ç†å™¨
 * è´Ÿè´£åˆ›å»ºã€ç®¡ç†ã€é”€æ¯çª—å£
 */
export class WindowManager {
  private uiStore: ReturnType<typeof useUIStore>;
  private cardStore: ReturnType<typeof useCardStore>;

  constructor() {
    this.uiStore = useUIStore();
    this.cardStore = useCardStore();
  }

  /**
   * åˆ›å»ºå¡ç‰‡çª—å£
   */
  createCardWindow(
    cardId: string,
    options?: Partial<CardWindowConfig>
  ): string {
    const windowId = `card-window-${generateId()}`;
    const position = this.getNextWindowPosition();
    
    const config: CardWindowConfig = {
      id: windowId,
      type: 'card',
      title: this.cardStore.openCards.get(cardId)?.metadata.name || 'å¡ç‰‡',
      cardId,
      position: options?.position ?? position,
      size: options?.size ?? { width: 400, height: 600 },
      state: 'normal',
      zIndex: 0,
      isEditing: false,
      resizable: true,
      draggable: true,
      closable: true,
      minimizable: true,
      ...options,
    };

    this.uiStore.addWindow(config);
    return windowId;
  }

  /**
   * åˆ›å»ºå·¥å…·çª—å£
   */
  createToolWindow(
    component: string,
    options?: Partial<ToolWindowConfig>
  ): string {
    const windowId = `tool-window-${generateId()}`;
    const position = this.getNextWindowPosition();

    const config: ToolWindowConfig = {
      id: windowId,
      type: 'tool',
      title: options?.title || 'å·¥å…·',
      component,
      position: options?.position ?? position,
      size: options?.size ?? { width: 300, height: 400 },
      state: 'normal',
      zIndex: 0,
      icon: options?.icon,
      resizable: true,
      draggable: true,
      closable: true,
      minimizable: true,
      ...options,
    };

    this.uiStore.addWindow(config);
    return windowId;
  }

  /**
   * å…³é—­çª—å£
   */
  closeWindow(windowId: string): void {
    this.uiStore.removeWindow(windowId);
  }

  /**
   * èšç„¦çª—å£
   */
  focusWindow(windowId: string): void {
    this.uiStore.focusWindow(windowId);
  }

  /**
   * ç§»åŠ¨çª—å£
   */
  moveWindow(windowId: string, position: WindowPosition): void {
    this.uiStore.moveWindow(windowId, position.x, position.y);
  }

  /**
   * è°ƒæ•´çª—å£å¤§å°
   */
  resizeWindow(windowId: string, size: WindowSize): void {
    this.uiStore.resizeWindow(windowId, size.width, size.height);
  }

  /**
   * æ›´æ–°çª—å£é…ç½®
   */
  updateWindow(windowId: string, updates: Partial<WindowConfig>): void {
    this.uiStore.updateWindow(windowId, updates);
  }

  /**
   * æœ€å°åŒ–çª—å£
   */
  minimizeWindow(windowId: string): void {
    this.uiStore.setWindowState(windowId, 'minimized');
  }

  /**
   * æ¢å¤çª—å£
   */
  restoreWindow(windowId: string): void {
    this.uiStore.setWindowState(windowId, 'normal');
  }

  /**
   * åˆ‡æ¢çª—å£æŠ˜å çŠ¶æ€
   */
  toggleCollapse(windowId: string): void {
    const window = this.uiStore.windows.get(windowId);
    if (window) {
      const newState = window.state === 'collapsed' ? 'normal' : 'collapsed';
      this.uiStore.setWindowState(windowId, newState);
    }
  }

  /**
   * è·å–çª—å£é…ç½®
   */
  getWindow(windowId: string): WindowConfig | undefined {
    return this.uiStore.windows.get(windowId);
  }

  /**
   * è·å–æ‰€æœ‰çª—å£
   */
  getAllWindows(): WindowConfig[] {
    return this.uiStore.windowList;
  }

  /**
   * è·å–å¡ç‰‡çª—å£
   */
  getCardWindows(): CardWindowConfig[] {
    return this.uiStore.cardWindows;
  }

  /**
   * è·å–å·¥å…·çª—å£
   */
  getToolWindows(): ToolWindowConfig[] {
    return this.uiStore.toolWindows;
  }

  /**
   * è·å–ä¸‹ä¸€ä¸ªçª—å£ä½ç½®ï¼ˆçº§è”æ’åˆ—ï¼‰
   */
  private getNextWindowPosition(): WindowPosition {
    const windows = this.uiStore.windowList;
    const offset = (windows.length % 10) * 30;
    return {
      x: 100 + offset,
      y: 100 + offset,
    };
  }

  /**
   * å¹³é“ºæ‰€æœ‰çª—å£
   */
  tileWindows(): void {
    const windows = this.uiStore.windowList.filter(w => w.state === 'normal');
    const cols = Math.ceil(Math.sqrt(windows.length));
    const windowWidth = 400;
    const windowHeight = 300;
    const gap = 20;

    windows.forEach((window, index) => {
      const row = Math.floor(index / cols);
      const col = index % cols;
      
      this.moveWindow(window.id, {
        x: col * (windowWidth + gap) + 50,
        y: row * (windowHeight + gap) + 50,
      });
      
      this.resizeWindow(window.id, {
        width: windowWidth,
        height: windowHeight,
      });
    });
  }

  /**
   * å…³é—­æ‰€æœ‰çª—å£
   */
  closeAllWindows(): void {
    const windows = [...this.uiStore.windowList];
    windows.forEach(window => {
      this.closeWindow(window.id);
    });
  }
}

// å•ä¾‹
let windowManager: WindowManager | null = null;

/**
 * è·å–çª—å£ç®¡ç†å™¨å®ä¾‹
 */
export function useWindowManager(): WindowManager {
  if (!windowManager) {
    windowManager = new WindowManager();
  }
  return windowManager;
}
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] çª—å£åˆ›å»ºæ­£å¸¸
- [ ] çª—å£å…³é—­æ­£å¸¸
- [ ] çª—å£ç§»åŠ¨/ç¼©æ”¾æ­£å¸¸
- [ ] çª—å£çŠ¶æ€ç®¡ç†æ­£å¸¸

---

### 2.6 åˆ›å»ºçª—å£ç»„ä»¶ç´¢å¼•

**ä»»åŠ¡ ID**: P3-T06  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡å·¥æ—¶**: 0.5h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `src/components/window/index.ts`

```typescript
export { default as BaseWindow } from './BaseWindow.vue';
export { default as CardWindow } from './CardWindow.vue';
export { default as ToolWindow } from './ToolWindow.vue';
export { default as WindowMenu } from './WindowMenu.vue';
```

**éªŒæ”¶æ ‡å‡†**:
- [ ] å¯¼å‡ºç»“æ„æ­£ç¡®

---

### 2.7 ç¼–å†™å•å…ƒæµ‹è¯•

**ä»»åŠ¡ ID**: P3-T07  
**ä¼˜å…ˆçº§**: ğŸŸ¡ é«˜  
**é¢„è®¡å·¥æ—¶**: 3h

**è¯¦ç»†æ­¥éª¤**:

1. åˆ›å»º `tests/unit/core/window-manager.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { setActivePinia, createPinia } from 'pinia';
import { WindowManager, useWindowManager } from '@/core/window-manager';

describe('WindowManager', () => {
  beforeEach(() => {
    setActivePinia(createPinia());
  });

  it('should create card window', () => {
    const manager = useWindowManager();
    const windowId = manager.createCardWindow('card-123', {
      title: 'æµ‹è¯•å¡ç‰‡',
    });
    
    expect(windowId).toMatch(/^card-window-/);
    
    const window = manager.getWindow(windowId);
    expect(window).toBeDefined();
    expect(window?.type).toBe('card');
    expect((window as any).cardId).toBe('card-123');
  });

  it('should create tool window', () => {
    const manager = useWindowManager();
    const windowId = manager.createToolWindow('FileManager', {
      title: 'æ–‡ä»¶ç®¡ç†å™¨',
    });
    
    expect(windowId).toMatch(/^tool-window-/);
    
    const window = manager.getWindow(windowId);
    expect(window).toBeDefined();
    expect(window?.type).toBe('tool');
  });

  it('should close window', () => {
    const manager = useWindowManager();
    const windowId = manager.createToolWindow('Test');
    
    expect(manager.getWindow(windowId)).toBeDefined();
    
    manager.closeWindow(windowId);
    
    expect(manager.getWindow(windowId)).toBeUndefined();
  });

  it('should move window', () => {
    const manager = useWindowManager();
    const windowId = manager.createToolWindow('Test');
    
    manager.moveWindow(windowId, { x: 200, y: 300 });
    
    const window = manager.getWindow(windowId);
    expect(window?.position).toEqual({ x: 200, y: 300 });
  });

  it('should resize window', () => {
    const manager = useWindowManager();
    const windowId = manager.createToolWindow('Test');
    
    manager.resizeWindow(windowId, { width: 500, height: 400 });
    
    const window = manager.getWindow(windowId);
    expect(window?.size).toEqual({ width: 500, height: 400 });
  });

  it('should minimize and restore window', () => {
    const manager = useWindowManager();
    const windowId = manager.createToolWindow('Test');
    
    manager.minimizeWindow(windowId);
    expect(manager.getWindow(windowId)?.state).toBe('minimized');
    
    manager.restoreWindow(windowId);
    expect(manager.getWindow(windowId)?.state).toBe('normal');
  });
});
```

2. åˆ›å»ºç»„ä»¶æµ‹è¯•ï¼ˆä½¿ç”¨ Vue Test Utilsï¼‰

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

### 2.8 æäº¤ä»£ç 

**ä»»åŠ¡ ID**: P3-T08  
**ä¼˜å…ˆçº§**: ğŸ”´ æœ€é«˜  
**é¢„è®¡å·¥æ—¶**: 0.5h

**è¯¦ç»†æ­¥éª¤**:
1. è¿è¡Œæ‰€æœ‰æµ‹è¯•
2. è¿è¡Œ lint
3. æäº¤ä»£ç ï¼š`git commit -m "feat(window): çª—å£ç®¡ç†ç³»ç»Ÿ"`

**éªŒæ”¶æ ‡å‡†**:
- [ ] æµ‹è¯•å…¨éƒ¨é€šè¿‡
- [ ] ä»£ç æ—  lint é”™è¯¯
- [ ] æäº¤å®Œæˆ

---

## 3. å®Œæˆæ ‡å‡†

- [ ] BaseWindow ç»„ä»¶å®Œæˆ
- [ ] CardWindow ç»„ä»¶å®Œæˆ
- [ ] ToolWindow ç»„ä»¶å®Œæˆ
- [ ] WindowMenu ç»„ä»¶å®Œæˆ
- [ ] WindowManager æœåŠ¡å®Œæˆ
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡ >= 80%
- [ ] ä»£ç æäº¤å®Œæˆ

---

**ä»»åŠ¡åˆ†é…**: å­ä»£ç†-01  
**å¼€å§‹æ—¶é—´**: å¾…å®š  
**å®Œæˆæ—¶é—´**: å¾…å®š
