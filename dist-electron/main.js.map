{"version":3,"file":"main.js","sources":["../electron/main.ts"],"sourcesContent":["/**\n * Chips Editor - Electron 主进程\n * @description 薯片卡片编辑器桌面端主进程\n */\n\nimport { app, BrowserWindow, ipcMain, dialog, Menu } from 'electron';\nimport { spawn, ChildProcess } from 'child_process';\nimport path from 'path';\nimport fs from 'fs';\nimport { fileURLToPath } from 'url';\n\n// ES 模块中获取 __dirname\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\n// 内核进程\nlet coreProcess: ChildProcess | null = null;\n\n// 主窗口\nlet mainWindow: BrowserWindow | null = null;\n\n// 开发模式\nconst isDev = process.env.NODE_ENV === 'development' || !app.isPackaged;\n\n/**\n * 创建主窗口\n */\nfunction createWindow(): void {\n  mainWindow = new BrowserWindow({\n    width: 1400,\n    height: 900,\n    minWidth: 1024,\n    minHeight: 768,\n    title: '薯片卡片编辑器',\n    icon: path.join(__dirname, '../public/icon.png'),\n    webPreferences: {\n      preload: path.join(__dirname, 'preload.js'),\n      nodeIntegration: false,\n      contextIsolation: true,\n      sandbox: false,\n    },\n    titleBarStyle: 'hiddenInset',\n    trafficLightPosition: { x: 16, y: 16 },\n    backgroundColor: '#fafafa',\n  });\n\n  // 设置菜单\n  createMenu();\n\n  // 加载页面\n  if (isDev) {\n    // 开发模式：加载 Vite 开发服务器\n    mainWindow.loadURL('http://localhost:3000');\n    mainWindow.webContents.openDevTools();\n  } else {\n    // 生产模式：加载打包后的文件\n    mainWindow.loadFile(path.join(__dirname, '../dist/index.html'));\n  }\n\n  // 窗口关闭时清理\n  mainWindow.on('closed', () => {\n    mainWindow = null;\n  });\n\n  // 窗口准备好后显示\n  mainWindow.once('ready-to-show', () => {\n    mainWindow?.show();\n  });\n}\n\n/**\n * 创建应用菜单\n */\nfunction createMenu(): void {\n  const template: Electron.MenuItemConstructorOptions[] = [\n    {\n      label: '文件',\n      submenu: [\n        { label: '新建卡片', accelerator: 'CmdOrCtrl+N', click: () => sendToRenderer('menu:new-card') },\n        { label: '打开...', accelerator: 'CmdOrCtrl+O', click: () => handleOpen() },\n        { type: 'separator' },\n        { label: '保存', accelerator: 'CmdOrCtrl+S', click: () => sendToRenderer('menu:save') },\n        { label: '另存为...', accelerator: 'CmdOrCtrl+Shift+S', click: () => sendToRenderer('menu:save-as') },\n        { type: 'separator' },\n        { role: 'quit', label: '退出' },\n      ],\n    },\n    {\n      label: '编辑',\n      submenu: [\n        { label: '撤销', accelerator: 'CmdOrCtrl+Z', click: () => sendToRenderer('menu:undo') },\n        { label: '重做', accelerator: 'CmdOrCtrl+Shift+Z', click: () => sendToRenderer('menu:redo') },\n        { type: 'separator' },\n        { role: 'cut', label: '剪切' },\n        { role: 'copy', label: '复制' },\n        { role: 'paste', label: '粘贴' },\n        { role: 'delete', label: '删除' },\n        { type: 'separator' },\n        { role: 'selectAll', label: '全选' },\n      ],\n    },\n    {\n      label: '视图',\n      submenu: [\n        { label: '无限画布', click: () => sendToRenderer('menu:layout-canvas') },\n        { label: '工作台', click: () => sendToRenderer('menu:layout-workbench') },\n        { type: 'separator' },\n        { label: '显示网格', type: 'checkbox', checked: true, click: (item) => sendToRenderer('menu:toggle-grid', item.checked) },\n        { type: 'separator' },\n        { label: '放大', accelerator: 'CmdOrCtrl+Plus', click: () => sendToRenderer('menu:zoom-in') },\n        { label: '缩小', accelerator: 'CmdOrCtrl+-', click: () => sendToRenderer('menu:zoom-out') },\n        { label: '重置缩放', accelerator: 'CmdOrCtrl+0', click: () => sendToRenderer('menu:zoom-reset') },\n        { type: 'separator' },\n        { role: 'toggleDevTools', label: '开发者工具' },\n        { role: 'reload', label: '重新加载' },\n      ],\n    },\n    {\n      label: '窗口',\n      submenu: [\n        { role: 'minimize', label: '最小化' },\n        { role: 'zoom', label: '缩放' },\n        { type: 'separator' },\n        { role: 'front', label: '前置所有窗口' },\n      ],\n    },\n    {\n      label: '帮助',\n      submenu: [\n        { label: '关于薯片编辑器', click: () => showAbout() },\n        { label: '文档', click: () => require('electron').shell.openExternal('https://chips.dev/docs') },\n      ],\n    },\n  ];\n\n  // macOS 特殊处理\n  if (process.platform === 'darwin') {\n    template.unshift({\n      label: app.name,\n      submenu: [\n        { role: 'about', label: '关于薯片编辑器' },\n        { type: 'separator' },\n        { role: 'services', label: '服务' },\n        { type: 'separator' },\n        { role: 'hide', label: '隐藏' },\n        { role: 'hideOthers', label: '隐藏其他' },\n        { role: 'unhide', label: '显示全部' },\n        { type: 'separator' },\n        { role: 'quit', label: '退出' },\n      ],\n    });\n  }\n\n  const menu = Menu.buildFromTemplate(template);\n  Menu.setApplicationMenu(menu);\n}\n\n/**\n * 发送消息到渲染进程\n */\nfunction sendToRenderer(channel: string, ...args: unknown[]): void {\n  mainWindow?.webContents.send(channel, ...args);\n}\n\n/**\n * 处理打开文件\n */\nasync function handleOpen(): Promise<void> {\n  const result = await dialog.showOpenDialog(mainWindow!, {\n    filters: [\n      { name: '薯片卡片', extensions: ['card'] },\n      { name: '薯片箱子', extensions: ['box'] },\n      { name: '所有文件', extensions: ['*'] },\n    ],\n    properties: ['openFile', 'multiSelections'],\n  });\n\n  if (!result.canceled && result.filePaths.length > 0) {\n    sendToRenderer('menu:open', result.filePaths);\n  }\n}\n\n/**\n * 显示关于对话框\n */\nfunction showAbout(): void {\n  dialog.showMessageBox(mainWindow!, {\n    type: 'info',\n    title: '关于薯片卡片编辑器',\n    message: '薯片卡片编辑器',\n    detail: `版本: 1.0.0\\n薯片生态的核心应用\\n\\n© 2026 Chips Ecosystem`,\n  });\n}\n\n/**\n * 启动内核进程\n */\nfunction startCoreProcess(): void {\n  const corePath = isDev\n    ? path.join(__dirname, '../../Chips-core/target/debug/chips-core')\n    : path.join(process.resourcesPath, 'chips-core');\n\n  if (!fs.existsSync(corePath)) {\n    console.warn('内核文件不存在:', corePath);\n    return;\n  }\n\n  console.log('启动内核进程:', corePath);\n  \n  coreProcess = spawn(corePath, ['start', '--dev'], {\n    stdio: ['pipe', 'pipe', 'pipe'],\n  });\n\n  coreProcess.stdout?.on('data', (data) => {\n    console.log('[Core]', data.toString());\n  });\n\n  coreProcess.stderr?.on('data', (data) => {\n    console.error('[Core Error]', data.toString());\n  });\n\n  coreProcess.on('close', (code) => {\n    console.log('内核进程退出:', code);\n    coreProcess = null;\n  });\n}\n\n/**\n * 停止内核进程\n */\nfunction stopCoreProcess(): void {\n  if (coreProcess) {\n    coreProcess.kill();\n    coreProcess = null;\n  }\n}\n\n// IPC 处理\nipcMain.handle('dialog:open', async () => {\n  return dialog.showOpenDialog(mainWindow!, {\n    filters: [\n      { name: '薯片卡片', extensions: ['card'] },\n      { name: '薯片箱子', extensions: ['box'] },\n    ],\n    properties: ['openFile'],\n  });\n});\n\nipcMain.handle('dialog:save', async (_event, defaultPath?: string) => {\n  return dialog.showSaveDialog(mainWindow!, {\n    defaultPath,\n    filters: [\n      { name: '薯片卡片', extensions: ['card'] },\n    ],\n  });\n});\n\nipcMain.handle('app:get-version', () => {\n  return app.getVersion();\n});\n\nipcMain.handle('app:get-path', (_event, name: string) => {\n  return app.getPath(name as any);\n});\n\n// 应用生命周期\napp.whenReady().then(() => {\n  // 启动内核\n  startCoreProcess();\n  \n  // 创建窗口\n  createWindow();\n\n  // macOS: 点击 Dock 图标时重新创建窗口\n  app.on('activate', () => {\n    if (BrowserWindow.getAllWindows().length === 0) {\n      createWindow();\n    }\n  });\n});\n\n// 所有窗口关闭时\napp.on('window-all-closed', () => {\n  // macOS 通常不退出应用\n  if (process.platform !== 'darwin') {\n    app.quit();\n  }\n});\n\n// 应用退出前\napp.on('before-quit', () => {\n  stopCoreProcess();\n});\n\n// 防止多实例\nconst gotTheLock = app.requestSingleInstanceLock();\nif (!gotTheLock) {\n  app.quit();\n} else {\n  app.on('second-instance', () => {\n    if (mainWindow) {\n      if (mainWindow.isMinimized()) mainWindow.restore();\n      mainWindow.focus();\n    }\n  });\n}\n"],"names":["__filename","__dirname"],"mappings":"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"}